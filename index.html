<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>小章鱼(Chien版)</title>
    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="https://i.postimg.cc/BQ2HxQtJ/Chien.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/BQ2HxQtJ/Chien.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css?v=1.0.3">
    <link rel="icon" type="image/png" sizes="32x32" href="https://i.postimg.cc/BQ2HxQtJ/Chien.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://i.postimg.cc/BQ2HxQtJ/Chien.png">
    <link rel="shortcut icon" href="https://i.postimg.cc/BQ2HxQtJ/Chien.png">
</head>

<body>
<svg width="0" height="0" style="position:absolute;">
  <defs>
    <clipPath id="heart-clip" clipPathUnits="objectBoundingBox">
      <path d="M0.5,1 C0.1,0.8,0,0.45,0.5,0.2 C1,0.45,0.9,0.8,0.5,1 Z" />
    </clipPath>
  </defs>
  
  <symbol id="wallet-icon" viewBox="0 0 24 24">
    <path d="M21 7.28V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2.28c.59-.3 1-0.92 1-1.62v-6.2c0-.7-.41-1.32-1-1.62zM19 19H5V5h14v2h-6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6v2zm-4-4h-2v-2h2v2zm4-4v6h-8v-6h8z"></path>
  </symbol>
</svg>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn" title="群聊">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>
                <button class="action-btn" id="import-character-card-btn" title="导入">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                </button>
                <button class="action-btn" id="add-chat-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div>
                    <span id="chat-room-status-text">在线</span>
                </div>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png"
                                                                       alt="设置"></button>
            </div>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
            <div id="sticker-bar">
                <button class="sticker-bar-btn" id="regenerate-btn" title="重回">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65,6.35C16.2,4.9,14.21,4,12,4A8,8,0,0,0,4,12A8,8,0,0,0,12,20C15.73,20,18.84,17.45,19.73,14H17.65C16.83,16.33,14.61,18,12,18A6,6,0,0,1,6,12A6,6,0,0,1,12,6C13.66,6,15.14,6.69,16.22,7.78L13,11H20V4L17.65,6.35Z" />
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="sticker-toggle-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="photo-video-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="image-recognition-btn" title="图片">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5H3v14h18M5 7h14v10H5V7m3.5 1.5A1.5 1.5 0 1 1 7 10a1.5 1.5 0 0 1 1.5-1.5M19 17l-4.5-5.5L11 16l-2-2.5L5 17"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="voice-message-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="wallet-btn" title="转账">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4M20 18H4V8H20V18M16 12.5A1.5 1.5 0 1 0 16 15.5A1.5 1.5 0 0 0 16 12.5Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="gift-btn" title="礼物">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.16 14h8.53a2 2 0 0 0 1.93-1.5L19 6H6.21L5.27 4H2v2h2l3.6 7.59L6.25 17H19v-2H7.65l-.49-1z"/>
                        <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                    </svg>
                </button>
                <!-- NEW: Time Skip Button -->
                <button class="sticker-bar-btn" id="time-skip-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="placeholder-plus-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </button>
            </div>
            <div id="reply-preview-bar">
                <div class="reply-preview-content">
                    <span class="reply-preview-name"></span>
                    <p class="reply-preview-text"></p>
                </div>
                <button id="cancel-reply-btn">×</button>
            </div>
            <div class="message-input-area" id="message-input-default">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button id="send-message-btn" class="icon-btn send-btn">➤</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="music-screen" class="screen"></div>

        
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <div id="sticker-modal">
            <div class="header">
                <div class="header-left">
                    <span class="title">我的表情</span>
                </div>
                <div class="header-right">
                    <button class="panel-btn" id="sticker-category-manage-btn">分类</button>
                    <button class="panel-btn" id="manage-stickers-btn">管理</button>
                    <button class="panel-btn" id="batch-add-sticker-btn">批量</button>
                    <button class="panel-btn" id="add-new-sticker-btn">上传</button>
                </div>
            </div>
            <div id="sticker-category-tabs"></div>
            <div id="sticker-search-container">
                <input type="search" id="sticker-search-input" placeholder="搜索表情名称...">
            </div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
            <div id="sticker-manage-bar">
                <label>
                    <input type="checkbox" id="sticker-select-all-checkbox">
                    全选
                </label>
                <button class="btn btn-danger" id="delete-selected-stickers-btn">删除 (0)</button>
            </div>
        </div>
        <!-- NEW: Chat Expansion Panel -->
        <div id="chat-expansion-panel">
            <div class="sticker-grid" id="chat-expansion-grid">
                <!-- Items will be populated by JS -->
            </div>
        </div>
    </div>
  
    <div id="world-book-screen" class="screen">
        <header class="app-header" id="world-book-header-normal">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="add-world-book-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
                <button class="action-btn" id="world-book-more-btn" title="更多">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <circle cx="6" cy="12" r="1.5" fill="currentColor"/>
                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                        <circle cx="18" cy="12" r="1.5" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </header>
        <header class="app-header" id="world-book-header-select" style="display: none;">
            <button class="action-btn" id="world-book-cancel-select-btn" style="font-size: 16px; font-weight: 500; color: var(--primary-color); width: auto;">取消</button>
            <div class="title-container">
                <h1 class="title" id="world-book-select-title">世界书</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的"+"创造第一个设定吧！</p>
            </div>
            <div id="world-book-actionsheet" class="action-sheet-overlay">
                <div class="action-sheet">
                    <button class="action-sheet-button icon-button" id="world-book-import-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <span>导入</span>
                    </button>
                    <button class="action-sheet-button icon-button" id="world-book-export-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>导出</span>
                    </button>
                    <button class="action-sheet-button icon-button" id="world-book-select-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9 12l2 2 4-4"></path></svg>
                        <span>选择</span>
                    </button>
                </div>
            </div>

                  </main>
        <div id="world-book-multi-select-bar" style="display: none;">
            <button class="action-btn" id="world-book-select-all-btn">全选</button>
            <button class="action-btn" id="world-book-delete-selected-btn">删除 (0)</button>
        </div>
      </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-category">条目分类</label>
                    <input type="text" id="world-book-category" placeholder="例如：人物、地点、组织（可选）">
                </div>
                <div id="world-book-entries-container" class="form-group" style="display: flex; flex-direction: column; gap: 15px;">
                </div>
                <button type="button" id="add-world-book-entry-btn" class="btn btn-secondary" style="margin-bottom: 20px;">添加子条目</button>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="radio-button-group">
                        <input type="radio" id="world-book-position-before" name="world-book-position" value="before" checked>
                        <label for="world-book-position-before">人设前</label>

                        <div class="radio-divider"></div>

                        <input type="radio" id="world-book-position-after" name="world-book-position" value="after">
                        <label for="world-book-position-after">人设后</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast">
        <img class="toast-avatar" src="" alt="avatar">
        <div class="toast-content">
            <div class="toast-name"></div>
            <div class="toast-message"></div>
        </div>
    </div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <!-- Message Edit Modal -->
    <div id="message-edit-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>编辑消息</h3>
            <form id="message-edit-form">
                <div class="form-group">
                    <textarea id="message-edit-textarea" rows="6" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" id="cancel-edit-modal-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">添加新表情</h3>
            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <div class="form-group">
                    <label for="sticker-category-select">选择分类</label>
                    <select id="sticker-category-select" class="form-group"></select>
                </div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <div class="or-divider">或</div><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <!-- Batch Add Sticker Modal -->
    <div id="batch-add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>批量导入表情</h3>
            <form id="batch-add-sticker-form">
                <div class="form-group">
                    <label for="sticker-urls-textarea">数据格式：名称:URL (英文冒号，每行一个)</label>
                    <textarea id="sticker-urls-textarea" rows="8" placeholder="例如：&#10;开心:https://example.com/happy.gif&#10;哭泣:https://example.com/cry.png"></textarea>
                </div>
                <div class="form-group">
                    <label for="batch-sticker-category-select">选择分类</label>
                    <select id="batch-sticker-category-select" class="form-group"></select>
                </div>
                <button type="submit" class="btn btn-primary">开始导入</button>
            </form>
        </div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                                                 class="avatar-preview"><input type="file"
                                                                               id="setting-char-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-char-avatar-upload" class="btn btn-primary"
                        style="flex-grow:1;">更换角色头像</label></div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
               <div class="form-group">
                    <label for="mypersona-preset-select">面具管理</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <select id="mypersona-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select>
                        <button type="button" id="mypersona-save-btn" class="btn btn-secondary" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">另存</button>
                        <button type="button" id="mypersona-manage-btn" class="btn btn-neutral" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">管理</button>
                    </div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
               <div class="form-group">
                    <label for="bubble-preset-select">气泡预设管理</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <select id="bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select>
                        <button type="button" id="save-preset-btn" class="btn btn-secondary" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">另存</button>
                        <button type="button" id="manage-presets-btn" class="btn btn-neutral" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">管理</button>
                    </div>
                </div>
                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <div class="form-group" id="nai-module-handbook-group">
                    <hr style="opacity: 0.2; margin: 20px 0;">
                    <label style="font-weight: 600; color: var(--accent-color);">NAI 模块手册</label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        管理并选择当前角色在AI主动生图时可参考的提示词模块（"模块手册"）。
                    </p>
                    <button type="button" id="open-nai-module-manager-btn" class="btn btn-secondary" style="width: 100%; margin-top: 15px;">管理并挂载模块</button> 
                </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Global Pomodoro World Book Selection Modal -->
    <div id="global-pomodoro-world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>为全局专注设置关联世界书</h3>
            <ul id="global-pomodoro-world-book-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
                <!-- World book items will be rendered here -->
            </ul>
            <button class="btn btn-primary" id="save-global-pomodoro-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary"
                           style="flex-grow:1;">更换群头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"
                           style="flex-grow:1;">更换我的头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
                <div class="form-group">
                    <label for="group-bubble-preset-select">气泡预设管理</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <select id="group-bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select>
                        <button type="button" id="group-save-preset-btn" class="btn btn-secondary" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">另存</button>
                        <button type="button" id="group-manage-presets-btn" class="btn btn-neutral" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">管理</button>
                    </div>
                </div>
                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <div class="form-group" id="group-nai-module-handbook-group">
                    <hr style="opacity: 0.2; margin: 20px 0;">
                    <label style="font-weight: 600; color: var(--accent-color);">NAI 模块手册</label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        管理并选择当前群聊在AI主动生图时可参考的提示词模块（"模块手册"）。
                    </p>
                    <button type="button" id="open-group-nai-module-manager-btn" class="btn btn-secondary" style="width: 100%; margin-top: 15px;">管理并挂载模块</button> 
                </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"
                         style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
    <!-- Memory Journal Screen -->
    <div id="memory-journal-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">回忆日记</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="bind-journal-worldbook-btn" title="绑定世界书">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                    </svg>
                </button>
                <button class="action-btn" id="generate-new-journal-btn" title="生成新日记">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                </button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="journal-list-container">
                <!-- Journal cards will be rendered here -->
            </ul>
            <div class="placeholder-text" id="no-journals-placeholder" style="display: none;">
                <p>还没有日记哦~</p>
                <p>点击右上角的“+号”来创建第一篇吧！</p>
            </div>
        </main>
    </div>

    <!-- Memory Journal Detail Screen -->
    <div id="memory-journal-detail-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="memory-journal-screen">‹</button>
            <div class="title-container">
                <h1 class="title">日记详情</h1>
            </div>
            <button class="action-btn" id="edit-journal-detail-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
            </button>
        </header>
        <main class="content" style="padding: 20px;">
            <h2 id="journal-detail-title" style="margin-top: 0; font-size: 22px; font-family: 'Georgia', 'Times New Roman', serif;"></h2>
            <p id="journal-detail-meta" style="font-size: 12px; color: #aaa; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; font-family: initial;"></p>
            <div id="journal-detail-content" style="line-height: 1.7; white-space: pre-wrap; font-size: 16px; font-family: 'Georgia', 'Times New Roman', serif;"></div>
        </main>
    </div>

    <div id="peek-character-select-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">选择查看对象</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <ul class="list-container" id="peek-select-list-container">
                </ul>
            <div class="placeholder-text" id="no-peek-characters-placeholder" style="display: none;">
                <p>还没有可以查看的角色...</p>
                <p>请先创建一个私聊角色吧！</p>
            </div>
        </main>
    </div>

    <!-- Peek Steps App Screen -->
    <div id="peek-steps-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">步数</h1>
            </div>
            <div class="placeholder"></div> <!-- To balance the header -->
        </header>
        <main class="content">
            <div class="steps-header">
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="Char Avatar" class="steps-header-avatar" id="steps-char-avatar">
                <span class="steps-header-name" id="steps-char-name">Char</span>
            </div>

            <div class="steps-progress-container">
                <div class="steps-progress-circle" id="steps-progress-ring"></div>
                <div class="steps-progress-inner">
                    <div class="steps-count" id="steps-current-count">4321</div>
                    <div class="steps-label">/ 6000 步</div>
                </div>
            </div>

            <div class="steps-module">
                <h3 class="steps-module-title">最近活动轨迹</h3>
                <ul class="activity-track-list" id="activity-track-list">
                    <li class="activity-track-item">10:00 AM - 咖啡馆</li>
                    <li class="activity-track-item">01:30 PM - 市中心图书馆</li>
                    <li class="activity-track-item">06:00 PM - 河边公园</li>
                    <li class="activity-track-item">07:00 PM - 健身房</li>
                    <li class="activity-track-item">08:30 PM - 超市</li>
                    <li class="activity-track-item">09:00 PM - 回家</li>
                </ul>
            </div>
            <div class="steps-annotation" id="steps-annotation-content">
                “今天走了不少路，但感觉很充实。特别是下午在图书馆找到的那本书，感觉能看很久。”
            </div>
        </main>
    </div>

    <div id="peek-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的手机</h1>
            </div>
            <button class="action-btn" id="peek-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
        </header>
        <main class="content" style="padding: 50px 0; justify-content: flex-start; align-items: center;">
            <!-- Content rendered by renderPeekScreen() -->
        </main>
    </div>

   <div id="forum-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">←</button>
        <div class="title-container">
            <h1 class="title">论坛</h1>
        </div>

        <div class="action-btn-group"></div>
    </header>
    <main class="content" style="padding: 15px;">

        <div class="forum-search-bar">
            <button class="action-btn" id="forum-link-btn" title="绑定">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                </svg>
            </button>
            <input type="text" id="forum-search-input" placeholder="搜索关键词">
            <button class="action-btn" id="forum-refresh-btn" title="刷新">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </div>

        <div id="forum-posts-container">
            <p class="placeholder-text" style="margin-top: 50px;">点击右上角刷新按钮来生成帖子...</p>
        </div>
    </main>
</div>



<div id="forum-post-detail-screen" class="screen">

</div>


<div id="storage-analysis-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">存储分析</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content" style="flex-direction: column; justify-content: flex-start; padding: 20px; gap: 20px;">
        <div id="storage-chart-container" style="width: 100%; height: 300px; flex-shrink: 0;"></div>
        <div id="storage-total-size-container" style="text-align: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;">
            <span style="font-size: 14px; color: #888;">总占用空间</span>
            <h2 id="storage-total-size" style="margin: 4px 0 0 0; font-size: 24px; color: #333; font-weight: 600;">---</h2>
        </div>
        <div id="storage-details-list" style="width: 100%; overflow-y: auto;"></div>
    </main>
</div>


<div id="peek-messages-screen" class="screen">

        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的消息</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <ul class="list-container" id="peek-chat-list-container">
                <!-- Simulated chat list will be rendered here -->
            </ul>
        </main>
    </div>

    <!-- Peek Conversation Screen -->
    <div id="peek-conversation-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-messages-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="peek-conversation-title">...</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <div class="message-area" id="peek-message-area">
                <!-- Simulated messages will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Peek Memos Screen -->
    <div id="peek-memos-screen" class="screen"></div>

    <!-- Peek Memo Detail Screen -->
    <div id="peek-memo-detail-screen" class="screen"></div>

    <!-- Peek Cart Screen -->
    <div id="peek-cart-screen" class="screen"></div>

    <!-- Peek Transfer Station Screen -->
    <div id="peek-transfer-station-screen" class="screen"></div>

    <!-- Peek Browser Screen -->
    <div id="peek-browser-screen" class="screen"></div>

    <!-- Peek Drafts Screen -->
    <div id="peek-drafts-screen" class="screen"></div>

    <div id="peek-album-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container"><h1 class="title">相册</h1></div>
            <button class="action-btn" id="refresh-album-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
        </header>
        <main class="content">
            <div class="album-grid">
                <p class="placeholder-text">正在生成相册内容...</p>
            </div>
        </main>
    </div>
 
    <!-- Peek Unlock Screen (Social Media) -->
    <div id="peek-unlock-screen" class="screen">
        <!-- Content will be dynamically rendered by renderPeekUnlock() -->
    </div>
 
    <div id="peek-confirm-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>要偷看ta的手机吗？</h3>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="peek-confirm-yes" class="btn btn-primary" style="flex: 1;">是</button>
                <button id="peek-confirm-no" class="btn btn-neutral" style="flex: 1;">否</button>
            </div>
        </div>
    </div>
    <!-- New Peek Wallpaper Modal -->
    <div id="peek-wallpaper-modal" class="modal-overlay">
        <div class="modal-window" style="max-height: 80vh; overflow-y: auto;">
            <h3>“偷看”页面自定义</h3>
            <div class="collapsible-section open">
                <div class="collapsible-header">
                    <h4>页面壁纸</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <form id="peek-wallpaper-form">
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label for="peek-wallpaper-url-input">壁纸URL</label>
                            <input type="url" id="peek-wallpaper-url-input" class="form-group" placeholder="粘贴图片URL">
                        </div>
                        <div class="or-divider" style="margin: 8px 0;">或</div>
                        <input type="file" id="peek-wallpaper-upload" accept="image/*" style="display: none;">
                        <label for="peek-wallpaper-upload" class="btn btn-secondary">从本地上传</label>
                    </form>
                </div>
            </div>
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content" id="peek-app-icons-settings">
                    <!-- App icon settings will be rendered here by JS -->
                </div>
            </div>
             <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>微博(Unlock)小号</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="peek-unlock-avatar-url">头像URL</label>
                        <input type="url" id="peek-unlock-avatar-url" class="form-group" placeholder="粘贴图片URL">
                    </div>
                </div>
            </div>
            <button id="save-peek-settings-btn" class="btn btn-primary" style="margin-top: 20px;">保存所有更改</button>
        </div>
    </div>
<div id="pomodoro-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注任务</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-settings-btn" title="设置">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
            <button class="action-btn" id="pomodoro-create-task-btn" title="创建任务">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>
    </header>
    <main class="content">
        <div class="task-list-container" id="pomodoro-task-list">
            <!-- Task cards will be rendered here by JS -->
        </div>
        <p class="placeholder-text" id="pomodoro-no-tasks-placeholder">还没有专注任务，点击右上角“+”创建一个吧。</p>
    </main>
</div>
<!-- Pomodoro Focus Screen -->
<div id="pomodoro-focus-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="pomodoro-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注中</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-focus-settings-btn" title="设置">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
        </div>
    </header>
    <main class="content">
        <div class="focus-timer-container">
            <h2 class="focus-task-title">阅读一章《JavaScript高级程序设计》</h2>
            <div class="focus-timer-display">24:32</div>
            <div class="focus-timer-mode">倒计时</div>
            <div class="focus-total-time" id="pomodoro-total-focused-time">已专注 0 分钟</div>
        </div>

        <div class="focus-footer">
            <div class="focus-message-bubble">
                <p>保持专注，你做得很好！</p>
            </div>
            <div class="focus-bottom-controls">
                <div class="focus-controls-group">
                    <button class="control-btn" id="pomodoro-start-btn" title="开始">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button class="control-btn" id="pomodoro-pause-btn" title="暂停" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" class="focus-avatar" alt="avatar">
                <button class="control-btn" id="pomodoro-giveup-btn" title="放弃">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Pomodoro Settings Sidebar -->
<div id="pomodoro-settings-sidebar" class="settings-sidebar">
    <div class="header">专注设置</div>
    <div class="content">
        <form id="pomodoro-settings-form">
            <div class="form-group">
                <label for="pomodoro-char-select">绑定陪伴角色</label>
                <select id="pomodoro-char-select" class="form-group"></select>
            </div>
            <div class="form-group">
                <label for="pomodoro-user-persona-select">选择你的设定</label>
                <select id="pomodoro-user-persona-select" class="form-group"></select>
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-encouragement-minutes">鼓励机制 (分钟)</label>
                <input type="number" id="pomodoro-encouragement-minutes" class="form-group" placeholder="专注多少分钟后收到鼓励" min="1">
            </div>
            <div class="form-group">
                <label for="pomodoro-poke-limit">“戳一戳”次数上限</label>
                <input type="number" id="pomodoro-poke-limit" class="form-group" placeholder="每次专注允许戳几次" min="0">
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-focus-bg-url">专注界面背景 URL</label>
                <input type="url" id="pomodoro-focus-bg-url" class="form-group" placeholder="粘贴图片URL">
            </div>
            <div class="form-group">
                <label for="pomodoro-focus-bg-upload" class="btn btn-secondary">或从本地上传</label>
                <input type="file" id="pomodoro-focus-bg-upload" accept="image/*" style="display:none;">
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-task-card-bg-url">任务卡片背景 URL</label>
                <input type="url" id="pomodoro-task-card-bg-url" class="form-group" placeholder="粘贴图片URL">
            </div>
            <div class="form-group">
                <label for="pomodoro-task-card-bg-upload" class="btn btn-secondary">或从本地上传</label>
                <input type="file" id="pomodoro-task-card-bg-upload" accept="image/*" style="display:none;">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">保存设置</button>
        </form>
    </div>
</div>

<!-- Pomodoro Global Settings Sidebar -->
<div id="pomodoro-global-settings-sidebar" class="settings-sidebar">
    <div class="header">全局专注设置</div>
    <div class="content">
        <form id="pomodoro-global-settings-form">
            <div class="form-group">
                <button type="button" class="btn btn-secondary" id="link-global-pomodoro-world-book-btn">关联世界书</button>
            </div>
            <p style="font-size: 12px; color: #888; margin-top: 15px;">
                这里关联的世界书将作为全局上下文，作用于所有番茄钟任务的AI互动。
            </p>
        </form>
    </div>
</div>

<!-- Pomodoro Certificate Modal -->
<div id="pomodoro-certificate-modal" class="modal-overlay">
    <div class="modal-window" style="text-align: center;">
        <h3>专注完成！</h3>
        <div id="pomodoro-certificate-content" style="border: 2px dashed var(--primary-color); padding: 20px; margin: 15px 0; border-radius: 10px; background: #fff8fa;">
            <p><strong>任务名称:</strong> <span id="cert-task-name"></span></p>
            <p><strong>专注时长:</strong> <span id="cert-duration"></span></p>
            <p><strong>“戳一戳”次数:</strong> <span id="cert-poke-count"></span></p>
        </div>
        <p>做的很棒！要不要把这次的专注成果分享一下？</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="forward-certificate-btn" class="btn btn-primary" style="flex: 1;">转发到聊天框</button>
            <button id="close-certificate-btn" class="btn btn-neutral" style="flex: 1;">关闭</button>
        </div>
    </div>
</div>

<!-- Pomodoro Record Detail Modal -->

<!-- Pomodoro Create Task Modal -->
<div id="pomodoro-create-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建专注任务</h3>
        <form id="pomodoro-create-form">
            <div class="form-group">
                <label for="pomodoro-task-name">任务名称</label>
                <input type="text" id="pomodoro-task-name" class="form-group" placeholder="例如：阅读一章《JavaScript高级程序设计》" required>
            </div>
            <div class="form-group">
                <label>计时模式</label>
                <div class="radio-group-pills">
                    <input type="radio" id="mode-countdown" name="pomodoro-mode" value="countdown" checked>
                    <label for="mode-countdown">倒计时</label>
                    <input type="radio" id="mode-stopwatch" name="pomodoro-mode" value="stopwatch">
                    <label for="mode-stopwatch">正计时</label>
                </div>
            </div>
            <div id="pomodoro-duration-options" class="visible">
                <button type="button" class="duration-pill active" data-duration="30">30分钟</button>
                <button type="button" class="duration-pill" data-duration="45">45分钟</button>
                <button type="button" class="duration-pill" data-duration="60">60分钟</button>
                <button type="button" class="duration-pill" data-duration="custom">自定义</button>
                <input type="number" id="pomodoro-custom-duration-input" class="form-group" placeholder="输入分钟数">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">创建任务</button>
        </form>
    </div>
</div>
    <div id="peek-photo-modal" class="modal-overlay">
        <div class="modal-window">
            <div id="peek-photo-image-container">
                <span class="placeholder-icon">🖼️</span>
            </div>
            <div id="peek-photo-description"></div>
        </div>
    </div>

<!-- Polaroid Customization Modal -->
<div id="heart-photo-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>自定义拍立得</h3>
        <form id="heart-photo-form">
            <div id="heart-photo-preview" style="width: 150px; height: 150px; border: 2px dashed #ddd; border-radius: 10px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                <span>预览</span>
            </div>
            <div class="form-group">
                <label for="heart-photo-url-input">图片URL</label>
                <input type="url" id="heart-photo-url-input" class="form-group" placeholder="粘贴图片URL">
            </div>
            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
            <input type="file" id="heart-photo-file-upload" accept="image/*" style="display:none;">
            <label for="heart-photo-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            <button type="submit" class="btn btn-primary">保存</button>
        </form>
    </div>
</div>
    <div id="forum-binding-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>绑定上下文</h3>
            <div class="forum-binding-tabs">
                <button class="tab-btn active" data-target="binding-content-worldbook">世界书</button>
                <button class="tab-btn" data-target="binding-content-char">char</button>
                <button class="tab-btn" data-target="binding-content-user">user</button>
            </div>
            <div id="forum-binding-content-wrapper">
                <div id="binding-content-worldbook" class="forum-binding-content active">
                    <ul id="forum-worldbook-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-char" class="forum-binding-content">
                    <ul id="forum-char-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-user" class="forum-binding-content">
                    <ul id="forum-user-list" class="binding-list"></ul>
                </div>
            </div>
            <button id="confirm-forum-binding-btn" class="btn btn-primary" style="margin-top: 20px;">确认绑定</button>
        </div>
    </div>


<!-- Generate Journal Modal -->
<div id="generate-journal-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>指定总结范围</h3>
        <form id="generate-journal-form">
            <div id="journal-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="journal-range-start">起始消息 (序号)</label>
                <input type="number" id="journal-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="journal-range-end">结束消息 (序号)</label>
                <input type="number" id="journal-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">生成</button>
        </form>
    </div>
</div>

<!-- Journal World Book Selection Modal -->
<div id="journal-worldbook-selection-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>为日记绑定世界书</h3>
        <ul id="journal-worldbook-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
            <!-- World book items will be rendered here -->
        </ul>
        <button class="btn btn-primary" id="save-journal-worldbook-selection-btn" style="margin-top: 20px;">确认</button>
    </div>
</div>

<!-- NEW: Delete History Chunk Modals -->
<div id="delete-chunk-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>删除指定范围记录</h3>
        <form id="delete-chunk-form">
            <div id="delete-chunk-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="delete-range-start">起始消息 (序号)</label>
                <input type="number" id="delete-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="delete-range-end">结束消息 (序号)</label>
                <input type="number" id="delete-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">下一步</button>
        </form>
    </div>
</div>

<div id="share-post-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>是否将分享给他人？</h3>
        <div style="margin: 20px 0;">
            <details>
                <summary style="font-weight: 500; cursor: pointer; color: var(--primary-color);">选择分享对象</summary>
                <ul id="share-char-list" class="binding-list" style="margin-top: 10px; max-height: 40vh; overflow-y: auto;">

                </ul>
            </details>
        </div>
        <button id="confirm-share-btn" class="btn btn-primary" style="margin-top: 15px;">确认发送</button>
    </div>
</div>


<div id="delete-chunk-confirm-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>确认删除</h3>
        <p>将永久删除以下范围的消息，此操作不可撤销！</p>
        <div id="delete-chunk-preview" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 10px; margin: 15px 0; font-size: 12px; line-height: 1.5;">
            <!-- Preview will be inserted here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="confirm-delete-chunk-btn" class="btn btn-danger" style="flex: 1;">永久删除</button>
            <button id="cancel-delete-chunk-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
        </div>
    </div>
</div>

<div id="bubble-presets-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理气泡预设</h3><div id="bubble-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="close-presets-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="mypersona-presets-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理我的人设预设</h3><div id="mypersona-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="mypersona-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="global-css-presets-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理全局CSS预设</h3><div id="global-css-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;"><button type="button" id="global-css-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<input type="file" id="import-data-input" accept=".ee" style="display: none;">
<input type="file" id="import-global-css-input" accept=".css" style="display: none;">
<div id="storage-screen" class="screen"></div>
<input type="file" id="character-card-input" accept="image/png,application/json" style="display: none;">
<input type="file" id="import-world-books-file-input" accept=".json" style="display: none;">
<!-- INS Widget Avatar Modal -->
<div id="ins-widget-avatar-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 style="font-family: var(--font-family);">更换头像</h3>
        <form id="ins-widget-avatar-form">
            <input type="hidden" id="ins-widget-avatar-target">
            <div id="ins-widget-avatar-preview" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                <span>预览</span>
            </div>
            <div class="form-group">
                <label for="ins-widget-avatar-url-input" style="font-family: var(--font-family);">头像URL</label>
                <input type="url" id="ins-widget-avatar-url-input" class="form-group" placeholder="粘贴图片URL" style="font-family: var(--font-family);">
            </div>
            <div class="or-divider" style="font-family: var(--font-family);">或</div>
            <input type="file" id="ins-widget-avatar-file-upload" accept="image/*" style="display:none;">
            <label for="ins-widget-avatar-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px; font-family: var(--font-family);">从本地上传</label>
            <button type="submit" class="btn btn-primary" style="font-family: var(--font-family);">保存</button>
        </form>
    </div>
</div>
    <!-- Update Log Modal -->
    <div id="update-log-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发现新版本！</h3>
            <div id="update-log-modal-content">
                <!-- Update content will be injected here -->
            </div>
            <button id="close-update-log-modal" class="btn btn-primary" style="margin-top: 15px;">我知道了</button>
        </div>
    </div>
    <style>
        /* --- Update Log Modal Styles --- */
        #update-log-modal .modal-window {
            max-width: 380px;
            text-align: left;
        }

        #update-log-modal-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px;
            margin: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 8px;
        }

        #update-log-modal-content h4 {
            font-size: 16px;
            color: var(--primary-color);
            margin-top: 5px;
            margin-bottom: 6px;
        }

        #update-log-modal-content h4:first-child {
            margin-top: 0;
        }

        #update-log-modal-content ul {
            list-style-type: none;
            padding-left: 5px;
            margin: 0;
        }

        #update-log-modal-content li {
            margin-bottom: 6px;
            line-height: 1.6;
            font-size: 14px;
            color: #555;
            position: relative;
            padding-left: 20px;
        }

        #update-log-modal-content li:last-child {
            margin-bottom: 0;
        }

        #update-log-modal-content li::before {
            content: '✨';
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--accent-color);
        }

        /* --- 偷看设置间距优化 --- */
        #peek-wallpaper-modal .form-group label {
            margin-top: 5px;
            margin-bottom: 12px;
        }

        /* --- NovelAI 相关样式 (v2 - UI对齐修复) --- */

        /* API 设置页面的开关样式 (与您现有的 time-perception-switch 样式对齐) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            flex-shrink: 0; /* 防止被压缩 */
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .slider {
            background-color: var(--primary-color);
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* API Key 输入框的显隐按钮 */
        #novelai-key-toggle {
            position: absolute;
            right: 12px; /* 调整位置以匹配 form-group 的 padding */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
            font-size: 18px;
            color: #888;
            z-index: 2; /* 确保在输入框之上 */
        }

        /* * 弹窗 UI 结构修复：
         * 移除 .modal-header, .modal-body, .modal-footer 的特定样式
         * 弹窗内容现在直接放在 .modal-window 中
        */

        /* 弹窗内的复选框和标签 */
        .nai-modal-content .form-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .nai-modal-content .form-group small {
            font-size: 12px;
            color: #666;
            display: block;
            margin-top: 5px;
        }

        /* 弹窗内的关闭按钮 (匹配 index.html 弹窗的关闭按钮) */
        .nai-modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
            z-index: 10;
        }
        .nai-modal-close-btn:hover {
            color: #333;
        }

        /* 弹窗内容滚动区域 */
        .nai-modal-scrollable-content {
            max-height: 65vh; /* 限制内容最大高度 */
            overflow-y: auto; /* 超出时滚动 */
            padding: 15px 5px 0 5px; /* 顶部留出空间，左右微调 */
            margin: 0 -5px; /* 抵消内边距，使滚动条贴边 */
        }

        /* 测试弹窗图片预览 */
        #nai-result-image {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: contain;
        }

        /* NovelAI 设置弹窗中的复选框布局 */
        /* NAI 设置复选框组样式 (v-v-v 修复间距 v-v-v) */
        .nai-settings-checkbox-group {
            /* 移除 padding 和 gap，使用标准 margin-bottom */
            margin-bottom: 20px; /* 与标准form-group完全一致 */
        }

        .nai-settings-checkbox-group label[for] {
            display: block;
            margin-bottom: 8px; /* 与标准form-group完全一致 */
            color: var(--secondary-color);
            font-weight: 600;
        }

        .nai-settings-checkbox-group .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin-bottom: 0; /* 修复：覆盖全局 label 的 8px 边距 */
            /* 修复：移除多余的 margin-top */
            margin-top: 0;
        }

        .nai-settings-checkbox-group .checkbox-container span {
            font-size: 14px;
            color: #333;
        }

        /* (v-v-v 新增，确保 <small> 标签的间距正确 v-v-v) */
        .nai-settings-checkbox-group .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }

        .nai-settings-checkbox-group small {
            display: block;
            margin-top: 5px; /* 与标准form-group完全一致 */
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
        /* (^-^-^ 修复结束 ^-^-^) */

    </style>


<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>
<div id="novelai-settings-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 600px; width: 90%;">
        <h3 style="text-align: center; color: var(--primary-color);">NovelAI 生成设置</h3>
        <span class="nai-modal-close-btn" id="close-novelai-settings">&times;</span>

        <div class="nai-modal-scrollable-content">
            <div class="form-group">
                <label>图像尺寸（oplus可无限出小图）</label>
                <select id="nai-resolution">
                    <optgroup label="小">
                        <option value="512x768">纵向 (512x768)</option>
                        <option value="768x512">横向 (768x512)</option>
                        <option value="640x640">正方形 (640x640)</option>
                    </optgroup>
                    <optgroup label="正常">
                        <option value="832x1216">竖图 (832x1216)</option>
                        <option value="1216x832">横图 (1216x832)</option>
                        <option value="1024x1024" selected>方图 (1024x1024)</option>
                    </optgroup>
                    <optgroup label="壁纸">
                        <option value="1088x1920">纵向 (1088x1920)</option>
                        <option value="1920x1088">风景 (1920x1088)</option>
                    </optgroup>
                </select>
                <small>建议使用官方支持的标准尺寸以获得最佳效果</small>
            </div>
            <div class="form-group">
                <label>采样步数 (Steps)</label>
                <input type="number" id="nai-steps" value="28" min="1" max="50">
                <small>推荐值: 28 (值越高质量越好但耗时越长)</small>
            </div>
            <div class="form-group">
                <label>提示词相关性 (CFG Scale)</label>
                <input type="number" id="nai-cfg-scale" value="5" min="1" max="20" step="0.5">
                <small>推荐值: 5 (控制图像与提示词的相关程度)</small>
            </div>
            <div class="form-group">
                <label>采样器 (Sampler)</label>
                <select id="nai-sampler">
                    <option value="k_euler">Euler</option>
                    <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                    <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                    <option value="k_dpmpp_2m">DPM++ 2M</option>
                    <option value="k_dpmpp_sde">DPM++ SDE</option>
                    <option value="ddim">DDIM</option>
                </select>
                <small>推荐值: Euler Ancestral (不同的采样器有不同的图像风格)</small>
            </div>
            <div class="form-group">
                <label>随机种子 (Seed)</label>
                <input type="number" id="nai-seed" value="-1" min="-1" max="9999999999">
                <small>-1 表示随机，固定种子可复现相同图像</small>
            </div>
            <div class="form-group">
                <label>负面提示词预设 (UC Preset)</label>
                <select id="nai-uc-preset">
                    <option value="0">Preset 0 - Heavy</option>
                    <option value="1" selected>Preset 1 - Light</option>
                    <option value="2">Preset 2 - Human Focus</option>
                    <option value="3">Preset 3 - None</option>
                </select>
                <small>推荐值: Preset 1 - Light (控制负面提示词的强度)</small>
            </div>

            <div class="form-group nai-settings-checkbox-group">
                <label for="nai-quality-toggle">质量标签</label>
                <label class="checkbox-container">
                    <input type="checkbox" id="nai-quality-toggle" checked>
                    <span>自动添加质量提升标签</span>
                </label>
                <small>推荐开启 (自动提升画面质量)</small>
            </div>
            <div class="form-group nai-settings-checkbox-group">
                <label for="nai-smea">SMEA (提升细节)</label>
                <label class="checkbox-container">
                    <input type="checkbox" id="nai-smea" checked>
                    <span>启用SMEA增强</span>
                </label>
                <small>推荐开启 (增强图像细节表现)</small>
            </div>
            <div class="form-group nai-settings-checkbox-group">
                <label for="nai-smea-dyn">SMEA DYN (动态优化)</label>
                <label class="checkbox-container">
                    <input type="checkbox" id="nai-smea-dyn">
                    <span>启用动态SMEA</span>
                </label>
                <small>可选功能 (动态优化细节表现)</small>
            </div>
            <div class="form-group">
                <label>全局预设</label>
                <div style="display:flex;align-items:center;gap:10px;">
                    <select id="nai-global-prompt-preset-select" style="flex:1;min-width:120px;padding:12px;border-radius:10px;border:2px solid #fce4ec;background-color:#fff;">
                        <option value="">— 选择全局提示词预设 —</option>
                    </select>
                    <button type="button" id="nai-global-prompt-save-preset" class="btn btn-secondary" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">另存</button>
                    <button type="button" id="nai-global-prompt-manage-presets" class="btn btn-neutral" style="flex-shrink:0;white-space:nowrap;min-width:auto;width:auto;margin:0;">管理</button>
                </div>
                <small>保存和管理常用的提示词预设</small>
            </div>

            <div class="form-group">
                <label>默认正面提示词</label>
                <textarea id="nai-default-positive" rows="3" placeholder="masterpiece, best quality, 1girl, beautiful...">masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea>
                <small>此提示词将在生成时自动使用，用于描述你希望在画面中看到的内容。</small>
            </div>
            <div class="form-group">
                <label>默认负面提示词</label>
                <textarea id="nai-default-negative" rows="3" placeholder="lowres, bad anatomy, bad hands, text, error...">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
                <small>设置默认的负面提示词，避免生成不需要的内容</small>
            </div>
            <div class="form-group">
                <label>🌐 CORS 代理设置</label>
                <select id="nai-cors-proxy">
                    <option value="">❌ 直连（无代理）</option>
                    <option value="https://corsproxy.io/?" selected>✅ corsproxy.io（推荐）</option>
                    <option value="https://api.allorigins.win/raw?url=">allorigins.win</option>
                    <option value="https://cors-anywhere.herokuapp.com/">cors-anywhere（需激活）</option>
                    <option value="custom">🔧 自定义代理</option>
                </select>
                <small style="color: #e74c3c;">⚠️ 本地运行会遇到CORS跨域问题，需使用代理。</small>
            </div>
            <div id="nai-custom-proxy-group" class="form-group" style="display: none;">
                <label>自定义代理地址</label>
                <input type="text" id="nai-custom-proxy-url" placeholder="https://your-proxy.com/?">
                <small>代理URL应以 / 或 ? 结尾，例如：https://proxy.com/?</small>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="reset-nai-settings-btn" class="btn btn-neutral" style="flex: 1;">恢复默认</button>
            <button id="save-nai-settings-btn" class="btn btn-primary" style="flex: 1;">保存设置</button>
        </div>
    </div>
</div>
<div id="novelai-test-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 700px; width: 90%;">
        <h3 style="text-align: center; color: var(--primary-color);">🖼️ NovelAI 测试生成</h3>
        <span class="nai-modal-close-btn" id="close-novelai-test">&times;</span>

        <div class="nai-modal-scrollable-content">
            <div class="form-group">
                <label>正面提示词（此处提示词仅用于该弹窗测试）</label>
                <textarea id="nai-test-prompt" rows="4" placeholder="1girl, solo, long hair, blue eyes, smile...">1girl, solo, long hair, blue eyes, smile, outdoors, cherry blossoms, spring</textarea>
            </div>
            <div class="form-group">
                <label>负面提示词（可选，留空使用默认）</label>
                <textarea id="nai-test-negative" rows="3" placeholder="留空将使用设置中的默认负面提示词"></textarea>
            </div>
                <div id="nai-test-status" style="text-align: center; color: #666; margin: 15px 0; display: none;">
                正在生成中，请稍候...
            </div>
            <div id="nai-test-result" style="display: none; margin-top: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333;">生成结果：</div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <img id="nai-result-image" class="naiimag-image" style="max-width: 100%; border-radius: 8px; cursor: pointer;" title="三击下载图片">
                </div>
            </div>
            <div id="nai-test-error" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; color: #721c24; border-radius: 6px; border: 1px solid #f5c6cb;"></div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="close-nai-test-btn" class="btn btn-neutral" style="flex: 1;">关闭</button>
            <button id="nai-generate-btn" class="btn btn-primary" style="flex: 1;">生成图像</button>
        </div>
    </div>
</div>

<!-- 分类管理弹窗 -->
<div id="sticker-category-manager-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 360px;">
        <h3 style="text-align: center; color: var(--text-color); margin-bottom: 25px;">管理表情分类</h3>
        <form id="add-category-form" class="form-group">
            <label for="new-category-name-input" style="color: var(--secondary-color); font-weight: 600;">新建分类</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="new-category-name-input" class="form-group" placeholder="输入分类名..." style="flex-grow: 1; margin-bottom: 0;">
                <button type="submit" id="add-new-category-btn" class="btn btn-primary" style="width: auto; padding: 10px 18px; margin-bottom: 0; flex-shrink: 0;">添加</button>
            </div>
        </form>
        <div id="existing-categories-list">
            </div>
        <button id="close-category-manager-btn" class="btn btn-primary" style="margin-top: 25px;">完成</button>
    </div>
    </div>

<div id="nai-module-manager-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 400px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; position: relative;">
        <h3 style="text-align: center; color: var(--primary-color); margin: 0 0 15px 0; flex-shrink: 0;">NAI 模块手册</h3>
        <span class="nai-modal-close-btn" id="close-nai-module-manager">&times;</span>

        <div class="nai-modal-content" style="flex: 1; overflow-y: auto; padding-right: 5px;">
            <div class="form-group" style="background: #fdfdfd; padding: 15px; border-radius: 10px; border: 1px solid #f0f0f0; margin-bottom: 20px;">
                <label for="new-nai-module-name" style="font-weight: 600; color: var(--secondary-color);">创建新模块</label>
                <input type="text" id="new-nai-module-name" class="form-group" placeholder="模块名称 (例如: 女性, 角色A, 场景)" style="margin-bottom: 10px;">
                <textarea id="new-nai-module-content" rows="3" class="form-group" placeholder="模块内容 (提示词, 英文逗号隔开...)" style="margin-bottom: 10px;"></textarea>
                <button type="button" id="create-nai-module-btn" class="btn btn-primary" style="width: 100%;">添加至全局手册</button>
            </div>
            
            <div class="form-group">
                <label style="font-weight: 600; color: var(--secondary-color);">挂载模块 (为当前聊天勾选)</label>
                <div id="nai-module-list-container" style="border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fff;">
                    <p style="text-align: center; color: #aaa;">暂无模块，请在上方创建</p>
                </div>
            </div>
        </div>
        
        <button id="save-nai-module-selection-btn" class="btn btn-primary" style="margin-top: 15px; flex-shrink: 0;">保存挂载</button>
    </div>
</div>

<div id="nai-module-edit-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>编辑模块</h3>
        <form id="nai-module-edit-form">
            <input type="hidden" id="edit-nai-module-id">
            <div class="form-group">
                <label for="edit-nai-module-name">模块名称</label>
                <input type="text" id="edit-nai-module-name" class="form-group" required>
            </div>
            <div class="form-group">
                <label for="edit-nai-module-content">模块内容 (提示词)</label>
                <textarea id="edit-nai-module-content" rows="5" class="form-group" required></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                <button type="button" id="cancel-nai-module-edit-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
            </div>
        </form>
    </div>
</div>
<div id="nai-global-prompt-presets-modal" class="modal-overlay">
    <div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);position:relative;">
        <h3 style="margin:0 0 10px 0;font-size:16px;">管理全局提示词预设</h3>
        <span class="nai-modal-close-btn" id="nai-global-prompt-close-modal">&times;</span>
        <div id="nai-global-prompt-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;">
        </div>
    </div>
</div>

<div id="font-presets-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理字体预设</h3><div id="font-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="font-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>

    <div id="ai-space-wallet-transactions-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="peek-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-wallet-transactions-title">的钱包</h1>
        </div>
        <button class="action-btn" id="refresh-wallet-transactions-btn">
             <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
        </button>
    </header>
        <main class="content">
            <ul class="list-container" id="ai-wallet-transactions-list"></ul>
            <div class="placeholder-text" id="no-wallet-placeholder" style="display: none;">
                <p>点击右上角刷新，生成账单记录</p>
            </div>
        </main>
    </div>

    <div id="ai-space-wallet-detail-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="ai-wallet-detail-description">账单详情</h3>
            <div style="text-align: center; margin: 20px 0;">
                <p id="ai-wallet-detail-amount" style="font-size: 28px; font-weight: bold; margin: 0;"></p>
                <p id="ai-wallet-detail-status" style="font-size: 14px; color: #888;"></p>
            </div>
            <p><strong>交易时间:</strong> <span id="ai-wallet-detail-time"></span></p>
            <p><strong>交易对象:</strong> <span id="ai-wallet-detail-peer"></span></p>
            <button class="btn btn-primary" id="close-ai-wallet-detail-btn" style="margin-top: 20px;">关闭</button>
        </div>
    </div>
</div>
    <script src="script.js?v=1.1.3" defer></script>
</body>

</html>
