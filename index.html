<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>小章鱼(Chien版)</title>
    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nhRgZDFX/xiao-zhang-yu-Chien.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<svg width="0" height="0" style="position:absolute;">
  <defs>
    <clipPath id="heart-clip" clipPathUnits="objectBoundingBox">
      <path d="M0.5,1 C0.1,0.8,0,0.45,0.5,0.2 C1,0.45,0.9,0.8,0.5,1 Z" />
    </clipPath>
  </defs>
</svg>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn" title="群聊">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>
                <button class="action-btn" id="import-character-card-btn" title="导入">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                </button>
                <button class="action-btn" id="add-chat-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div>
                    <span id="chat-room-status-text">在线</span>
                </div>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="peek-btn">
                    <img src="https://i.postimg.cc/m2DRpk7v/chan-39.png" alt="偷看" style="width: 28px; height: 28px;">
                </button>
                <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png"
                                                                       alt="设置"></button>
            </div>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
            <div id="sticker-bar">
                <button class="sticker-bar-btn" id="regenerate-btn" title="重回">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65,6.35C16.2,4.9,14.21,4,12,4A8,8,0,0,0,4,12A8,8,0,0,0,12,20C15.73,20,18.84,17.45,19.73,14H17.65C16.83,16.33,14.61,18,12,18A6,6,0,0,1,6,12A6,6,0,0,1,12,6C13.66,6,15.14,6.69,16.22,7.78L13,11H20V4L17.65,6.35Z" />
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="sticker-toggle-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="photo-video-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="image-recognition-btn" title="图片">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5H3v14h18M5 7h14v10H5V7m3.5 1.5A1.5 1.5 0 1 1 7 10a1.5 1.5 0 0 1 1.5-1.5M19 17l-4.5-5.5L11 16l-2-2.5L5 17"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="voice-message-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="wallet-btn" title="转账">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4M20 18H4V8H20V18M16 12.5A1.5 1.5 0 1 0 16 15.5A1.5 1.5 0 0 0 16 12.5Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="gift-btn" title="礼物">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.16 14h8.53a2 2 0 0 0 1.93-1.5L19 6H6.21L5.27 4H2v2h2l3.6 7.59L6.25 17H19v-2H7.65l-.49-1z"/>
                        <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                    </svg>
                </button>
                <!-- NEW: Time Skip Button -->
                <button class="sticker-bar-btn" id="time-skip-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="placeholder-plus-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </button>
            </div>
            <div id="reply-preview-bar">
                <div class="reply-preview-content">
                    <span class="reply-preview-name"></span>
                    <p class="reply-preview-text"></p>
                </div>
                <button id="cancel-reply-btn">×</button>
            </div>
            <div class="message-input-area" id="message-input-default">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button id="send-message-btn" class="icon-btn send-btn">➤</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="music-screen" class="screen"></div>

        
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <div id="sticker-modal">
            <div class="header">
                <div class="header-left">
                    <span class="title">我的表情</span>
                </div>
                <div class="header-right">
                    <button class="panel-btn" id="sticker-category-manage-btn">分类</button>
                    <button class="panel-btn" id="manage-stickers-btn">管理</button>
                    <button class="panel-btn" id="batch-add-sticker-btn">批量</button>
                    <button class="panel-btn" id="add-new-sticker-btn">上传</button>
                </div>
            </div>
            <div id="sticker-category-tabs"></div>
            <div id="sticker-search-container">
                <input type="search" id="sticker-search-input" placeholder="搜索表情名称...">
            </div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
            <div id="sticker-manage-bar">
                <label>
                    <input type="checkbox" id="sticker-select-all-checkbox">
                    全选
                </label>
                <button class="btn btn-danger" id="delete-selected-stickers-btn">删除 (0)</button>
            </div>
        </div>
        <!-- NEW: Chat Expansion Panel -->
        <div id="chat-expansion-panel">
            <div class="sticker-grid" id="chat-expansion-grid">
                <!-- Items will be populated by JS -->
            </div>
        </div>
    </div>
  
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="add-world-book-btn">+</button>
                <button class="action-btn" id="cancel-wb-multi-select-btn" style="display: none; font-size: 16px;">取消</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的“+”创造第一个设定吧！</p>
            </div>
        </main>
        <div id="world-book-multi-select-bar" style="display: none;">
            <span id="world-book-select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-world-books-btn" style="width: auto; padding: 8px 16px;">删除已选</button>
        </div>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-category">条目分类</label>
                    <input type="text" id="world-book-category" placeholder="例如：人物、地点、组织（可选）">
                </div>
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                        <label><input type="radio" name="world-book-position" value="after"> 后</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast">
        <img class="toast-avatar" src="" alt="avatar">
        <div class="toast-content">
            <div class="toast-name"></div>
            <div class="toast-message"></div>
        </div>
    </div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <!-- Message Edit Modal -->
    <div id="message-edit-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>编辑消息</h3>
            <form id="message-edit-form">
                <div class="form-group">
                    <textarea id="message-edit-textarea" rows="6" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" id="cancel-edit-modal-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">添加新表情</h3>
            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <div class="form-group">
                    <label for="sticker-category-select">选择分类</label>
                    <select id="sticker-category-select" class="form-group"></select>
                </div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <div class="or-divider">或</div><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <!-- Batch Add Sticker Modal -->
    <div id="batch-add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>批量导入表情</h3>
            <form id="batch-add-sticker-form">
                <div class="form-group">
                    <label for="sticker-urls-textarea">数据格式：名称:URL (英文冒号，每行一个)</label>
                    <textarea id="sticker-urls-textarea" rows="8" placeholder="例如：&#10;开心:https://example.com/happy.gif&#10;哭泣:https://example.com/cry.png"></textarea>
                </div>
                <div class="form-group">
                    <label for="batch-sticker-category-select">选择分类</label>
                    <select id="batch-sticker-category-select" class="form-group"></select>
                </div>
                <button type="submit" class="btn btn-primary">开始导入</button>
            </form>
        </div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                                                 class="avatar-preview"><input type="file"
                                                                               id="setting-char-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-char-avatar-upload" class="btn btn-primary"
                        style="flex-grow:1;">更换角色头像</label></div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="mypersona-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">人设</label><select id="mypersona-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="mypersona-apply-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="mypersona-save-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="mypersona-manage-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡</label><select id="bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <div class="form-group" id="nai-character-settings-group">
        <hr style="opacity: 0.2; margin: 20px 0;">
        <label style="font-weight: 600; color: var(--accent-color);">NAI出图设置</label>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            为当前角色配置专属的NovelAI出图提示词
        </p>

        <div style="margin-top: 15px;">
            <label style="font-weight: 500;">提示词来源</label>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="nai-prompt-source" value="system" checked>
                    <span>使用系统设置</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="nai-prompt-source" value="character">
                    <span>使用当前角色配置</span>
                </label>
            </div>
        </div>

        <button type="button" id="character-nai-prompts-btn" class="btn btn-secondary" style="width: 100%; margin-top: 15px;">配置角色专属提示词</button> </div>

                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Global Pomodoro World Book Selection Modal -->
    <div id="global-pomodoro-world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>为全局专注设置关联世界书</h3>
            <ul id="global-pomodoro-world-book-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
                <!-- World book items will be rendered here -->
            </ul>
            <button class="btn btn-primary" id="save-global-pomodoro-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary"
                           style="flex-grow:1;">更换群头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"
                           style="flex-grow:1;">更换我的头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
                <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="group-bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡预设</label><select id="group-bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="group-apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="group-save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="group-manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <div class="form-group" id="group-nai-settings-group">
        <hr style="opacity: 0.2; margin: 20px 0;">
        <label style="font-weight: 600; color: var(--accent-color);">NAI出图设置</label>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            为当前群聊配置专属的NovelAI出图提示词 (对所有AI成员生效)
        </p>

        <div style="margin-top: 15px;">
            <label style="font-weight: 500;">提示词来源</label>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="group-nai-prompt-source" value="system" checked>
                    <span>使用系统设置</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="group-nai-prompt-source" value="character">
                    <span>使用当前群聊配置</span>
                </label>
            </div>
        </div>

        <button type="button" id="group-character-nai-prompts-btn" class="btn btn-secondary" style="width: 100%; margin-top: 15px;">配置群聊专属提示词</button> </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"
                         style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
    <!-- Memory Journal Screen -->
    <div id="memory-journal-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">回忆日记</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="bind-journal-worldbook-btn" title="绑定世界书">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                    </svg>
                </button>
                <button class="action-btn" id="generate-new-journal-btn" title="生成新日记">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                </button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="journal-list-container">
                <!-- Journal cards will be rendered here -->
            </ul>
            <div class="placeholder-text" id="no-journals-placeholder" style="display: none;">
                <p>还没有日记哦~</p>
                <p>点击右上角的“+号”来创建第一篇吧！</p>
            </div>
        </main>
    </div>

    <!-- Memory Journal Detail Screen -->
    <div id="memory-journal-detail-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="memory-journal-screen">‹</button>
            <div class="title-container">
                <h1 class="title">日记详情</h1>
            </div>
            <button class="action-btn" id="edit-journal-detail-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
            </button>
        </header>
        <main class="content" style="padding: 20px; font-family: 'Georgia', 'Times New Roman', serif;">
            <h2 id="journal-detail-title" style="margin-top: 0; font-size: 22px;"></h2>
            <p id="journal-detail-meta" style="font-size: 12px; color: #aaa; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;"></p>
            <div id="journal-detail-content" style="line-height: 1.7; white-space: pre-wrap; font-size: 16px;"></div>
        </main>
    </div>

    <!-- Peek Steps App Screen -->
    <div id="peek-steps-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">步数</h1>
            </div>
            <div class="placeholder"></div> <!-- To balance the header -->
        </header>
        <main class="content">
            <div class="steps-header">
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="Char Avatar" class="steps-header-avatar" id="steps-char-avatar">
                <span class="steps-header-name" id="steps-char-name">Char</span>
            </div>

            <div class="steps-progress-container">
                <div class="steps-progress-circle" id="steps-progress-ring"></div>
                <div class="steps-progress-inner">
                    <div class="steps-count" id="steps-current-count">4321</div>
                    <div class="steps-label">/ 6000 步</div>
                </div>
            </div>

            <div class="steps-module">
                <h3 class="steps-module-title">最近活动轨迹</h3>
                <ul class="activity-track-list" id="activity-track-list">
                    <li class="activity-track-item">10:00 AM - 咖啡馆</li>
                    <li class="activity-track-item">01:30 PM - 市中心图书馆</li>
                    <li class="activity-track-item">06:00 PM - 河边公园</li>
                    <li class="activity-track-item">07:00 PM - 健身房</li>
                    <li class="activity-track-item">08:30 PM - 超市</li>
                    <li class="activity-track-item">09:00 PM - 回家</li>
                </ul>
            </div>
            <div class="steps-annotation" id="steps-annotation-content">
                “今天走了不少路，但感觉很充实。特别是下午在图书馆找到的那本书，感觉能看很久。”
            </div>
        </main>
    </div>

    <div id="peek-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的手机</h1>
            </div>
            <button class="action-btn" id="peek-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
        </header>
        <main class="content" style="padding: 50px 0; justify-content: flex-start; align-items: center;">
            <!-- Content rendered by renderPeekScreen() -->
        </main>
    </div>

   <div id="forum-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">←</button>
        <div class="title-container">
            <h1 class="title">论坛</h1>
        </div>

        <div class="action-btn-group"></div>
    </header>
    <main class="content" style="padding: 15px;">

        <div class="forum-search-bar">
            <button class="action-btn" id="forum-link-btn" title="绑定">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                </svg>
            </button>
            <input type="text" id="forum-search-input" placeholder="搜索关键词">
            <button class="action-btn" id="forum-refresh-btn" title="刷新">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </div>

        <div id="forum-posts-container">
            <p class="placeholder-text" style="margin-top: 50px;">点击右上角刷新按钮来生成帖子...</p>
        </div>
    </main>
</div>



<div id="forum-post-detail-screen" class="screen">

</div>


<div id="storage-analysis-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">存储分析</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content" style="flex-direction: column; justify-content: flex-start; padding: 20px; gap: 20px;">
        <div id="storage-chart-container" style="width: 100%; height: 300px; flex-shrink: 0;"></div>
        <div id="storage-total-size-container" style="text-align: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;">
            <span style="font-size: 14px; color: #888;">总占用空间</span>
            <h2 id="storage-total-size" style="margin: 4px 0 0 0; font-size: 24px; color: #333; font-weight: 600;">---</h2>
        </div>
        <div id="storage-details-list" style="width: 100%; overflow-y: auto;"></div>
    </main>
</div>


<div id="peek-messages-screen" class="screen">

        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的消息</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <ul class="list-container" id="peek-chat-list-container">
                <!-- Simulated chat list will be rendered here -->
            </ul>
        </main>
    </div>

    <!-- Peek Conversation Screen -->
    <div id="peek-conversation-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-messages-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="peek-conversation-title">...</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <div class="message-area" id="peek-message-area">
                <!-- Simulated messages will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Peek Memos Screen -->
    <div id="peek-memos-screen" class="screen"></div>

    <!-- Peek Memo Detail Screen -->
    <div id="peek-memo-detail-screen" class="screen"></div>

    <!-- Peek Cart Screen -->
    <div id="peek-cart-screen" class="screen"></div>

    <!-- Peek Transfer Station Screen -->
    <div id="peek-transfer-station-screen" class="screen"></div>

    <!-- Peek Browser Screen -->
    <div id="peek-browser-screen" class="screen"></div>

    <!-- Peek Drafts Screen -->
    <div id="peek-drafts-screen" class="screen"></div>

    <div id="peek-album-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container"><h1 class="title">相册</h1></div>
            <button class="action-btn" id="refresh-album-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
        </header>
        <main class="content">
            <div class="album-grid">
                <p class="placeholder-text">正在生成相册内容...</p>
            </div>
        </main>
    </div>
 
    <!-- Peek Unlock Screen (Social Media) -->
    <div id="peek-unlock-screen" class="screen">
        <!-- Content will be dynamically rendered by renderPeekUnlock() -->
    </div>
 
    <div id="peek-confirm-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>要偷看ta的手机吗？</h3>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="peek-confirm-yes" class="btn btn-primary" style="flex: 1;">是</button>
                <button id="peek-confirm-no" class="btn btn-neutral" style="flex: 1;">否</button>
            </div>
        </div>
    </div>
    <!-- New Peek Wallpaper Modal -->
    <div id="peek-wallpaper-modal" class="modal-overlay">
        <div class="modal-window" style="max-height: 80vh; overflow-y: auto;">
            <h3>“偷看”页面自定义</h3>
            <div class="collapsible-section open">
                <div class="collapsible-header">
                    <h4>页面壁纸</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <form id="peek-wallpaper-form">
                        <div class="form-group">
                            <label for="peek-wallpaper-url-input">壁纸URL</label>
                            <input type="url" id="peek-wallpaper-url-input" class="form-group" placeholder="粘贴图片URL">
                        </div>
                        <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                        <input type="file" id="peek-wallpaper-upload" accept="image/*" style="display: none;">
                        <label for="peek-wallpaper-upload" class="btn btn-secondary">从本地上传</label>
                    </form>
                </div>
            </div>
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content" id="peek-app-icons-settings">
                    <!-- App icon settings will be rendered here by JS -->
                </div>
            </div>
             <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>微博(Unlock)小号</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label for="peek-unlock-avatar-url">头像URL</label>
                        <input type="url" id="peek-unlock-avatar-url" class="form-group" placeholder="粘贴图片URL">
                    </div>
                </div>
            </div>
            <button id="save-peek-settings-btn" class="btn btn-primary" style="margin-top: 20px;">保存所有更改</button>
        </div>
    </div>
<div id="pomodoro-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注任务</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-settings-btn" title="设置">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
            <button class="action-btn" id="pomodoro-create-task-btn" title="创建任务">+</button>
        </div>
    </header>
    <main class="content">
        <div class="task-list-container" id="pomodoro-task-list">
            <!-- Task cards will be rendered here by JS -->
        </div>
        <p class="placeholder-text" id="pomodoro-no-tasks-placeholder">还没有专注任务，点击右上角“+”创建一个吧。</p>
    </main>
</div>
<!-- Pomodoro Focus Screen -->
<div id="pomodoro-focus-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="pomodoro-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注中</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-focus-settings-btn" title="设置">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
        </div>
    </header>
    <main class="content">
        <div class="focus-timer-container">
            <h2 class="focus-task-title">阅读一章《JavaScript高级程序设计》</h2>
            <div class="focus-timer-display">24:32</div>
            <div class="focus-timer-mode">倒计时</div>
            <div class="focus-total-time" id="pomodoro-total-focused-time">已专注 0 分钟</div>
        </div>

        <div class="focus-footer">
            <div class="focus-message-bubble">
                <p>保持专注，你做得很好！</p>
            </div>
            <div class="focus-bottom-controls">
                <div class="focus-controls-group">
                    <button class="control-btn" id="pomodoro-start-btn" title="开始">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button class="control-btn" id="pomodoro-pause-btn" title="暂停" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" class="focus-avatar" alt="avatar">
                <button class="control-btn" id="pomodoro-giveup-btn" title="放弃">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Pomodoro Settings Sidebar -->
<div id="pomodoro-settings-sidebar" class="settings-sidebar">
    <div class="header">专注设置</div>
    <div class="content">
        <form id="pomodoro-settings-form">
            <div class="form-group">
                <label for="pomodoro-char-select">绑定陪伴角色</label>
                <select id="pomodoro-char-select" class="form-group"></select>
            </div>
            <div class="form-group">
                <label for="pomodoro-user-persona-select">选择你的设定</label>
                <select id="pomodoro-user-persona-select" class="form-group"></select>
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-encouragement-minutes">鼓励机制 (分钟)</label>
                <input type="number" id="pomodoro-encouragement-minutes" class="form-group" placeholder="专注多少分钟后收到鼓励" min="1">
            </div>
            <div class="form-group">
                <label for="pomodoro-poke-limit">“戳一戳”次数上限</label>
                <input type="number" id="pomodoro-poke-limit" class="form-group" placeholder="每次专注允许戳几次" min="0">
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-focus-bg-url">专注界面背景 URL</label>
                <input type="url" id="pomodoro-focus-bg-url" class="form-group" placeholder="粘贴图片URL">
            </div>
            <div class="form-group">
                <label for="pomodoro-focus-bg-upload" class="btn btn-secondary">或从本地上传</label>
                <input type="file" id="pomodoro-focus-bg-upload" accept="image/*" style="display:none;">
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-task-card-bg-url">任务卡片背景 URL</label>
                <input type="url" id="pomodoro-task-card-bg-url" class="form-group" placeholder="粘贴图片URL">
            </div>
            <div class="form-group">
                <label for="pomodoro-task-card-bg-upload" class="btn btn-secondary">或从本地上传</label>
                <input type="file" id="pomodoro-task-card-bg-upload" accept="image/*" style="display:none;">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">保存设置</button>
        </form>
    </div>
</div>

<!-- Pomodoro Global Settings Sidebar -->
<div id="pomodoro-global-settings-sidebar" class="settings-sidebar">
    <div class="header">全局专注设置</div>
    <div class="content">
        <form id="pomodoro-global-settings-form">
            <div class="form-group">
                <button type="button" class="btn btn-secondary" id="link-global-pomodoro-world-book-btn">关联世界书</button>
            </div>
            <p style="font-size: 12px; color: #888; margin-top: 15px;">
                这里关联的世界书将作为全局上下文，作用于所有番茄钟任务的AI互动。
            </p>
        </form>
    </div>
</div>

<!-- Pomodoro Certificate Modal -->
<div id="pomodoro-certificate-modal" class="modal-overlay">
    <div class="modal-window" style="text-align: center;">
        <h3>专注完成！</h3>
        <div id="pomodoro-certificate-content" style="border: 2px dashed var(--primary-color); padding: 20px; margin: 15px 0; border-radius: 10px; background: #fff8fa;">
            <p><strong>任务名称:</strong> <span id="cert-task-name"></span></p>
            <p><strong>专注时长:</strong> <span id="cert-duration"></span></p>
            <p><strong>“戳一戳”次数:</strong> <span id="cert-poke-count"></span></p>
        </div>
        <p>做的很棒！要不要把这次的专注成果分享一下？</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="forward-certificate-btn" class="btn btn-primary" style="flex: 1;">转发到聊天框</button>
            <button id="close-certificate-btn" class="btn btn-neutral" style="flex: 1;">关闭</button>
        </div>
    </div>
</div>

<!-- Pomodoro Record Detail Modal -->

<!-- Pomodoro Create Task Modal -->
<div id="pomodoro-create-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建专注任务</h3>
        <form id="pomodoro-create-form">
            <div class="form-group">
                <label for="pomodoro-task-name">任务名称</label>
                <input type="text" id="pomodoro-task-name" class="form-group" placeholder="例如：阅读一章《JavaScript高级程序设计》" required>
            </div>
            <div class="form-group">
                <label>计时模式</label>
                <div class="radio-group-pills">
                    <input type="radio" id="mode-countdown" name="pomodoro-mode" value="countdown" checked>
                    <label for="mode-countdown">倒计时</label>
                    <input type="radio" id="mode-stopwatch" name="pomodoro-mode" value="stopwatch">
                    <label for="mode-stopwatch">正计时</label>
                </div>
            </div>
            <div id="pomodoro-duration-options" class="visible">
                <button type="button" class="duration-pill active" data-duration="30">30分钟</button>
                <button type="button" class="duration-pill" data-duration="45">45分钟</button>
                <button type="button" class="duration-pill" data-duration="60">60分钟</button>
                <button type="button" class="duration-pill" data-duration="custom">自定义</button>
                <input type="number" id="pomodoro-custom-duration-input" class="form-group" placeholder="输入分钟数">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">创建任务</button>
        </form>
    </div>
</div>
    <div id="peek-photo-modal" class="modal-overlay">
        <div class="modal-window">
            <div id="peek-photo-image-container">
                <span class="placeholder-icon">🖼️</span>
            </div>
            <div id="peek-photo-description"></div>
        </div>
    </div>
</div>
 
<!-- Polaroid Customization Modal -->
<div id="heart-photo-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>自定义拍立得</h3>
        <form id="heart-photo-form">
            <div id="heart-photo-preview" style="width: 150px; height: 150px; border: 2px dashed #ddd; border-radius: 10px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                <span>预览</span>
            </div>
            <div class="form-group">
                <label for="heart-photo-url-input">图片URL</label>
                <input type="url" id="heart-photo-url-input" class="form-group" placeholder="粘贴图片URL">
            </div>
            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
            <input type="file" id="heart-photo-file-upload" accept="image/*" style="display:none;">
            <label for="heart-photo-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            <button type="submit" class="btn btn-primary">保存</button>
        </form>
    </div>
</div>
    <div id="forum-binding-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>绑定上下文</h3>
            <div class="forum-binding-tabs">
                <button class="tab-btn active" data-target="binding-content-worldbook">世界书</button>
                <button class="tab-btn" data-target="binding-content-char">char</button>
                <button class="tab-btn" data-target="binding-content-user">user</button>
            </div>
            <div id="forum-binding-content-wrapper">
                <div id="binding-content-worldbook" class="forum-binding-content active">
                    <ul id="forum-worldbook-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-char" class="forum-binding-content">
                    <ul id="forum-char-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-user" class="forum-binding-content">
                    <ul id="forum-user-list" class="binding-list"></ul>
                </div>
            </div>
            <button id="confirm-forum-binding-btn" class="btn btn-primary" style="margin-top: 20px;">确认绑定</button>
        </div>
    </div>


<!-- Generate Journal Modal -->
<div id="generate-journal-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>指定总结范围</h3>
        <form id="generate-journal-form">
            <div id="journal-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="journal-range-start">起始消息 (序号)</label>
                <input type="number" id="journal-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="journal-range-end">结束消息 (序号)</label>
                <input type="number" id="journal-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">生成</button>
        </form>
    </div>
</div>

<!-- Journal World Book Selection Modal -->
<div id="journal-worldbook-selection-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>为日记绑定世界书</h3>
        <ul id="journal-worldbook-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
            <!-- World book items will be rendered here -->
        </ul>
        <button class="btn btn-primary" id="save-journal-worldbook-selection-btn" style="margin-top: 20px;">确认</button>
    </div>
</div>

<!-- NEW: Delete History Chunk Modals -->
<div id="delete-chunk-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>删除指定范围记录</h3>
        <form id="delete-chunk-form">
            <div id="delete-chunk-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="delete-range-start">起始消息 (序号)</label>
                <input type="number" id="delete-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="delete-range-end">结束消息 (序号)</label>
                <input type="number" id="delete-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">下一步</button>
        </form>
    </div>
</div>

<div id="share-post-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>是否将分享给他人？</h3>
        <div style="margin: 20px 0;">
            <details>
                <summary style="font-weight: 500; cursor: pointer; color: var(--primary-color);">选择分享对象</summary>
                <ul id="share-char-list" class="binding-list" style="margin-top: 10px; max-height: 40vh; overflow-y: auto;">

                </ul>
            </details>
        </div>
        <button id="confirm-share-btn" class="btn btn-primary" style="margin-top: 15px;">确认发送</button>
    </div>
</div>


<div id="delete-chunk-confirm-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>确认删除</h3>
        <p>将永久删除以下范围的消息，此操作不可撤销！</p>
        <div id="delete-chunk-preview" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 10px; margin: 15px 0; font-size: 12px; line-height: 1.5;">
            <!-- Preview will be inserted here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="confirm-delete-chunk-btn" class="btn btn-danger" style="flex: 1;">永久删除</button>
            <button id="cancel-delete-chunk-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
        </div>
    </div>
</div>

<div id="bubble-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理气泡预设</h3><div id="bubble-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="close-presets-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="mypersona-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理我的人设预设</h3><div id="mypersona-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="mypersona-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="global-css-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理全局CSS预设</h3><div id="global-css-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="global-css-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<input type="file" id="import-data-input" accept=".ee" style="display: none;">
<div id="storage-screen" class="screen"></div>
<input type="file" id="character-card-input" accept="image/png,application/json" style="display: none;">
<!-- INS Widget Avatar Modal -->
<div id="ins-widget-avatar-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>更换头像</h3>
        <form id="ins-widget-avatar-form">
            <input type="hidden" id="ins-widget-avatar-target">
            <div id="ins-widget-avatar-preview" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                <span>预览</span>
            </div>
            <div class="form-group">
                <label for="ins-widget-avatar-url-input">头像URL</label>
                <input type="url" id="ins-widget-avatar-url-input" class="form-group" placeholder="粘贴图片URL">
            </div>
            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
            <input type="file" id="ins-widget-avatar-file-upload" accept="image/*" style="display:none;">
            <label for="ins-widget-avatar-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            <button type="submit" class="btn btn-primary">保存</button>
        </form>
    </div>
</div>
    <!-- Update Log Modal -->
    <div id="update-log-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发现新版本！</h3>
            <div id="update-log-modal-content">
                <!-- Update content will be injected here -->
            </div>
            <button id="close-update-log-modal" class="btn btn-primary" style="margin-top: 15px;">我知道了</button>
        </div>
    </div>
    <style>
        /* --- Update Log Modal Styles --- */
        #update-log-modal .modal-window {
            max-width: 380px;
            text-align: left;
        }

        #update-log-modal-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px 15px;
            margin: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 8px;
        }

        #update-log-modal-content h4 {
            font-size: 16px;
            color: var(--primary-color);
            margin-top: 10px;
            margin-bottom: 8px;
        }

        #update-log-modal-content ul {
            list-style-type: none;
            padding-left: 5px;
            margin: 0;
        }

        #update-log-modal-content li {
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 14px;
            color: #555;
            position: relative;
            padding-left: 20px;
        }

        #update-log-modal-content li::before {
            content: '✨';
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--accent-color);
        }

        /* --- NovelAI 相关样式 (v2 - UI对齐修复) --- */

        /* API 设置页面的开关样式 (与您现有的 time-perception-switch 样式对齐) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            flex-shrink: 0; /* 防止被压缩 */
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .slider {
            background-color: var(--primary-color);
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* API Key 输入框的显隐按钮 */
        #novelai-key-toggle {
            position: absolute;
            right: 12px; /* 调整位置以匹配 form-group 的 padding */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
            font-size: 18px;
            color: #888;
            z-index: 2; /* 确保在输入框之上 */
        }

        /* * 弹窗 UI 结构修复：
         * 移除 .modal-header, .modal-body, .modal-footer 的特定样式
         * 弹窗内容现在直接放在 .modal-window 中
        */

        /* 弹窗内的复选框和标签 */
        .nai-modal-content .form-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .nai-modal-content .form-group small {
            font-size: 12px;
            color: #666;
            display: block;
            margin-top: 5px;
        }

        /* 弹窗内的关闭按钮 (匹配 index.html 弹窗的关闭按钮) */
        .nai-modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
            z-index: 10;
        }
        .nai-modal-close-btn:hover {
            color: #333;
        }

        /* 弹窗内容滚动区域 */
        .nai-modal-scrollable-content {
            max-height: 65vh; /* 限制内容最大高度 */
            overflow-y: auto; /* 超出时滚动 */
            padding: 15px 5px 0 5px; /* 顶部留出空间，左右微调 */
            margin: 0 -5px; /* 抵消内边距，使滚动条贴边 */
        }

        /* 测试弹窗图片预览 */
        #nai-result-image {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: contain;
        }

        /* 角色/群聊设置侧边栏单选按钮 */
        #nai-character-settings-group input[type="radio"],
        #group-nai-settings-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
            vertical-align: middle;
        }
        #nai-character-settings-group label,
        #group-nai-settings-group label {
            margin-bottom: 0;
        }

        /* --- NovelAI 修复 (v3) --- */

        /* 修复：确保从侧边栏打开的弹窗层级高于侧边栏 (z-index: 101) */
        #character-nai-prompts-modal {
            z-index: 102;
        }

        /* 修复：设置弹窗中的复选框布局 */
        .nai-settings-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 0;
        }
        .nai-settings-checkbox-group label {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0;
        }
        .nai-settings-checkbox-group .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin-top: 5px;
        }
        .nai-settings-checkbox-group .checkbox-container span {
            font-size: 14px;
            color: #333;
        }
        .nai-settings-checkbox-group .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }
    </style>

<script>
    async function updateBatteryStatus() {
        // 首先检查浏览器是否支持电池API
        if ('getBattery' in navigator) {
            try {
                // 异步获取电池状态管理器
                const battery = await navigator.getBattery();        // 获取相关的HTML元素
            const batteryLevelText = document.getElementById('battery-level');
            const batteryFillRect = document.getElementById('battery-fill-rect');
    
            // 创建一个内部函数，用于更新显示
            const updateDisplay = () => {
                if (!batteryLevelText || !batteryFillRect) return;
    
                // 计算电量百分比
                const level = Math.floor(battery.level * 100);
                batteryLevelText.textContent = `${level}%`;
    
                // 根据电量更新SVG内部填充条的宽度
                // SVG内部填充区域总宽度是18，所以用电量百分比去乘以它
                batteryFillRect.setAttribute('width', 18 * battery.level);
    
                // 根据电量和充电状态改变颜色，更有细节感
                let fillColor = "#666"; // 默认颜色
                if (battery.charging) {
                    fillColor = "#4CAF50"; // 充电时显示绿色
                } else if (level <= 20) {
                    fillColor = "#f44336"; // 低电量时显示红色
                }
                batteryFillRect.setAttribute('fill', fillColor);
            };
    
            // 第一次加载时，立即更新一次
            updateDisplay();
    
            // 添加事件监听器，当电量变化或充电状态变化时，自动更新
            battery.addEventListener('levelchange', updateDisplay);
            battery.addEventListener('chargingchange', updateDisplay);
    
        } catch (error) {
            console.error('无法获取电池信息:', error);
            // 如果获取失败，就隐藏电池小部件
            const batteryWidget = document.querySelector('.widget-battery');
            if (batteryWidget) batteryWidget.style.display = 'none';
        }
    } else {
        console.log('您的浏览器不支持电池状态API。');
        // 如果浏览器不支持，也隐藏电池小部件
        const batteryWidget = document.querySelector('.widget-battery');
        if (batteryWidget) batteryWidget.style.display = 'none';
    }
    }
    
    
    // gemini如果是多个密钥, 那么随机获取一个
    function getRandomValue(str) {
        // 检查字符串是否包含逗号
        if (str.includes(',')) {
            // 用逗号分隔字符串并移除多余空格
            const arr = str.split(',').map(item => item.trim());
            // 生成随机索引 (0 到 arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // 返回随机元素
            return arr[randomIndex];
        }
        // 没有逗号则直接返回原字符串
        return str;
    }

    document.addEventListener('DOMContentLoaded', () => {
        async function compressImage(file, options = {}) {
            const {
                quality = 0.8, maxWidth = 800, maxHeight = 800
            } = options;

            // --- 新增：处理GIF动图 ---
            // 如果文件是GIF，则不经过canvas压缩，直接返回原始文件数据以保留动画
            if (file.type === 'image/gif') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // --- 对其他静态图片（如PNG, JPG）进行压缩 ---
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = reject;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // 对于有透明背景的PNG图片，先填充一个白色背景
                        // 这样可以防止透明区域在转换成JPEG时变黑
                        if (file.type === 'image/png') {
                            ctx.fillStyle = '#FFFFFF'; // 白色背景
                            ctx.fillRect(0, 0, width, height);
                        }

                        ctx.drawImage(img, 0, 0, width, height);

                        // --- 关键修正：将输出格式改为 'image/jpeg' ---
                        // JPEG格式可以显著减小文件大小，避免浏览器处理超大Base64字符串时崩溃
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                };
            });
        }

        // --- Initial HTML Injection ---
        document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">API 设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API 服务商</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select></div><div class="form-group"><label for="api-url">API 地址（后缀不用添加/v1）</label><input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">选择模型</label><select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select></div><div class.blade.php="form-group" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #fce4ec; border-radius: 10px; background-color: #fff8fa;">
    <label for="time-perception-switch" style="margin-bottom: 0; color: var(--secondary-color); font-weight: 600;">时间感知加强</label>
    <input type="checkbox" id="time-perception-switch" style="width: auto; height: 20px; width: 20px;">
</div>
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
    <div style="flex-grow: 1;">
        <label for="novelai-switch" style="margin-bottom: 0; display: block; color: var(--secondary-color); font-weight: 600;">
            启用 NovelAI 图像生成
        </label>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px; margin-bottom: 5px;">
            开启后可使用NovelAI官方API生成高质量动漫风格图像（必开🔮）
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px; margin-bottom: 5px;">
            1. 三击下载图片，下面可测试模型或关键词画师串
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px; margin-bottom: 5px;">
            2. 429是novel的访问频繁错误，等待几秒重新即可
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px; margin-bottom: 5px;">
            3. 403是多人共号限制，限制oplus免费出小图但可扣点数
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px; margin-bottom: 5px;">
            4. 403也会因为没开🔮报错，实在不行可更换出图尺寸
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px; margin-bottom: 0;">
            5. 401是key没权限，检查key是否正确
        </p>
    </div>
    <label class="toggle-switch" style="margin-top: 5px;">
        <input type="checkbox" id="novelai-switch">
        <span class="slider"></span>
    </label>
</div>

<div id="novelai-details" style="display: none;">
    <div class="form-group">
        <label for="novelai-model">NovelAI 模型</label>
        <select id="novelai-model" name="novelai_model" class="form-group">
            <option value="nai-diffusion-4-curated-preview">NAI Diffusion V4.5 Curated (精选版无nsfw)</option>
            <option value="nai-diffusion-4-5-full">NAI Diffusion V4.5 Full（完整版含nsfw）</option>
            <option value="nai-diffusion-3">NAI Diffusion Anime V3（旧版）</option>
            <option value="nai-diffusion-furry-3">NAI Diffusion Furry V3（旧旧版）</option>
        </select>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            💡 必须有oplus订阅的apikey才可以使用！
        </p>
    </div>

    <div class="form-group">
        <label for="novelai-api-key">NovelAI API Key</label>
        <div class="form-group" style="position: relative; margin-bottom: 0;">
            <input type="password" id="novelai-api-key" name="novelai_api_key" placeholder="pst-xxxxxxxxxxxxxxxx" style="padding-right: 40px;">
            <span id="novelai-key-toggle">🧐</span>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            💡 在 <a href="https://novelai.net" target="_blank" style="color: var(--primary-color);">NovelAI官网</a> 获取API Key
        </p>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 15px; align-items: flex-end; margin-bottom: 15px;">
        <button type="button" id="novelai-settings-btn" class="btn btn-neutral" style="flex: 1; height: 44px; display: flex; align-items: center; justify-content: center; margin-bottom: 0;">
            ⚙️ 生成设置
        </button>
        <button type="button" id="novelai-test-btn" class="btn btn-secondary" style="flex: 1; height: 44px; display: flex; align-items: center; justify-content: center; margin-bottom: 0;">
            🧪 测试生成
        </button>
    </div>
</div>
<button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button></form><div class="api-presets-embedded" style="margin-top:12px;"><div id="api-presets-control" style="margin:12px 0;padding:12px;border-radius:8px;border:1px solid var(--border-color, #eee);background:var(--panel-bg, #fff);box-shadow:var(--panel-shadow, none);"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><label style="min-width:86px;color:var(--muted,#666);">API 预设：</label><select id="api-preset-select" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;"><option value="">— 选择 API 预设 —</option></select><button id="api-apply-preset" class="btn btn-primary" style="margin-left:8px;padding:6px 10px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;"><button id="api-save-preset" class="btn" style="padding:6px 10px;">另存为</button><button id="api-manage-presets" class="btn" style="padding:6px 10px;">管理</button><div style="flex:1"></div><button id="api-import-presets" class="btn" style="padding:6px 10px;">导入</button><button id="api-export-presets" class="btn" style="padding:6px 10px;">导出</button></div></div><div id="api-presets-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;"><div style="width:640px;max-width:94%;background:var(--panel-bg,#fff);padding:16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);"><h3 style="margin:0 0 12px 0;">API 预设管理</h3><div id="api-presets-list" style="max-height:360px;overflow:auto;border:1px solid #f0f0f0;padding:8px;border-radius:6px;"></div><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;"><button id="api-close-modal" class="btn btn-primary">关闭</button></div></div></div></div></main>`;
        document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">更换壁纸</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label></main>`;
        document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;
        document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">主屏幕自定义</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;
        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

        // --- Global Variables and Constants ---
        const colorThemes = {
            'white_pink': {
                name: '白/粉',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(255,204,204,0.9)', text: '#A56767'}
            },
            'white_blue': {
                name: '白/蓝',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
            },
            'white_yellow': {
                name: '白/黄',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B'}
            },
            'white_green': {
                name: '白/绿',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(188,238,188,0.9)', text: '#4F784F'}
            },
            'white_purple': {
                name: '白/紫',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B'}
            },
            'black_red': {
                name: '黑/红',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgb(226,62,87,0.9)', text: '#fff'}
            },
            'black_green': {
                name: '黑/绿',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E'}
            },
            'black_white': {
                name: '黑/白',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgba(245,245,245,0.9)', text: '#333'}
            },
            'white_black': {
                name: '白/黑',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5'}
            },
            'yellow_purple': {
                name: '黄/紫',
                received: {bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B'},
                sent: {bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B'}
            },
            'pink_blue': {
                name: '粉/蓝',
                received: {bg: 'rgba(255,231,240,0.9)', text: '#7C6770'},
                sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
            },
        };
        const defaultWidgetSettings = {
            centralCircleImage: 'https://i.postimg.cc/mD83gR29/avatar-1.jpg',
            topLeft: { emoji: '🎧', text: '𝑀𝑒𝑚𝑜𝑟𝑖𝑒𝑠✞' },
            topRight: { emoji: '🐈‍⬛', text: '𐙚 ♰.𝐾𝑖𝑡𝑡𝑒𝑛.♰' },
            bottomLeft: { emoji: '💿', text: '᪗₊𝔹𝕒𝕓𝕖𝕚𝕤₊' },
            bottomRight: { emoji: '🥛', text: '.☘︎ ˖+×+.' }
        };
               const defaultIcons = {
            'chat-list-screen': {name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png'},
            'api-settings-screen': {name: 'api', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png'},
            'wallpaper-screen': {name: '壁纸', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png'},
            'world-book-screen': {name: '世界书', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png'},
            'customize-screen': {name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png'},
            'font-settings-screen': {name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png'},
            'tutorial-screen': {name: '教程', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png'},
            'day-mode-btn': {name: '白昼模式', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png'},
            'night-mode-btn': {name: '夜间模式', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png'},
            'forum-screen': {name: '论坛', url: 'https://i.postimg.cc/fyPVBZf1/1758451183605.png'},
            'music-screen': {name: '音乐', url: 'https://i.postimg.cc/ydd65txK/1758451018266.png'},
            'diary-screen': {name: '日记本', url: 'https://i.postimg.cc/bJBLzmFH/chan-70.png'},
            'piggy-bank-screen': {name: '存钱罐', url: 'https://i.postimg.cc/3RmWRRtS/chan-18.png'},
            'pomodoro-screen': {name: '番茄钟', url: 'https://i.postimg.cc/PrYGRDPF/chan-76.png'},
            'storage-analysis-screen': {name: '存储分析', url: 'https://i.postimg.cc/J0F3Lt0T/chan-107.png'}
        };


        const peekScreenApps = {
            'messages': { name: '消息', url: 'https://i.postimg.cc/Kvs4tDh5/export202509181826424260.png' },
            'memos': { name: '备忘录', url: 'https://i.postimg.cc/JzD0xH1C/export202509181829064550.png' },
            'cart': { name: '购物车', url: 'https://i.postimg.cc/pLwT6VTh/export202509181830143960.png' },
            'transfer': { name: '中转站', url: 'https://i.postimg.cc/63wQBHCB/export202509181831140230.png' },
            'browser': { name: '浏览器', url: 'https://i.postimg.cc/SKcsF02Z/export202509181830445980.png' },
            'drafts': { name: '草稿箱', url: 'https://i.postimg.cc/ZKqC9D2R/export202509181827225860.png' },
            'album': { name: '相册', url: 'https://i.postimg.cc/qBcdpqNc/export202509221549335970.png' },
            'steps': { name: '步数', url: 'https://i.postimg.cc/5NndFrq6/export202509181824532800.png' },
            'unlock': { name: 'unlock！', url: 'https://i.postimg.cc/28zNyYWs/export202509221542593320.png' }
        };

        const simulatedMemos = [];

        const globalSettingKeys = [
            'apiSettings', 'wallpaper', 'homeScreenMode', 'fontUrl', 'customIcons', 'stickerCategories',
            'apiPresets', 'bubbleCssPresets', 'myPersonaPresets', 'globalCss',
            'globalCssPresets', 'homeSignature', 'forumPosts', 'forumBindings', 'pomodoroTasks', 'pomodoroSettings', 'insWidgetSettings', 'homeWidgetSettings'
        ];
        const appVersion = "1.2.0"; // Current app version
        const updateLog = [
            {
                version: "1.2.0",
                date: "2025-10-15",
                notes: [
                    "新增：猫箱图床 (Catbox) 渲染机制，在当前绑定的表情包世界书中包含 'catbox' 关键词即可切换到猫箱模式，注意！iposting图床表情包和猫箱表情包不可同时渲染，只能选择一方。如：绑定了猫箱表情包世界书，就无法渲染过往iposting图床的表情包，不绑定则反之。",
                    "新增：世界书批量删除功能，长按条目即可进入多选删除模式，支持分类全选。",
                ]
            },
            {
                version: "1.1.0",
                date: "2025-10-13",
                notes: [
                    "重要！！已更换存储方式，请尽快导出原网址的备份并清理浏览器内该网址的数据，并重新在此网址导入备份",
                    "新增：番茄钟，可以创建专注任务并绑定char和自己的人设预设（仅可从预设中选择），在列表中左滑删除任务。专注期间想摸鱼了可以戳一戳头像，ta会对你做出回复。每个专注界面的设置键可以自定义鼓励频率和限制自己戳一戳的次数，超过次数则ta不会再理你，请补药偷懒，努力专注吧！",
                    "新增：两个桌面小组件，现所有小组件都可以通过点击来自定义图片和文字",
                    "优化：修复了存储膨胀的问题，现为测试阶段不确定是否有bug，请勤备份！唯有备份才是安全的！",
                    "优化：修复了一些使用体验上的小问题",
                    "画饼（未来可能会做的）：1.第二页的布局美化 2.日记本、存钱罐、音乐",
                ]
            }
        ];
        let db = {
            characters: [],
            groups: [],
            apiSettings: {},
            wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
            myStickers: [],
            homeScreenMode: 'night',
            worldBooks: [],
            fontUrl: '',
            customIcons: {},
            apiPresets: [],
            bubbleCssPresets: [],
            myPersonaPresets: [],
            forumPosts: [],
            globalCss: '',
            globalCssPresets: [],
            homeSignature: '编辑个性签名...',
            forumBindings: {
                worldBookIds: [],
                charIds: [],
                userPersonaIds: []
            },
            pomodoroTasks: [],
            pomodoroSettings: {
                boundCharId: null,
                userPersona: '',
                focusBackground: '',
                taskCardBackground: '',
                encouragementMinutes: 25,
                pokeLimit: 5,
                globalWorldBookIds: [] // NEW: For global settings
            },
            insWidgetSettings: {
                avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                bubble1: 'love u.',
                avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                bubble2: 'miss u.'
            },
        };
        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null,
            isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null,
            currentEditingWorldBookId = null, currentStickerActionTarget = null,
            currentJournalDetailId = null,
            currentQuoteInfo = null, // 新增：用于存储引用信息
            currentGroupAction = {type: null, recipients: []};
        let currentPomodoroTask = null, pomodoroInterval = null, pomodoroRemainingSeconds = 0, pomodoroCurrentSessionSeconds = 0, isPomodoroPaused = true, pomodoroPokeCount = 0, pomodoroIsInterrupted = false, currentPomodoroSettingsContext = null, pomodoroSessionHistory = [];
        let isStickerManageMode = false;
        let selectedStickerIds = new Set();
        let isWorldBookMultiSelectMode = false;
        let selectedWorldBookIds = new Set();
        let peekContentCache = {};
        let generatingPeekApps = new Set(); // Tracks which apps are currently generating content
        let selectedMessageIds = new Set();
        const MESSAGES_PER_PAGE = 50;

        // --- DOM Element Cache ---
        const screens = document.querySelectorAll('.screen'),
            toastElement = document.getElementById('toast-notification'),
            homeScreen = document.getElementById('home-screen'),
            chatListContainer = document.getElementById('chat-list-container'),
            noChatsPlaceholder = document.getElementById('no-chats-placeholder'),
            addChatBtn = document.getElementById('add-chat-btn'),
            addCharModal = document.getElementById('add-char-modal'),
            addCharForm = document.getElementById('add-char-form'),
            chatRoomScreen = document.getElementById('chat-room-screen'),
            chatRoomHeaderDefault = document.getElementById('chat-room-header-default'),
            chatRoomHeaderSelect = document.getElementById('chat-room-header-select'),
            cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'),
            multiSelectTitle = document.getElementById('multi-select-title'),
            chatRoomTitle = document.getElementById('chat-room-title'),
            chatRoomStatusText = document.getElementById('chat-room-status-text'),
            messageArea = document.getElementById('message-area'),
            messageInputDefault = document.getElementById('message-input-default'),
            messageInput = document.getElementById('message-input'),
            sendMessageBtn = document.getElementById('send-message-btn'),
            getReplyBtn = document.getElementById('get-reply-btn'),
            typingIndicator = document.getElementById('typing-indicator'),
            chatSettingsBtn = document.getElementById('chat-settings-btn'),
            settingsSidebar = document.getElementById('chat-settings-sidebar'),
            settingsForm = document.getElementById('chat-settings-form'),
            multiSelectBar = document.getElementById('multi-select-bar'),
            selectCount = document.getElementById('select-count'),
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const regenerateBtn = document.getElementById('regenerate-btn'),
            stickerToggleBtn = document.getElementById('sticker-toggle-btn'),
            stickerModal = document.getElementById('sticker-modal'),
            stickerGridContainer = document.getElementById('sticker-grid-container'),
            addNewStickerBtn = document.getElementById('add-new-sticker-btn'),
            addStickerModal = document.getElementById('add-sticker-modal'),
            addStickerModalTitle = document.getElementById('add-sticker-modal-title'),
            addStickerForm = document.getElementById('add-sticker-form'),
            stickerEditIdInput = document.getElementById('sticker-edit-id'),
            stickerPreview = document.getElementById('sticker-preview'),
            stickerNameInput = document.getElementById('sticker-name'),
            stickerUrlInput = document.getElementById('sticker-url-input'),
            stickerFileUpload = document.getElementById('sticker-file-upload');
        const stickerActionSheet = document.getElementById('sticker-actionsheet'),
            editStickerBtn = document.getElementById('edit-sticker-btn'),
            deleteStickerBtn = document.getElementById('delete-sticker-btn');
        const voiceMessageBtn = document.getElementById('voice-message-btn'),
            sendVoiceModal = document.getElementById('send-voice-modal'),
            sendVoiceForm = document.getElementById('send-voice-form'),
            voiceTextInput = document.getElementById('voice-text-input'),
            voiceDurationPreview = document.getElementById('voice-duration-preview');
        const photoVideoBtn = document.getElementById('photo-video-btn'),
            sendPvModal = document.getElementById('send-pv-modal'),
            sendPvForm = document.getElementById('send-pv-form'),
            pvTextInput = document.getElementById('pv-text-input');
        const imageRecognitionBtn = document.getElementById('image-recognition-btn'),
            imageUploadInput = document.getElementById('image-upload-input');
        const walletBtn = document.getElementById('wallet-btn'),
            sendTransferModal = document.getElementById('send-transfer-modal'),
            sendTransferForm = document.getElementById('send-transfer-form'),
            transferAmountInput = document.getElementById('transfer-amount-input'),
            transferRemarkInput = document.getElementById('transfer-remark-input');
        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'),
            acceptTransferBtn = document.getElementById('accept-transfer-btn'),
            returnTransferBtn = document.getElementById('return-transfer-btn');
        const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'),
            sendGiftForm = document.getElementById('send-gift-form'),
            giftDescriptionInput = document.getElementById('gift-description-input');
        const timeSkipBtn = document.getElementById('time-skip-btn'),
            timeSkipModal = document.getElementById('time-skip-modal'),
            timeSkipForm = document.getElementById('time-skip-form'),
            timeSkipInput = document.getElementById('time-skip-input');
        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
        const worldBookListContainer = document.getElementById('world-book-list-container'),
            noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'),
            addWorldBookBtn = document.getElementById('add-world-book-btn'),
            editWorldBookScreen = document.getElementById('edit-world-book-screen'),
            editWorldBookForm = document.getElementById('edit-world-book-form'),
            worldBookIdInput = document.getElementById('world-book-id'),
            worldBookNameInput = document.getElementById('world-book-name'),
            worldBookContentInput = document.getElementById('world-book-content');
        const linkWorldBookBtn = document.getElementById('link-world-book-btn'),
            worldBookSelectionModal = document.getElementById('world-book-selection-modal'),
            worldBookSelectionList = document.getElementById('world-book-selection-list'),
            saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
        const fontSettingsForm = document.getElementById('font-settings-form'),
            fontUrlInput = document.getElementById('font-url'),
            restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
        const createGroupBtn = document.getElementById('create-group-btn'),
            createGroupModal = document.getElementById('create-group-modal'),
            createGroupForm = document.getElementById('create-group-form'),
            memberSelectionList = document.getElementById('member-selection-list'),
            groupNameInput = document.getElementById('group-name-input'),
            groupSettingsSidebar = document.getElementById('group-settings-sidebar'),
            groupSettingsForm = document.getElementById('group-settings-form'),
            groupMembersListContainer = document.getElementById('group-members-list-container'),
            editGroupMemberModal = document.getElementById('edit-group-member-modal'),
            editGroupMemberForm = document.getElementById('edit-group-member-form');
        const addMemberActionSheet = document.getElementById('add-member-actionsheet'),
            inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'),
            createNewMemberBtn = document.getElementById('create-new-member-btn'),
            inviteMemberModal = document.getElementById('invite-member-modal'),
            inviteMemberSelectionList = document.getElementById('invite-member-selection-list'),
            confirmInviteBtn = document.getElementById('confirm-invite-btn'),
            createMemberForGroupModal = document.getElementById('create-member-for-group-modal'),
            createMemberForGroupForm = document.getElementById('create-member-for-group-form');
        const customizeForm = document.getElementById('customize-form'),
            tutorialContentArea = document.getElementById('tutorial-content-area');
        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'),
            groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'),
            confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'),
            groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');
        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');

        // --- Dexie DB Setup ---
        const dexieDB = new Dexie('章鱼喷墨机DB_ee');
        dexieDB.version(1).stores({
            storage: 'key, value'
        });
        dexieDB.version(2).stores({
            characters: '&id',
            groups: '&id',
            worldBooks: '&id',
            myStickers: '&id, category',
            globalSettings: 'key'
        }).upgrade(async tx => {
            console.log("Upgrading database to version 2...");
            const oldData = await tx.table('storage').get('章鱼喷墨机');
            if (oldData && oldData.value) {
                console.log("Old data found, starting migration.");
                const data = JSON.parse(oldData.value);
                if (data.characters) await tx.table('characters').bulkPut(data.characters);
                if (data.groups) await tx.table('groups').bulkPut(data.groups);
                if (data.worldBooks) await tx.table('worldBooks').bulkPut(data.worldBooks);
                if (data.myStickers) await tx.table('myStickers').bulkPut(data.myStickers);
                
                const settingsToMigrate = {
                    apiSettings: data.apiSettings || {},
                    wallpaper: data.wallpaper || 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                    homeScreenMode: data.homeScreenMode || 'night',
                    fontUrl: data.fontUrl || '',
                    customIcons: data.customIcons || {},
                    apiPresets: data.apiPresets || [],
                    bubbleCssPresets: data.bubbleCssPresets || [],
                    myPersonaPresets: data.myPersonaPresets || [],
                    globalCss: data.globalCss || '',
                    globalCssPresets: data.globalCssPresets || [],
                    homeSignature: data.homeSignature || '编辑个性签名...',
                    forumPosts: data.forumPosts || [],
                    forumBindings: data.forumBindings || { worldBookIds: [], charIds: [], userPersonaIds: [] },
                    pomodoroTasks: data.pomodoroTasks || [],
                    pomodoroSettings: data.pomodoroSettings || { boundCharId: null, userPersona: '', focusBackground: '', taskCardBackground: '', encouragementMinutes: 25, pokeLimit: 5, globalWorldBookIds: [] },
                    insWidgetSettings: data.insWidgetSettings || { avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', bubble1: 'love u.', avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', bubble2: 'miss u.' },
                    homeWidgetSettings: data.homeWidgetSettings || defaultWidgetSettings
                };

                const settingsPromises = Object.entries(settingsToMigrate).map(([key, value]) =>
                    tx.table('globalSettings').put({ key, value })
                );
                await Promise.all(settingsPromises);
                
                await tx.table('storage').delete('章鱼喷墨机');
                console.log("Migration complete. Old data removed.");
            } else {
                console.log("No old data found to migrate.");
            }
        });

        const saveData = async () => {
            await dexieDB.transaction('rw', dexieDB.tables, async () => {
                await dexieDB.characters.bulkPut(db.characters);
                await dexieDB.groups.bulkPut(db.groups);
                await dexieDB.worldBooks.bulkPut(db.worldBooks);
                await dexieDB.myStickers.bulkPut(db.myStickers);

                const settingsPromises = globalSettingKeys.map(key => {
                    if (db[key] !== undefined) {
                        return dexieDB.globalSettings.put({ key: key, value: db[key] });
                    }
                    return null;
                }).filter(p => p);
                await Promise.all(settingsPromises);
            });
        };

        const loadData = async () => {
            const [characters, groups, worldBooks, myStickers, settingsArray] = await Promise.all([
                dexieDB.characters.toArray(),
                dexieDB.groups.toArray(),
                dexieDB.worldBooks.toArray(),
                dexieDB.myStickers.toArray(),
                dexieDB.globalSettings.toArray()
            ]);

            db.characters = characters;
            db.groups = groups;
            db.worldBooks = worldBooks;
            db.myStickers = myStickers;

            const settings = settingsArray.reduce((acc, { key, value }) => {
                acc[key] = value;
                return acc;
            }, {});

            globalSettingKeys.forEach(key => {
                const defaultValue = {
                    apiSettings: {},
                    wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                    homeScreenMode: 'night',
                    fontUrl: '',
                    customIcons: {},
                    stickerCategories: ['全部', '未分类'],
                    apiPresets: [],
                    bubbleCssPresets: [],
                    myPersonaPresets: [],
                    globalCss: '',
                    globalCssPresets: [],
                    homeSignature: '编辑个性签名...',
                    forumBindings: { worldBookIds: [], charIds: [], userPersonaIds: [] },
                    pomodoroTasks: [],
                    pomodoroSettings: { boundCharId: null, userPersona: '', focusBackground: '', taskCardBackground: '', encouragementMinutes: 25, pokeLimit: 5, globalWorldBookIds: [] },
                    insWidgetSettings: { avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', bubble1: 'love u.', avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', bubble2: 'miss u.' },
                    homeWidgetSettings: defaultWidgetSettings
                };
                db[key] = settings[key] !== undefined ? settings[key] : (defaultValue[key] !== undefined ? JSON.parse(JSON.stringify(defaultValue[key])) : undefined);
            });

            // Data integrity checks (can be kept)
            db.characters.forEach(c => {
                if (c.isPinned === undefined) c.isPinned = false;
                if (c.status === undefined) c.status = '在线';
                if (!c.worldBookIds) c.worldBookIds = [];
                if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
            });
            db.groups.forEach(g => {
                if (g.isPinned === undefined) g.isPinned = false;
                if (!g.worldBookIds) g.worldBookIds = [];
                if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
            });
            
            // Handle old localStorage data if it exists
            const oldLocalStorageData = localStorage.getItem('gemini-chat-app-db');
            if(oldLocalStorageData) {
                console.log("Found old localStorage data, migrating...");
                // This is a simplified migration, assuming the structure is the same as the old IndexedDB data
                const data = JSON.parse(oldLocalStorageData);
                await dexieDB.transaction('rw', dexieDB.tables, async () => {
                    if (data.characters) await dexieDB.characters.bulkPut(data.characters);
                    if (data.groups) await dexieDB.groups.bulkPut(data.groups);
                    // ... add other tables as needed
                });
                localStorage.removeItem('gemini-chat-app-db');
                // Reload data after migration
                await loadData();
            }
        };

        let notificationQueue = [];
        let isToastVisible = false;

        function processToastQueue() {
            if (isToastVisible || notificationQueue.length === 0) {
                return;
            }

        isToastVisible = true;
        const notification = notificationQueue.shift(); // 取出队列中的第一个通知

        const toastElement = document.getElementById('toast-notification');
        const avatarEl = toastElement.querySelector('.toast-avatar');
        const nameEl = toastElement.querySelector('.toast-name');
        const messageEl = toastElement.querySelector('.toast-message');

        const isRichNotification = typeof notification === 'object' && notification !== null && notification.name;

        if (isRichNotification) {
            toastElement.classList.remove('simple');
            avatarEl.style.display = 'block';
            nameEl.style.display = 'block';
            messageEl.style.textAlign = 'left';
            avatarEl.src = notification.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            nameEl.textContent = notification.name;
            messageEl.textContent = notification.message;
        } else {
            toastElement.classList.add('simple');
            avatarEl.style.display = 'none';
            nameEl.style.display = 'none';
            messageEl.style.textAlign = 'center';
            messageEl.textContent = notification;
        }

        toastElement.classList.add('show');

        // 设置定时器，在通知显示一段时间后将其隐藏
        setTimeout(() => {
            toastElement.classList.remove('show');
            
            // 等待隐藏动画（0.5秒）结束后，处理下一个通知
            setTimeout(() => {
                isToastVisible = false;
                processToastQueue(); // 尝试处理队列中的下一个通知
            }, 500);

        }, 1500); // 通知显示时间（1.5秒）
    }
    const showToast = (notification) => {
        notificationQueue.push(notification); // 将通知加入队列
        processToastQueue(); // 尝试处理队列
    };



        const switchScreen = (targetId) => {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');
            // Close all overlays and sidebars
            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
            overlays.forEach(o => o.classList.remove('visible', 'open'));
        };
        const pad = (num) => num.toString().padStart(2, '0');

        function createContextMenu(items, x, y) {
            removeContextMenu();
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                if (item.danger) menuItem.classList.add('danger');
                menuItem.textContent = item.label;
                menuItem.onclick = () => {
                    item.action();
                    removeContextMenu();
                };
                menu.appendChild(menuItem);
            });
            document.body.appendChild(menu);
            document.addEventListener('click', removeContextMenu, {once: true});
        }

        function removeContextMenu() {
            const menu = document.querySelector('.context-menu');
            if (menu) menu.remove();
        }

        function updateCustomBubbleStyle(chatId, css, enabled) {
            const styleId = `custom-bubble-style-for-${chatId}`;
            let styleElement = document.getElementById(styleId);

            if (enabled && css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);
                styleElement.innerHTML = scopedCss;
            } else {
                if (styleElement) styleElement.remove();
            }
        }

        function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {
            previewContainer.innerHTML = '';

            const sentBubble = document.createElement('div');
            sentBubble.className = 'message-bubble sent';
            sentBubble.textContent = '这是我方气泡。';
            sentBubble.style.alignSelf = 'flex-end';
            sentBubble.style.borderBottomRightRadius = '5px';

            const receivedBubble = document.createElement('div');
            receivedBubble.className = 'message-bubble received';
            receivedBubble.textContent = '这是对方气泡。';
            receivedBubble.style.alignSelf = 'flex-start';
            receivedBubble.style.borderBottomLeftRadius = '5px';

            [sentBubble, receivedBubble].forEach(bubble => {
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '8px 12px';
                bubble.style.wordWrap = 'break-word';
                bubble.style.lineHeight = '1.4';
            });

            if (useDefault || !css) {
                sentBubble.style.backgroundColor = theme.sent.bg;
                sentBubble.style.color = theme.sent.text;
                sentBubble.style.borderRadius = '18px';
                sentBubble.style.borderBottomRightRadius = '5px';
                receivedBubble.style.backgroundColor = theme.received.bg;
                receivedBubble.style.color = theme.received.text;
                receivedBubble.style.borderRadius = '18px';
                receivedBubble.style.borderBottomLeftRadius = '5px';
            } else {
                const styleTag = document.createElement('style');
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
                styleTag.textContent = scopedCss;
                previewContainer.appendChild(styleTag);
            }
            previewContainer.appendChild(receivedBubble);
            previewContainer.appendChild(sentBubble);
        }
        const dataStorage = {
            getStorageInfo: async function() {
                const stringify = (obj) => {
                    try {
                        // Handle potential circular references, although unlikely with Dexie data
                        return JSON.stringify(obj).length;
                    } catch (e) {
                        console.warn("Could not stringify object for size calculation:", obj, e);
                        return 0;
                    }
                };

                let categorizedSizes = {
                    messages: 0,
                    charactersAndGroups: 0,
                    worldAndForum: 0,
                    personalization: 0,
                    apiAndCore: 0,
                    other: 0
                };

                // Ensure db is loaded, this is a safeguard.
                if (!db || !db.characters) {
                    await loadData();
                }

                // 1. Messages (History)
                (db.characters || []).forEach(char => {
                    categorizedSizes.messages += stringify(char.history);
                });
                (db.groups || []).forEach(group => {
                    categorizedSizes.messages += stringify(group.history);
                });

                // 2. Characters and Groups (metadata)
                (db.characters || []).forEach(char => {
                    const charWithoutHistory = { ...char, history: undefined };
                    categorizedSizes.charactersAndGroups += stringify(charWithoutHistory);
                });
                (db.groups || []).forEach(group => {
                    const groupWithoutHistory = { ...group, history: undefined };
                    categorizedSizes.charactersAndGroups += stringify(groupWithoutHistory);
                });

                // 3. World and Forum
                categorizedSizes.worldAndForum += stringify(db.worldBooks);
                categorizedSizes.worldAndForum += stringify(db.forumPosts);
                categorizedSizes.worldAndForum += stringify(db.forumBindings);

                // 4. Personalization
                categorizedSizes.personalization += stringify(db.myStickers);
                categorizedSizes.personalization += stringify(db.wallpaper);
                categorizedSizes.personalization += stringify(db.homeScreenMode);
                categorizedSizes.personalization += stringify(db.fontUrl);
                categorizedSizes.personalization += stringify(db.customIcons);
                categorizedSizes.personalization += stringify(db.bubbleCssPresets);
                categorizedSizes.personalization += stringify(db.myPersonaPresets);
                categorizedSizes.personalization += stringify(db.globalCss);
                categorizedSizes.personalization += stringify(db.globalCssPresets);
                categorizedSizes.personalization += stringify(db.homeSignature);
                categorizedSizes.personalization += stringify(db.pomodoroTasks);
                categorizedSizes.personalization += stringify(db.pomodoroSettings);
                categorizedSizes.personalization += stringify(db.insWidgetSettings);
                categorizedSizes.personalization += stringify(db.homeWidgetSettings);

                // 5. API and Core
                categorizedSizes.apiAndCore += stringify(db.apiSettings);
                categorizedSizes.apiAndCore += stringify(db.apiPresets);

                // Total size
                const totalSize = Object.values(categorizedSizes).reduce((sum, size) => sum + size, 0);

                return {
                    totalSize,
                    categorizedSizes
                };
            }
        };

        function setupStorageAnalysisScreen() {
            const screen = document.getElementById('storage-analysis-screen');
            const chartContainer = document.getElementById('storage-chart-container');
            const detailsList = document.getElementById('storage-details-list');
            let myChart = null;

            // 定义一个共享的颜色调色板
            const colorPalette = ['#ff80ab', '#90caf9', '#a5d6a7', '#fff59d', '#b39ddb', '#ffcc80'];

            const categoryNames = {
                messages: '聊天记录',
                charactersAndGroups: '角色与群组',
                worldAndForum: '世界书与论坛',
                personalization: '个性化设置',
                apiAndCore: '核心与API',
                other: '其他数据'
            };

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            // 修改函数签名，接收颜色数组
            function renderStorageChart(info, colors) {
                if (!myChart) {
                    myChart = echarts.init(chartContainer);
                }

                const chartData = Object.entries(info.categorizedSizes)
                    .map(([key, value]) => ({
                        name: categoryNames[key] || key,
                        value: value
                    }))
                    .filter(item => item.value > 0);

                const option = {
                    // 将颜色数组应用到图表
                    color: colors,
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        show: false // 隐藏图例，因为我们下面有更详细的列表
                    },
                    series: [
                        {
                            name: '存储占比',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: false,
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '20',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: chartData
                        }
                    ]
                };
                myChart.setOption(option);
            }

            // 修改函数签名，接收颜色数组
            function renderStorageDetails(info, colors) {
                detailsList.innerHTML = '';
                const totalSize = info.totalSize;

                const totalSizeEl = document.getElementById('storage-total-size');
                if (totalSizeEl) {
                    totalSizeEl.textContent = formatBytes(totalSize);
                }
        

                const sortedData = Object.entries(info.categorizedSizes)
                    .map(([key, value]) => ({
                        key: key,
                        name: categoryNames[key] || key,
                        value: value
                    }))
                    .sort((a, b) => b.value - a.value);

                // 不再从图表实例获取颜色，直接使用传入的参数
                sortedData.forEach((item, index) => {
                    if (item.value <= 0) return; // 不显示大小为0的项目
                    const percentage = totalSize > 0 ? ((item.value / totalSize) * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];

                    const detailItem = document.createElement('div');
                    detailItem.className = 'storage-detail-item';
                    detailItem.innerHTML = `
                        <div class="storage-color-indicator" style="background-color: ${color};"></div>
                        <div class="storage-detail-info">
                            <span class="storage-detail-name">${item.name}</span>
                            <span class="storage-detail-size">${formatBytes(item.value)}</span>
                        </div>
                        <span class="storage-detail-percentage">${percentage}%</span>
                    `;
                    detailsList.appendChild(detailItem);
                });
            }

            const observer = new MutationObserver(async (mutations) => {
                if (screen.classList.contains('active')) {
                    showToast('正在分析存储空间...');
                    const storageInfo = await dataStorage.getStorageInfo();
                    if (storageInfo) {
                        // 将颜色数组传递给两个函数
                        renderStorageChart(storageInfo, colorPalette);
                        renderStorageDetails(storageInfo, colorPalette);
                    } else {
                        showToast('分析失败');
                    }
                }
            });

            observer.observe(screen, { attributes: true, attributeFilter: ['class'] });
        }

        function renderPomodoroTasks() {
            const taskListContainer = document.getElementById('pomodoro-task-list');
            const placeholder = document.getElementById('pomodoro-no-tasks-placeholder');
            if (!taskListContainer || !placeholder) return;

            taskListContainer.innerHTML = ''; // Clear existing tasks

            if (!db.pomodoroTasks || db.pomodoroTasks.length === 0) {
                placeholder.style.display = 'block';
                taskListContainer.style.display = 'none';
                return;
            }

            placeholder.style.display = 'none';
            taskListContainer.style.display = 'flex';

            db.pomodoroTasks.forEach(task => {
                const wrapper = document.createElement('div');
                wrapper.className = 'task-card-wrapper';
                wrapper.dataset.id = task.id;

                const pomodorosText = task.mode === 'countdown' ? `倒计时模式` : '正计时模式';
                const durationText = task.mode === 'countdown' ? `${task.duration}分钟` : '';

                // 只使用任务自己的背景设置
                const backgroundUrl = task.settings?.taskCardBackground;
                let styleAttr = '';
                let textStyle = '';

                if (backgroundUrl) {
                    styleAttr = `style="background-image: url(${backgroundUrl}); background-size: cover; background-position: center;"`;
                    // 当有背景图时，让文字变白并增加阴影以提高可读性
                    textStyle = `style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"`;
                }

                wrapper.innerHTML = `
                    <div class="task-card" ${styleAttr}>
                        <div class="task-card-info">
                            <h4 class="task-card-title" ${textStyle}>${DOMPurify.sanitize(task.name)}</h4>
                            <p class="task-card-details" ${textStyle}>${pomodorosText} ${durationText}</p>
                        </div>
                        <button class="task-card-start-btn">开始</button>
                    </div>
                    <button class="task-card-delete-btn">删除</button>
                `;
                taskListContainer.appendChild(wrapper);
            });
        }

        function setupPomodoroApp() {
            const createTaskBtn = document.getElementById('pomodoro-create-task-btn');
            const createModal = document.getElementById('pomodoro-create-modal');
            const createForm = document.getElementById('pomodoro-create-form');
            const modeRadios = document.querySelectorAll('input[name="pomodoro-mode"]');
            const durationOptions = document.getElementById('pomodoro-duration-options');
            const durationPills = durationOptions.querySelectorAll('.duration-pill');
            const customDurationInput = document.getElementById('pomodoro-custom-duration-input');

            // Focus Screen elements
            const focusScreen = document.getElementById('pomodoro-focus-screen');
            const focusTitleEl = focusScreen.querySelector('.focus-task-title');
            const focusTimerEl = focusScreen.querySelector('.focus-timer-display');
            const focusModeEl = focusScreen.querySelector('.focus-timer-mode');
            const startBtn = document.getElementById('pomodoro-start-btn');
            const pauseBtn = document.getElementById('pomodoro-pause-btn');
            const giveUpBtn = document.getElementById('pomodoro-giveup-btn');
            const focusAvatar = focusScreen.querySelector('.focus-avatar');
            const focusMessageBubble = focusScreen.querySelector('.focus-message-bubble');

            if (focusAvatar && focusMessageBubble) {
                focusAvatar.addEventListener('click', () => {
                    // "Poke" feature logic
                    if (isPomodoroPaused || !pomodoroInterval || !currentPomodoroTask) return;

                    pomodoroIsInterrupted = true;
                    pomodoroPokeCount++;

                    const pokeLimit = currentPomodoroTask.settings.pokeLimit || 5;

                    if (pomodoroPokeCount > pokeLimit) {
                        showTypewriterMessage(focusMessageBubble.querySelector('p'), '传讯次数已经到达上限啦，请再专心一点吧宝宝^^');
                    } else {
                        getPomodoroAiReply('poke');
                    }
                });
            }


            // --- Timer Core Logic ---
            function updateTimerDisplay() {
                const hours = Math.floor(pomodoroRemainingSeconds / 3600);
                const minutes = Math.floor((pomodoroRemainingSeconds % 3600) / 60);
                const seconds = pomodoroRemainingSeconds % 60;

                if (pomodoroRemainingSeconds >= 3600) {
                    focusTimerEl.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    focusTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }

            function updateTotalFocusedTimeDisplay() {
                const totalMinutes = Math.floor(pomodoroCurrentSessionSeconds / 60);
                const totalTimeEl = document.getElementById('pomodoro-total-focused-time');
                if (totalTimeEl) {
                    totalTimeEl.textContent = `已专注 ${totalMinutes} 分钟`;
                }
            }

            function stopTimer() {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                isPomodoroPaused = true;
                startBtn.style.display = 'inline-flex';
                pauseBtn.style.display = 'none';
            }

            function startTimer() {
                if (pomodoroInterval) return; // Already running

                // NEW: Check for resume from a paused state
                if (isPomodoroPaused && pomodoroCurrentSessionSeconds > 0) {
                    getPomodoroAiReply('resume');
                }

                isPomodoroPaused = false;
                pomodoroIsInterrupted = false; // Also reset this flag on resume
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-flex';

                pomodoroInterval = setInterval(() => {
                    if (currentPomodoroTask.mode === 'countdown') {
                        pomodoroRemainingSeconds--;
                    } else { // stopwatch
                        pomodoroRemainingSeconds++;
                    }
                    pomodoroCurrentSessionSeconds++;
                    updateTimerDisplay();
                    updateTotalFocusedTimeDisplay();

                    // Check for encouragement
                    if (currentPomodoroTask && currentPomodoroTask.settings) {
                        const encouragementMinutes = currentPomodoroTask.settings.encouragementMinutes || 25;
                        if (pomodoroCurrentSessionSeconds > 0 && (pomodoroCurrentSessionSeconds % (encouragementMinutes * 60)) === 0 && !pomodoroIsInterrupted) {
                            getPomodoroAiReply('encouragement');
                        }
                    }

                    if (currentPomodoroTask.mode === 'countdown' && pomodoroRemainingSeconds <= 0) {
                        stopTimer();
                        handlePomodoroCompletion();
                    }
                }, 1000);
            }

            function pauseTimer() {
                pomodoroIsInterrupted = true; // Pausing counts as an interruption
                isPomodoroPaused = true;
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                startBtn.style.display = 'inline-flex';
                pauseBtn.style.display = 'none';
            }

            // --- Event Listeners for Controls ---
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            giveUpBtn.addEventListener('click', () => {
                if (confirm('确定要放弃当前任务吗？')) {
                    stopTimer();
                    currentPomodoroTask = null;
                    switchScreen('pomodoro-screen');
                }
            });

            // Certificate modal listeners
            const certModal = document.getElementById('pomodoro-certificate-modal');
            const forwardCertBtn = document.getElementById('forward-certificate-btn');
            const closeCertBtn = document.getElementById('close-certificate-btn');

            forwardCertBtn.addEventListener('click', async () => {
                const taskName = document.getElementById('cert-task-name').textContent;
                const duration = document.getElementById('cert-duration').textContent;
                const pokeCount = document.getElementById('cert-poke-count').textContent;
                const chat = db.characters.find(c => c.id === currentPomodoroTask.settings.boundCharId);

                if (chat) {
                    const messageContent = `[专注记录] 任务：${taskName}，时长：${duration}，期间与 ${chat.realName} 互动 ${pokeCount} 次。`;
                    const message = {
                        id: `msg_pomodoro_${Date.now()}`,
                        role: 'user',
                        content: messageContent,
                        parts: [{ type: 'text', text: messageContent }],
                        timestamp: Date.now(),
                        senderId: 'user_me'
                    };
                    chat.history.push(message);
                    await saveData();
                    showToast('已转发到聊天框！');
                    renderChatList();
                }
                certModal.classList.remove('visible');
                switchScreen('pomodoro-screen');
            });

            closeCertBtn.addEventListener('click', () => {
                certModal.classList.remove('visible');
                switchScreen('pomodoro-screen');
            });


            function handlePomodoroCompletion() {
                const certModal = document.getElementById('pomodoro-certificate-modal');
                document.getElementById('cert-task-name').textContent = currentPomodoroTask.name;
                const totalMinutes = Math.floor(pomodoroCurrentSessionSeconds / 60);
                document.getElementById('cert-duration').textContent = `${totalMinutes} 分钟`;
                document.getElementById('cert-poke-count').textContent = pomodoroPokeCount;

                // 新增：清空并隐藏对话框
                const focusMessageBubble = document.querySelector('#pomodoro-focus-screen .focus-message-bubble');
                if (focusMessageBubble) {
                    focusMessageBubble.classList.remove('visible');
                    focusMessageBubble.querySelector('p').textContent = '';
                }

                // No longer call AI for completion
                certModal.classList.add('visible');
            }

            function showPomodoroTypingIndicator(element) {
                element.innerHTML = '对方正在输入中<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
            }

            function showTypewriterMessage(element, text) {
                let i = 0;
                element.innerHTML = ''; // Clear previous content
                const typingInterval = setInterval(() => {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, 50);
            }

            async function getPomodoroAiReply(promptType) {
                const focusMessageBubble = document.querySelector('.focus-message-bubble');
                const messageP = focusMessageBubble.querySelector('p');
                const settings = currentPomodoroTask.settings;
                const character = db.characters.find(c => c.id === settings.boundCharId);

                if (!character) {
                    focusMessageBubble.classList.remove('visible');
                    return;
                }

                const userPersonaPreset = db.myPersonaPresets.find(p => p.name === settings.userPersona);
                const userPersona = userPersonaPreset ? userPersonaPreset.persona : '一个普通人';

                let prompt;
                const totalMinutes = Math.floor(pomodoroCurrentSessionSeconds / 60);
                const remainingMinutes = Math.round(pomodoroRemainingSeconds / 60);
                const taskName = currentPomodoroTask.name;

                switch (promptType) {
                    case 'encouragement':
                        if (currentPomodoroTask.mode === 'countdown') {
                            prompt = `你正在扮演[${character.realName}]。用户正在进行专注任务“${taskName}”，已连续专注了[${totalMinutes}]分钟，还剩下大约[${remainingMinutes}]分钟。请根据你的人设、任务内容和剩余时间，以鼓励用户为目的，给用户发送一条文字消息。`;
                        } else { // stopwatch
                            prompt = `你正在扮演[${character.realName}]。用户正在进行专注任务“${taskName}”，已经连续专注了[${totalMinutes}]分钟。请根据你的人设和任务内容，以鼓励用户为目的，给用户发送一条文字消息。`;
                        }
                        break;
                    case 'poke':
                        if (currentPomodoroTask.mode === 'countdown') {
                            prompt = `你正在扮演[${character.realName}]。用户在进行专注任务“${taskName}”时，专注了[${totalMinutes}]分钟（还剩下大约[${remainingMinutes}]分钟），忍不住第${pomodoroPokeCount}次戳了戳你的头像。请根据你的人设、任务内容和剩余时间，给用户回复一条文字消息。`;
                        } else { // stopwatch
                            prompt = `你正在扮演[${character.realName}]。用户在进行专注任务“${taskName}”时，已经连续专注了[${totalMinutes}]分钟，这时忍不住第${pomodoroPokeCount}次戳了戳你的头像。请根据你的人设和任务内容，给用户回复一条文字消息。`;
                        }
                        break;
                    case 'resume':
                        prompt = `你正在扮演[${character.realName}]。用户正在进行专注任务“${taskName}”，刚刚暂停了任务后又重新开始了。请根据你的人设，给用户回复一条文字消息。`;
                        break;
                }

                // NEW: Add session history context
                if (pomodoroSessionHistory && pomodoroSessionHistory.length > 0) {
                    const myName = character.myName || '我';
                    const charName = character.realName || '角色';
                    const historyContext = pomodoroSessionHistory.map(item => {
                        if (item.type === 'user') {
                            return `[${myName}的消息：(执行操作: ${item.content})]`;
                        } else {
                            return `[${charName}的消息：${item.content}]`;
                        }
                    }).join('\n');
                    prompt += `\n\n【本次专注期间的简短互动历史】\n${historyContext}\n\n请基于以上历史，继续你的下一句回应。`;
                }
 
                focusMessageBubble.classList.add('visible');
                showPomodoroTypingIndicator(messageP);

                try {
                    const { url, key, model } = db.apiSettings;
                    if (!url || !key || !model) {
                        messageP.textContent = 'API未配置，无法获取回应。';
                        return;
                    }

                    // --- NEW: Construct system prompt with world books ---
                    const globalWorldBookIds = db.pomodoroSettings?.globalWorldBookIds || [];
                    const globalWorldBooksBefore = globalWorldBookIds
                        .map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before'))
                        .filter(Boolean)
                        .map(wb => wb.content)
                        .join('\n\n');
                    const globalWorldBooksAfter = globalWorldBookIds
                        .map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after'))
                        .filter(Boolean)
                        .map(wb => wb.content)
                        .join('\n\n');

                    let systemPromptContent = `你正在扮演角色。你的名字是${character.realName}。`;
                    if (globalWorldBooksBefore) {
                        systemPromptContent += `\n\n【全局世界观设定】\n${globalWorldBooksBefore}`;
                    }
                    systemPromptContent += `\n\n【你的角色设定】\n人设: ${character.persona}`;
                    if (globalWorldBooksAfter) {
                        systemPromptContent += `\n\n【补充设定】\n${globalWorldBooksAfter}`;
                    }
                    systemPromptContent += `\n\n【我的角色设定】\n我的名字是${character.myName}，人设是：${userPersona}。`;
                    // --- END NEW ---

                    const response = await fetch(`${url}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: 'system', content: systemPromptContent },
                                { role: 'user', content: prompt }
                            ],
                            temperature: 0.8
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API请求失败');
                    }

                    const result = await response.json();
                    const reply = result.choices[0].message.content;

                    // NEW: Add user action and AI reply to session history
                    pomodoroSessionHistory.push({ type: 'user', content: promptType });
                    pomodoroSessionHistory.push({ type: 'ai', content: reply });
                    // Keep history short, e.g., last 4 pairs
                    if (pomodoroSessionHistory.length > 8) {
                        pomodoroSessionHistory.splice(0, 2);
                    }

                    showTypewriterMessage(messageP, reply);
 
                    // If the reply was for a 'poke', start a timer to reset the interruption flag.
                    if (promptType === 'poke') {
                        setTimeout(() => {
                            pomodoroIsInterrupted = false;
                        }, 10000); // 10 seconds
                    }

                } catch (error) {
                    console.error('获取AI回应失败:', error);
                    messageP.textContent = '获取回应失败，请检查网络或API设置。';
                }
            }


            // Show create task modal
            if (createTaskBtn) {
                createTaskBtn.addEventListener('click', () => {
                    // Reset form to default state on open
                    createForm.reset();
                    durationOptions.classList.add('visible');
                    durationPills.forEach(p => p.classList.remove('active'));
                    if (durationPills.length > 0) {
                        durationPills[0].classList.add('active');
                    }
                    customDurationInput.style.display = 'none';
                    document.getElementById('mode-countdown').checked = true;
                    document.getElementById('mode-stopwatch').checked = false;

                    createModal.classList.add('visible');
                });
            }

            // Handle mode change (countdown vs stopwatch)
            modeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'countdown') {
                        durationOptions.classList.add('visible');
                    } else {
                        durationOptions.classList.remove('visible');
                    }
                });
            });

            // Handle duration pill selection
            durationPills.forEach(pill => {
                pill.addEventListener('click', () => {
                    durationPills.forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    if (pill.dataset.duration === 'custom') {
                        customDurationInput.style.display = 'block';
                        customDurationInput.focus();
                    } else {
                        customDurationInput.style.display = 'none';
                    }
                });
            });

            // Handle form submission
            if (createForm) {
                createForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const taskName = document.getElementById('pomodoro-task-name').value.trim();
                    if (!taskName) {
                        showToast('请输入任务名称');
                        return;
                    }

                    const mode = document.querySelector('input[name="pomodoro-mode"]:checked').value;
                    let duration = 0;

                    if (mode === 'countdown') {
                        const activePill = durationOptions.querySelector('.duration-pill.active');
                        if (activePill.dataset.duration === 'custom') {
                            duration = parseInt(customDurationInput.value, 10);
                            if (isNaN(duration) || duration <= 0) {
                                showToast('请输入有效的自定义分钟数');
                                return;
                            }
                        } else {
                            duration = parseInt(activePill.dataset.duration, 10);
                        }
                    }

                    const newTask = {
                        id: `pomodoro_${Date.now()}`,
                        name: taskName,
                        mode: mode,
                        duration: duration,
                        status: 'pending',
                        // 为每个任务创建独立的设置副本
                        // 为每个任务创建独立的设置副本，但确保背景是空的
                        settings: {
                            ...JSON.parse(JSON.stringify(db.pomodoroSettings)),
                            focusBackground: '',
                            taskCardBackground: ''
                        }
                    };

                    if (!db.pomodoroTasks) {
                        db.pomodoroTasks = [];
                    }
                    db.pomodoroTasks.push(newTask);
                    await saveData();

                    showToast(`任务 "${taskName}" 已创建`);
                    renderPomodoroTasks();

                    createModal.classList.remove('visible');
                });
            }

            const screen = document.getElementById('pomodoro-screen');
            if (screen) {
                const observer = new MutationObserver(() => {
                    if (screen.classList.contains('active')) {
                        renderPomodoroTasks();
                    }
                });
                observer.observe(screen, { attributes: true, attributeFilter: ['class'] });
            }

            const taskListContainer = document.getElementById('pomodoro-task-list');

            // --- Swipe to delete logic ---
            let touchStartX = 0;
            let touchCurrentX = 0;
            let swipedCardWrapper = null;
            let isDragging = false;
            const swipeThreshold = 50; // Min pixels to trigger swipe

            const handleSwipeStart = (x, target) => {
                touchStartX = x;
                isDragging = true;
                // Close any other swiped card
                const targetWrapper = target.closest('.task-card-wrapper');
                if (swipedCardWrapper && swipedCardWrapper !== targetWrapper) {
                    swipedCardWrapper.classList.remove('is-swiped');
                    swipedCardWrapper = null;
                }
            };

            const handleSwipeMove = (x, target) => {
                if (!isDragging) return;
                const cardWrapper = target.closest('.task-card-wrapper');
                if (!cardWrapper) return;

                touchCurrentX = x;
                const deltaX = touchCurrentX - touchStartX;

                // Only allow left swipe
                if (deltaX < 0) {
                    // Prevent over-swiping
                    const distance = Math.max(deltaX, -80);
                    cardWrapper.querySelector('.task-card').style.transform = `translateX(${distance}px)`;
                }
            };

            const handleSwipeEnd = (target) => {
                if (!isDragging) return;
                isDragging = false;

                const cardWrapper = target.closest('.task-card-wrapper');
                if (!cardWrapper) return;

                const card = cardWrapper.querySelector('.task-card');
                const deltaX = touchCurrentX - touchStartX;

                // Reset inline style
                card.style.transform = '';

                if (deltaX < -swipeThreshold) {
                    cardWrapper.classList.add('is-swiped');
                    swipedCardWrapper = cardWrapper;
                } else {
                    cardWrapper.classList.remove('is-swiped');
                    if (swipedCardWrapper === cardWrapper) {
                        swipedCardWrapper = null;
                    }
                }
                
                // Reset positions
                touchStartX = 0;
                touchCurrentX = 0;
            };

            taskListContainer.addEventListener('touchstart', (e) => {
                handleSwipeStart(e.touches[0].clientX, e.target);
            }, { passive: true });

            taskListContainer.addEventListener('touchmove', (e) => {
                handleSwipeMove(e.touches[0].clientX, e.target);
            }, { passive: true });

            taskListContainer.addEventListener('touchend', (e) => {
                handleSwipeEnd(e.target);
            });
            
            // Mouse events for desktop
            taskListContainer.addEventListener('mousedown', (e) => {
                if (e.target.closest('.task-card-start-btn') || e.target.closest('.task-card-delete-btn')) return;
                handleSwipeStart(e.clientX, e.target);
            });

            taskListContainer.addEventListener('mousemove', (e) => {
                handleSwipeMove(e.clientX, e.target);
            });

            taskListContainer.addEventListener('mouseup', (e) => {
                handleSwipeEnd(e.target);
            });
            
            taskListContainer.addEventListener('mouseleave', (e) => {
                if (isDragging) {
                    handleSwipeEnd(e.target);
                }
            });


            // --- Click handling for start and delete ---
            if (taskListContainer) {
                taskListContainer.addEventListener('click', async (e) => {
                    const startBtn = e.target.closest('.task-card-start-btn');
                    const deleteBtn = e.target.closest('.task-card-delete-btn');
                    const cardWrapper = e.target.closest('.task-card-wrapper');

                    if (deleteBtn && cardWrapper) {
                        const taskId = cardWrapper.dataset.id;
                        if (confirm('确定要删除这个任务吗？')) {
                            db.pomodoroTasks = db.pomodoroTasks.filter(t => t.id !== taskId);
                            await saveData();
                            renderPomodoroTasks();
                            showToast('任务已删除');
                        }
                    } else if (startBtn && cardWrapper) {
                        const taskId = cardWrapper.dataset.id;
                        const task = db.pomodoroTasks.find(t => t.id === taskId);
                        
                        if (task) {
                            // --- Start Focus Session ---
                            currentPomodoroTask = task;
                            stopTimer(); // Ensure any previous timer is stopped
                            pomodoroCurrentSessionSeconds = 0; // Reset session timer
                            pomodoroPokeCount = 0; // Reset poke count
                            pomodoroIsInterrupted = false; // Reset interruption flag
                            pomodoroSessionHistory = []; // NEW: Reset session history
 
                            // 新增：清空并隐藏对话框
                            const focusMessageBubble = document.querySelector('#pomodoro-focus-screen .focus-message-bubble');
                            if (focusMessageBubble) {
                                focusMessageBubble.classList.remove('visible');
                                focusMessageBubble.querySelector('p').textContent = '';
                            }

                            focusTitleEl.textContent = task.name;
                            focusModeEl.textContent = task.mode === 'countdown' ? '倒计时' : '正计时';
                            
                            if (task.mode === 'countdown') {
                                pomodoroRemainingSeconds = task.duration * 60;
                            } else {
                                pomodoroRemainingSeconds = 0;
                            }
                            
                            updateTimerDisplay();
                            updateTotalFocusedTimeDisplay(); // Update display to show 0

                            // NEW: Update avatar based on bound character
                            const focusAvatarEl = document.querySelector('#pomodoro-focus-screen .focus-avatar');
                            if (task.settings && task.settings.boundCharId) {
                                const boundChar = db.characters.find(c => c.id === task.settings.boundCharId);
                                if (boundChar && focusAvatarEl) {
                                    focusAvatarEl.src = boundChar.avatar;
                                } else if (focusAvatarEl) {
                                    focusAvatarEl.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; // Fallback
                                }
                            } else if (focusAvatarEl) {
                                focusAvatarEl.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; // Fallback
                            }
                            // END NEW
 
                            applyPomodoroBackgrounds(); // Apply backgrounds when starting a task
                            // Timer is now started from the focus screen, not automatically.
                            switchScreen('pomodoro-focus-screen');
                        }
                    } else if (cardWrapper && !cardWrapper.classList.contains('is-swiped')) {
                        // If a non-swiped card is clicked, close any open one
                        if (swipedCardWrapper) {
                            swipedCardWrapper.classList.remove('is-swiped');
                            swipedCardWrapper = null;
                        }
                    }
                });
            }
        }

        const init = async () => {
            await loadData();
            if (!db.homeWidgetSettings || !db.homeWidgetSettings.topLeft) {
            db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
            }
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.context-menu')) {
                    e.stopPropagation();
                    return;
                }
                removeContextMenu();

                const backBtn = e.target.closest('.back-btn');
                if (backBtn) {
                    e.preventDefault();
                    switchScreen(backBtn.getAttribute('data-target'));
                }

                // Consolidated overlay closing logic
                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                if (openOverlay && e.target === openOverlay) {
                    openOverlay.classList.remove('visible');
                }
            });

            // Specific nav links that switch screens
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.app-icon[data-target]');
                if (navLink) {
                    e.preventDefault();
                    const target = navLink.getAttribute('data-target');
                    if (target === 'music-screen' || target === 'diary-screen' || target === 'piggy-bank-screen') {
                        showToast('该应用正在开发中，敬请期待！');
                        return;
                    }
                    switchScreen(target);
                }
            });

            updateClock();
            setInterval(updateClock, 30000);
            applyGlobalFont(db.fontUrl);
            applyGlobalCss(db.globalCss);
            applyPomodoroBackgrounds();
            setupHomeScreen();
            setupChatListScreen();
            setupAddCharModal();
            setupChatRoom();
            setupChatSettings();
            setupApiSettingsApp();
            setupWallpaperApp();
            await setupStickerSystem();
            setupPresetFeatures();
            setupVoiceMessageSystem();
            setupPhotoVideoSystem();
            setupImageRecognition();
            setupWalletSystem();
            setupGiftSystem();
            setupTimeSkipSystem();
            setupWorldBookApp();
            setupFontSettingsApp();
            setupGroupChatSystem();
            setupCustomizeApp();
            setupTutorialApp();
            checkForUpdates();
            setupPeekFeature();
            setupChatExpansionPanel();
            setupMemoryJournalScreen(); // 新增：初始化回忆日记功能
            setupDeleteHistoryChunk();
            setupForumBindingFeature();
            setupForumFeature();
            setupShareModal();
            setupStorageAnalysisScreen();
            setupPomodoroApp();
            setupPomodoroSettings();
            setupPomodoroGlobalSettings(); // NEW: Setup global settings
            setupInsWidgetAvatarModal();
            setupHeartPhotoModal();
            document.getElementById('delete-selected-world-books-btn').addEventListener('click', deleteSelectedWorldBooks);
            document.getElementById('cancel-wb-multi-select-btn').addEventListener('click', exitWorldBookMultiSelectMode);
        };

        function setupInsWidgetAvatarModal() {
            const modal = document.getElementById('ins-widget-avatar-modal');
            const form = document.getElementById('ins-widget-avatar-form');
            const preview = document.getElementById('ins-widget-avatar-preview');
            const urlInput = document.getElementById('ins-widget-avatar-url-input');
            const fileUpload = document.getElementById('ins-widget-avatar-file-upload');
            const targetInput = document.getElementById('ins-widget-avatar-target');

            // Use event delegation on homeScreen for avatars since it's re-rendered
            const homeScreen = document.getElementById('home-screen');
            homeScreen.addEventListener('click', (e) => {
                const avatar1 = e.target.closest('#ins-widget-avatar-1');
                const avatar2 = e.target.closest('#ins-widget-avatar-2');

                let targetAvatarId = null;
                let currentSrc = '';

                if (avatar1) {
                    targetAvatarId = 'avatar1';
                    currentSrc = db.insWidgetSettings.avatar1;
                } else if (avatar2) {
                    targetAvatarId = 'avatar2';
                    currentSrc = db.insWidgetSettings.avatar2;
                }

                if (targetAvatarId) {
                    targetInput.value = targetAvatarId;
                    preview.style.backgroundImage = `url("${currentSrc}")`;
                    preview.innerHTML = ''; // Clear "预览" text
                    urlInput.value = '';
                    fileUpload.value = null;
                    modal.classList.add('visible');
                }
            });

            // Handle URL input
            urlInput.addEventListener('input', () => {
                const url = urlInput.value.trim();
                if (url) {
                    preview.style.backgroundImage = `url("${url}")`;
                    preview.innerHTML = '';
                    fileUpload.value = null; // Clear file input if URL is used
                } else {
                    preview.style.backgroundImage = 'none';
                    preview.innerHTML = '<span>预览</span>';
                }
            });

            // Handle file upload
            fileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                        preview.style.backgroundImage = `url("${compressedUrl}")`;
                        preview.innerHTML = '';
                        urlInput.value = ''; // Clear URL input if file is used
                    } catch (error) {
                        showToast('图片压缩失败，请重试');
                        preview.style.backgroundImage = 'none';
                        preview.innerHTML = '<span>预览</span>';
                    }
                }
            });

            // Handle form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const targetAvatar = targetInput.value;
                const bgImage = preview.style.backgroundImage;
                const newSrc = bgImage.slice(5, -2); // Extract URL from 'url("...")'

                if (!targetAvatar || !newSrc) {
                    showToast('没有要保存的图片');
                    return;
                }

                if (targetAvatar === 'centralCircle') {
                    db.homeWidgetSettings.centralCircleImage = newSrc;
                } else if (targetAvatar === 'avatar1') {
                    db.insWidgetSettings.avatar1 = newSrc;
                } else if (targetAvatar === 'avatar2') {
                    db.insWidgetSettings.avatar2 = newSrc;
                }

                await saveData();
                setupHomeScreen(); // Re-render the home screen to show the new avatar
                modal.classList.remove('visible');
                showToast('头像已更新');
            });
        }

       function updatePolaroidImage(imageUrl) {
           const styleId = 'polaroid-image-style';
           let styleElement = document.getElementById(styleId);
           if (!styleElement) {
               styleElement = document.createElement('style');
               styleElement.id = styleId;
               document.head.appendChild(styleElement);
           }
           styleElement.innerHTML = `
               .heart-photo-widget::after {
                   background-image: url('${imageUrl}');
               }
           `;
       }

       function setupHeartPhotoModal() {
           const widget = document.querySelector('.heart-photo-widget');
           const modal = document.getElementById('heart-photo-modal');
           const form = document.getElementById('heart-photo-form');
           const preview = document.getElementById('heart-photo-preview');
           const urlInput = document.getElementById('heart-photo-url-input');
           const fileUpload = document.getElementById('heart-photo-file-upload');

           if (!widget || !modal || !form) return;

           // 1. Open modal on widget click/tap
           const openModalAction = () => {
               const currentImage = db.homeWidgetSettings?.polaroidImage || 'https://i.postimg.cc/XvFDdTKY/Smart-Select-20251013-023208.jpg';
               preview.style.backgroundImage = `url("${currentImage}")`;
               preview.innerHTML = '';
               urlInput.value = '';
               fileUpload.value = null;
               modal.classList.add('visible');
           };

           widget.addEventListener('click', openModalAction);
           widget.addEventListener('touchend', (e) => {
               e.preventDefault();
               openModalAction();
           });

           // 2. Handle image preview (URL input)
           urlInput.addEventListener('input', () => {
               const url = urlInput.value.trim();
               if (url) {
                   preview.style.backgroundImage = `url("${url}")`;
                   preview.innerHTML = '';
                   fileUpload.value = null; // Clear file input
               } else {
                   preview.style.backgroundImage = 'none';
                   preview.innerHTML = '<span>预览</span>';
               }
           });

           // 3. Handle image preview (File upload)
           fileUpload.addEventListener('change', async (e) => {
               const file = e.target.files[0];
               if (file) {
                   try {
                       const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                       preview.style.backgroundImage = `url("${compressedUrl}")`;
                       preview.innerHTML = '';
                       urlInput.value = ''; // Clear URL input
                   } catch (error) {
                       showToast('图片压缩失败，请重试');
                       preview.style.backgroundImage = 'none';
                       preview.innerHTML = '<span>预览</span>';
                   }
               }
           });

           // 4. Handle form submission
           form.addEventListener('submit', async (e) => {
               e.preventDefault();
               const bgImage = preview.style.backgroundImage;
               const newSrc = bgImage.slice(5, -2); // Extract URL from 'url("...")'

               if (!newSrc) {
                   showToast('没有要保存的图片');
                   return;
               }

               // Ensure homeWidgetSettings exists
               if (!db.homeWidgetSettings) {
                   db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
               }
               db.homeWidgetSettings.polaroidImage = newSrc;

               await saveData();
               
               updatePolaroidImage(newSrc);

               modal.classList.remove('visible');
               showToast('拍立得照片已更新');
           });
       }

        function setupPomodoroSettings() {
            const settingsBtn = document.getElementById('pomodoro-focus-settings-btn');
            const settingsSidebar = document.getElementById('pomodoro-settings-sidebar');
            const settingsForm = document.getElementById('pomodoro-settings-form');
            const focusBgUpload = document.getElementById('pomodoro-focus-bg-upload');
            const taskCardBgUpload = document.getElementById('pomodoro-task-card-bg-upload');

            settingsBtn?.addEventListener('click', () => {
                if (currentPomodoroTask) {
                    currentPomodoroSettingsContext = currentPomodoroTask.settings;
                    loadSettingsToPomodoroSidebar(currentPomodoroSettingsContext);
                    settingsSidebar.classList.add('open');
                } else {
                    showToast('没有正在进行的专注任务');
                }
            });

            settingsForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (currentPomodoroSettingsContext) {
                    await savePomodoroSettingsFromSidebar(currentPomodoroSettingsContext);
                }
                settingsSidebar.classList.remove('open');
            });

            focusBgUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentPomodoroSettingsContext) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        document.getElementById('pomodoro-focus-bg-url').value = compressedUrl;
                        currentPomodoroSettingsContext.focusBackground = compressedUrl;
                        applyPomodoroBackgrounds();
                        showToast('专注背景已更新，请保存设置');
                    } catch (error) {
                        showToast('背景压缩失败');
                    }
                }
            });

            taskCardBgUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentPomodoroSettingsContext) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 800, maxHeight: 800 });
                        // 将上传的图片URL保存到当前任务的独立设置中
                        currentPomodoroSettingsContext.taskCardBackground = compressedUrl;
                        // 同时更新输入框的值，以便保存时能正确写入
                        document.getElementById('pomodoro-task-card-bg-url').value = compressedUrl;
                        showToast('卡片背景已更新，请保存设置');
                    } catch (error) {
                        showToast('背景压缩失败');
                    }
                }
            });
        }

        function loadSettingsToPomodoroSidebar(settings) {
            const charSelect = document.getElementById('pomodoro-char-select');
            const userPersonaSelect = document.getElementById('pomodoro-user-persona-select');

            charSelect.innerHTML = '<option value="">不绑定</option>';
            db.characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = char.remarkName;
                if (settings.boundCharId === char.id) {
                    option.selected = true;
                }
                charSelect.appendChild(option);
            });

            userPersonaSelect.innerHTML = '<option value="">默认</option>';
            (db.myPersonaPresets || []).forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.name;
                option.textContent = preset.name;
                if (settings.userPersona === preset.name) {
                    option.selected = true;
                }
                userPersonaSelect.appendChild(option);
            });

            document.getElementById('pomodoro-encouragement-minutes').value = settings.encouragementMinutes || 25;
            document.getElementById('pomodoro-poke-limit').value = settings.pokeLimit || 5;
            document.getElementById('pomodoro-focus-bg-url').value = settings.focusBackground || '';
            document.getElementById('pomodoro-task-card-bg-url').value = settings.taskCardBackground || '';
        }

        async function savePomodoroSettingsFromSidebar(settings) {
            const oldCharId = settings.boundCharId;
            const newCharId = document.getElementById('pomodoro-char-select').value;

            settings.boundCharId = newCharId;
            settings.userPersona = document.getElementById('pomodoro-user-persona-select').value;
            settings.encouragementMinutes = parseInt(document.getElementById('pomodoro-encouragement-minutes').value, 10) || 25;
            settings.pokeLimit = parseInt(document.getElementById('pomodoro-poke-limit').value, 10) || 5;
            settings.focusBackground = document.getElementById('pomodoro-focus-bg-url').value.trim();
            settings.taskCardBackground = document.getElementById('pomodoro-task-card-bg-url').value.trim();
            
            await saveData();
            applyPomodoroBackgrounds();

            // Update avatar in focus screen if it's active
            const focusAvatarEl = document.querySelector('#pomodoro-focus-screen .focus-avatar');
            if (settings.boundCharId) {
                const boundChar = db.characters.find(c => c.id === settings.boundCharId);
                if (boundChar && focusAvatarEl) {
                    focusAvatarEl.src = boundChar.avatar;
                }
            } else if (focusAvatarEl) {
                focusAvatarEl.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; // Fallback
            }

            // 新增：如果更换了角色，则清空对话框
            if (oldCharId !== newCharId) {
                const focusMessageBubble = document.querySelector('#pomodoro-focus-screen .focus-message-bubble');
                if (focusMessageBubble) {
                    focusMessageBubble.classList.remove('visible');
                    focusMessageBubble.querySelector('p').textContent = '';
                }
            }

            showToast('专注设置已保存');
        }

        function applyPomodoroBackgrounds() {
            const focusScreen = document.getElementById('pomodoro-focus-screen');
            
            // Apply focus screen background from the CURRENT task if it exists
            if (currentPomodoroTask && currentPomodoroTask.settings.focusBackground) {
                focusScreen.style.backgroundImage = `url(${currentPomodoroTask.settings.focusBackground})`;
                focusScreen.style.backgroundSize = 'cover';
                focusScreen.style.backgroundPosition = 'center';
            } else {
                focusScreen.style.backgroundImage = 'none';
            }

        }

        function setupPomodoroGlobalSettings() {
            const settingsBtn = document.getElementById('pomodoro-settings-btn');
            const sidebar = document.getElementById('pomodoro-global-settings-sidebar');
            const linkBtn = document.getElementById('link-global-pomodoro-world-book-btn');
            const modal = document.getElementById('global-pomodoro-world-book-selection-modal');
            const selectionList = document.getElementById('global-pomodoro-world-book-selection-list');
            const saveBtn = document.getElementById('save-global-pomodoro-world-book-selection-btn');

            settingsBtn?.addEventListener('click', () => {
                sidebar.classList.add('open');
            });

            linkBtn?.addEventListener('click', () => {
                if (!db.pomodoroSettings) {
                    db.pomodoroSettings = { globalWorldBookIds: [] };
                }
                const selectedIds = db.pomodoroSettings.globalWorldBookIds || [];
                renderCategorizedWorldBookList(selectionList, db.worldBooks, selectedIds, 'global-pomodoro-wb-select');
                modal.classList.add('visible');
            });

            saveBtn?.addEventListener('click', async () => {
                const selectedIds = Array.from(selectionList.querySelectorAll('.item-checkbox:checked')).map(input => input.value);
                if (!db.pomodoroSettings) {
                    db.pomodoroSettings = {};
                }
                db.pomodoroSettings.globalWorldBookIds = selectedIds;
                await saveData();
                modal.classList.remove('visible');
                showToast('全局专注世界书已更新');
            });
        }

        function setupMemoryJournalScreen() {
            const generateNewJournalBtn = document.getElementById('generate-new-journal-btn');
            const generateJournalModal = document.getElementById('generate-journal-modal');
            const generateJournalForm = document.getElementById('generate-journal-form');
            const journalListContainer = document.getElementById('journal-list-container');
            const editDetailBtn = document.getElementById('edit-journal-detail-btn');
            const bindWorldBookBtn = document.getElementById('bind-journal-worldbook-btn');
            const journalWorldBookModal = document.getElementById('journal-worldbook-selection-modal');
            const journalWorldBookList = document.getElementById('journal-worldbook-selection-list');
            const saveJournalWorldBookBtn = document.getElementById('save-journal-worldbook-selection-btn');

            // 新增：绑定世界书按钮事件
            bindWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                renderCategorizedWorldBookList(journalWorldBookList, db.worldBooks, character.journalWorldBookIds || [], 'journal-wb-select');
                journalWorldBookModal.classList.add('visible');
            });

            // 新增：保存世界书绑定
            saveJournalWorldBookBtn.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;

                const selectedIds = Array.from(journalWorldBookList.querySelectorAll('.item-checkbox:checked')).map(input => input.value);
                character.journalWorldBookIds = selectedIds;
                await saveData();
                journalWorldBookModal.classList.remove('visible');
                showToast('日记绑定的世界书已更新');
            });

             // "生成新日记" 按钮 -> 弹出范围选择模态框
            generateNewJournalBtn.addEventListener('click', () => {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const totalMessages = chat ? chat.history.length : 0;
                
                const rangeInfo = document.getElementById('journal-range-info');
                rangeInfo.textContent = `当前聊天总消息数: ${totalMessages}`;

                generateJournalForm.reset();
                generateJournalModal.classList.add('visible');
            });

            // 范围选择表单提交
            generateJournalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const startInput = document.getElementById('journal-range-start');
                const endInput = document.getElementById('journal-range-end');

                const start = parseInt(startInput.value);
                const end = parseInt(endInput.value);
                
                if (isNaN(start) || isNaN(end) || start <= 0 || end < start) {
                    showToast('请输入有效的起止范围');
                    return;
                }

                generateJournalModal.classList.remove('visible');
                await generateJournal(start, end);
            });

            // 点击列表容器中的项目 (事件委托)
            journalListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const card = target.closest('.journal-card');
                if (!card) return;

                const journalId = card.dataset.id;
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                const journal = character.memoryJournals.find(j => j.id === journalId);
                if (!journal) return;

                // --- Handle Action Buttons ---
                if (target.closest('.delete-journal-btn')) {
                    if (confirm('确定要删除这篇日记吗？')) {
                        character.memoryJournals = character.memoryJournals.filter(j => j.id !== journalId);
                        await saveData();
                        renderJournalList();
                        showToast('日记已删除');
                    }
                    return;
                }

                if (target.closest('.favorite-journal-btn')) {
                    journal.isFavorited = !journal.isFavorited;
                    await saveData();
                    target.closest('.favorite-journal-btn').classList.toggle('favorited', journal.isFavorited);
                    showToast(journal.isFavorited ? '已收藏' : '已取消收藏');
                    return;
                }
                
                // --- Handle Navigation to Detail Screen ---
                const date = new Date(journal.createdAt);
                const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
                
                currentJournalDetailId = journal.id;

                const titleEl = document.getElementById('journal-detail-title');
                const contentEl = document.getElementById('journal-detail-content');

                titleEl.isContentEditable = false;
                contentEl.isContentEditable = false;
                titleEl.style.border = 'none';
                contentEl.style.border = 'none';
                titleEl.style.padding = '0';
                contentEl.style.padding = '0';
                editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`;

                titleEl.textContent = journal.title;
                document.getElementById('journal-detail-meta').textContent = `创建于 ${formattedDate} | 消息范围: ${journal.range.start}-${journal.range.end}`;
                document.getElementById('journal-detail-content').textContent = journal.content;
                
                switchScreen('memory-journal-detail-screen');
            });

            // --- NEW: Event listener for the detail page edit button ---
            editDetailBtn.addEventListener('click', async () => {
                if (!currentJournalDetailId) return;

                const titleEl = document.getElementById('journal-detail-title');
                const contentEl = document.getElementById('journal-detail-content');
                const isEditing = titleEl.isContentEditable;

                if (isEditing) {
                    // --- SAVE LOGIC ---
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (!character) return;
                    const journal = character.memoryJournals.find(j => j.id === currentJournalDetailId);
                    if (!journal) return;

                    journal.title = titleEl.textContent.trim();
                    journal.content = contentEl.textContent.trim();
                    await saveData();

                    titleEl.isContentEditable = false;
                    contentEl.isContentEditable = false;
                    titleEl.style.border = 'none';
                    contentEl.style.border = 'none';
                    titleEl.style.padding = '0';
                    contentEl.style.padding = '0';
                    editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`;
                    showToast('日记已保存');
                    renderJournalList(); // Re-render list to show updated title if changed
                } else {
                    // --- EDIT LOGIC ---
                    titleEl.setAttribute('contenteditable', 'true');
                    contentEl.setAttribute('contenteditable', 'true');
                    titleEl.style.border = '1px dashed #ccc';
                    titleEl.style.padding = '5px';
                    contentEl.style.border = '1px dashed #ccc';
                    contentEl.style.padding = '10px';
                    editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9,16.17L4.83,12L3.41,13.41L9,19L21,7L19.59,5.59L9,16.17Z" /></svg>`; // Checkmark icon
                    titleEl.focus();
                }
            });
        }

        function renderJournalList() {
            const container = document.getElementById('journal-list-container');
            const placeholder = document.getElementById('no-journals-placeholder');
            container.innerHTML = '';

            const character = db.characters.find(c => c.id === currentChatId);
            const journals = character ? character.memoryJournals : [];

            if (!journals || journals.length === 0) {
                placeholder.style.display = 'block';
                return;
            }

            placeholder.style.display = 'none';

            const sortedJournals = [...journals].sort((a, b) => a.createdAt - b.createdAt);

            sortedJournals.forEach(journal => {
                const card = document.createElement('li');
                card.className = 'journal-card';
                card.dataset.id = journal.id;

                const date = new Date(journal.createdAt);
                const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;

                card.innerHTML = `
                    <div class="journal-card-header">
                        <div class="journal-card-title">${journal.title}</div>
                    </div>
                    <div class="journal-card-actions">
                        <button class="action-icon-btn favorite-journal-btn" title="收藏">
                            <svg viewBox="0 0 24 24">
                                <path class="star-outline" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" fill="currentColor"/>
                                <path class="star-solid" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
                            </svg>
                        </button>
                        <button class="action-icon-btn delete-journal-btn" title="删除">
                            <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
                        </button>
                    </div>
                    <div class="journal-card-footer" style="justify-content: space-between; height: auto; opacity: 1; margin-top: 10px;">
                        <span class="journal-card-date">${formattedDate}</span>
                        <span class="journal-card-range">范围: ${journal.range.start}-${journal.range.end}</span>
                    </div>
                `;

                if (journal.isFavorited) {
                    card.querySelector('.favorite-journal-btn').classList.add('favorited');
                }

                container.appendChild(card);
            });

            // 为相册刷新按钮添加事件监听
            const refreshAlbumBtn = document.getElementById('refresh-album-btn');
            if(refreshAlbumBtn) {
                refreshAlbumBtn.addEventListener('click', () => generateAndRenderPeekContent('album', { forceRefresh: true }));
            }
    
            // 为照片详情模态框添加关闭事件
            const photoModal = document.getElementById('peek-photo-modal');
            if(photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.remove('visible');
                    }
                });
            }
        }

        async function generateJournal(start, end) {
            showToast('正在生成日记，请稍候...');
            isGenerating = true; // Set a flag to prevent other actions

            try {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                if (!chat) {
                    throw new Error("未找到当前聊天。");
                }

                // Message indices are 1-based for the user, so convert to 0-based for slicing
                const startIndex = start - 1;
                const endIndex = end;
                
                if (startIndex < 0 || endIndex > chat.history.length || startIndex >= endIndex) {
                    throw new Error("无效的消息范围。");
                }

                const messagesToSummarize = chat.history.slice(startIndex, endIndex);
                
                // 使用为日记绑定的世界书
                const journalWorldBooks = (chat.journalWorldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id)).filter(Boolean);
                const worldBooksContent = journalWorldBooks.map(wb => wb.content).join('\n\n');

                let summaryPrompt = `你是一个日记整理助手。请以角色 "${chat.remarkName || chat.name}" 的第一人称视角，总结以下聊天记录。请专注于重要的情绪、事件和细节。\n\n`;
                summaryPrompt += "为了更好地理解角色和背景，请参考以下信息：\n";
                summaryPrompt += "=====\n";

                if (worldBooksContent) {
                    summaryPrompt += `世界观设定:\n${worldBooksContent}\n\n`;
                }

                summaryPrompt += `你的角色设定:\n- 角色名: ${chat.realName}\n- 人设: ${chat.persona || "一个友好、乐于助人的伙伴。"}\n\n`;
                summaryPrompt += `我的角色设定:\n- 我的称呼: ${chat.myName}\n- 我的人设: ${chat.myPersona || "无特定人设。"}\n\n`;
                summaryPrompt += "=====\n";
                summaryPrompt += `请基于以上所有背景信息，总结以下聊天记录。你的输出必须是一个JSON对象，包含 'title' (一个简洁的标题) 和 'content' (完整的日记正文) 两个字段。聊天记录如下：\n\n---\n${messagesToSummarize.map(m => m.content).join('\n')}\n---`;

                const { url, key, model, provider } = db.apiSettings;
                if (!url || !key || !model) {
                    throw new Error("API设置不完整。");
                }

                const requestBody = {
                    model: model,
                    messages: [{ role: 'user', content: summaryPrompt }],
                    temperature: 0.7,
                    response_format: { type: "json_object" }, // Request JSON output
                };
                const endpoint = `${url}/v1/chat/completions`;
                const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };

                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) {
                    const error = new Error(`API 错误: ${response.status} ${await response.text()}`);
                    error.response = response;
                    throw error;
                }

                const result = await response.json();
                const rawContent = result.choices[0].message.content;
                const journalData = JSON.parse(rawContent);

                // Create and save the new journal entry
                const newJournal = {
                    id: `journal_${Date.now()}`,
                    range: { start, end },
                    title: journalData.title || "无标题日记",
                    content: journalData.content || "内容为空。",
                    createdAt: Date.now(),
                    chatId: currentChatId,
                    chatType: currentChatType,
                    isFavorited: false // 新增：收藏状态
                };

                if (!chat.memoryJournals) {
                    chat.memoryJournals = [];
                }
                chat.memoryJournals.push(newJournal);
                await saveData();

                renderJournalList();
                showToast('新日记已生成！');

            } catch (error) {
                showApiError(error);
            } finally {
                isGenerating = false; // Reset the flag
            }
        }

        function setupPeekFeature() {
            const peekBtn = document.getElementById('peek-btn');
            const peekConfirmModal = document.getElementById('peek-confirm-modal');
            const peekConfirmYes = document.getElementById('peek-confirm-yes');
            const peekConfirmNo = document.getElementById('peek-confirm-no');
            const peekSettingsBtn = document.getElementById('peek-settings-btn');
            const peekWallpaperModal = document.getElementById('peek-wallpaper-modal');
            const peekWallpaperForm = document.getElementById('peek-wallpaper-form');
            const peekWallpaperUpload = document.getElementById('peek-wallpaper-upload');
            const peekWallpaperPreview = document.getElementById('peek-wallpaper-preview');

            peekBtn?.addEventListener('click', () => {
                peekConfirmModal.classList.add('visible');
            });

            peekConfirmNo?.addEventListener('click', () => {
                peekConfirmModal.classList.remove('visible');
            });

            peekConfirmYes?.addEventListener('click', () => {
                peekConfirmModal.classList.remove('visible');
                peekContentCache = {}; // Clear cache for new session
                renderPeekScreen(); // Render before switching
                switchScreen('peek-screen');
            });

            // New simplified settings functionality
            peekSettingsBtn?.addEventListener('click', () => {
                renderPeekSettings();
                peekWallpaperModal.classList.add('visible');
            });

            peekWallpaperUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        document.getElementById('peek-wallpaper-url-input').value = compressedUrl;
                        showToast('图片已压缩并填入URL输入框');
                    } catch (error) {
                        showToast('壁纸压缩失败，请重试');
                    }
                }
            });

            // Combined save button for all peek settings
            document.getElementById('save-peek-settings-btn')?.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) {
                    showToast('错误：未找到当前角色');
                    return;
                }

                if (!character.peekScreenSettings) {
                    character.peekScreenSettings = { wallpaper: '', customIcons: {}, unlockAvatar: '' };
                }

                // Save wallpaper
                character.peekScreenSettings.wallpaper = document.getElementById('peek-wallpaper-url-input').value.trim();

                // Save custom app icons
                const iconInputs = document.querySelectorAll('#peek-app-icons-settings input[type="url"]');
                iconInputs.forEach(input => {
                    const appId = input.dataset.appId;
                    const newUrl = input.value.trim();
                    if (newUrl) {
                        if (!character.peekScreenSettings.customIcons) {
                            character.peekScreenSettings.customIcons = {};
                        }
                        character.peekScreenSettings.customIcons[appId] = newUrl;
                    } else {
                        if (character.peekScreenSettings.customIcons) {
                            delete character.peekScreenSettings.customIcons[appId];
                        }
                    }
                });
                
                // Save unlock avatar
                character.peekScreenSettings.unlockAvatar = document.getElementById('peek-unlock-avatar-url').value.trim();

                await saveData();
                renderPeekScreen(); // Re-render to apply all changes
                showToast('已保存！');
                peekWallpaperModal.classList.remove('visible');
            });

            // Add collapsible functionality
            peekWallpaperModal.addEventListener('click', (e) => {
                const header = e.target.closest('.collapsible-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });

            const peekMessagesScreen = document.getElementById('peek-messages-screen');
            peekMessagesScreen.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    const partnerName = chatItem.dataset.name;
                    const cachedData = peekContentCache.messages;
                    if (cachedData && cachedData.conversations) {
                        const conversation = cachedData.conversations.find(c => c.partnerName === partnerName);
                        if (conversation) {
                            renderPeekConversation(conversation.history, conversation.partnerName);
                            switchScreen('peek-conversation-screen');
                        } else {
                            showToast('找不到对话记录');
                        }
                    }
                } else if (e.target.closest('.action-btn')) {
                    generateAndRenderPeekContent('messages', { forceRefresh: true });
                }
            });

            const peekConversationScreen = document.getElementById('peek-conversation-screen');
            peekConversationScreen.addEventListener('click', (e) => {
                if (e.target.closest('.action-btn')) {
                    generateAndRenderPeekContent('messages', { forceRefresh: true });
                }
            });

            // 为相册刷新按钮添加事件监听
            const refreshAlbumBtn = document.getElementById('refresh-album-btn');
            if(refreshAlbumBtn) {
                refreshAlbumBtn.addEventListener('click', () => generateAndRenderPeekContent('album', { forceRefresh: true }));
            }
    
            // 为照片详情模态框添加关闭事件
            const photoModal = document.getElementById('peek-photo-modal');
            if(photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.remove('visible');
                    }
                });
            }
        }

        function renderPeekAlbum(photos) {
            const screen = document.getElementById('peek-album-screen');
            const grid = screen.querySelector('.album-grid');
            grid.innerHTML = ''; // Clear previous content
    
            if (!photos || photos.length === 0) {
                grid.innerHTML = '<p class="placeholder-text">正在生成相册内容...</p>';
                return;
            }
    
            photos.forEach(photo => {
                const photoEl = document.createElement('div');
                photoEl.className = 'album-photo';
                photoEl.dataset.imageDescription = photo.imageDescription;
                photoEl.dataset.description = photo.description;
    
                const img = document.createElement('img');
                img.src = 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'; // 使用一个静态占位图
                img.alt = "相册照片";
                photoEl.appendChild(img);
    
                if (photo.type === 'video') {
                    const videoIndicator = document.createElement('div');
                    videoIndicator.className = 'video-indicator';
                    videoIndicator.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`;
                    photoEl.appendChild(videoIndicator);
                }
                
                photoEl.addEventListener('click', () => {
                    const modal = document.getElementById('peek-photo-modal');
                    const imgContainer = document.getElementById('peek-photo-image-container');
                    const descriptionEl = document.getElementById('peek-photo-description');
                    
                    // 将AI生成的图片文字描述展示出来，而不是真的图片
                    imgContainer.innerHTML = `<div style="padding: 20px; text-align: left; color: #555; font-size: 16px; line-height: 1.6; height: 100%; overflow-y: auto;">${photo.imageDescription}</div>`;
                    // 显示角色对照片的批注
                    descriptionEl.textContent = `批注：${photo.description}`;
                    
                    modal.classList.add('visible');
                });
    
                grid.appendChild(photoEl);
            });
        }

        function renderPeekUnlock(data) {
            const screen = document.getElementById('peek-unlock-screen');
            if (!screen) return;

            // Handle loading/empty state
            if (!data) {
                screen.innerHTML = `
                    <header class="app-header">
                        <button class="back-btn" data-target="peek-screen">‹</button>
                        <div class="title-container"><h1 class="title">...</h1></div>
                        <button class="action-btn">···</button>
                    </header>
                    <main class="content"><p class="placeholder-text">正在生成小号内容...</p></main>
                `;
                return;
            }

            const { nickname, handle, bio, posts } = data;
            const character = db.characters.find(c => c.id === currentChatId);
            const peekSettings = character?.peekScreenSettings || { unlockAvatar: '' };
            const fixedAvatar = peekSettings.unlockAvatar || 'https://i.postimg.cc/SNwL1XwR/chan-11.png';

            // Random numbers for stats
            const randomFollowers = (Math.random() * 5 + 1).toFixed(1) + 'k';
            const randomFollowing = Math.floor(Math.random() * 500) + 50;

            let postsHtml = '';
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const randomComments = Math.floor(Math.random() * 100);
                    const randomLikes = Math.floor(Math.random() * 500);
                    postsHtml += `
                        <div class="unlock-post-card">
                            <div class="unlock-post-card-header">
                                <img src="${fixedAvatar}" alt="Profile Avatar">
                                <div class="unlock-post-card-author-info">
                                    <span class="username">${nickname}</span>
                                    <span class="timestamp">${post.timestamp}</span>
                                </div>
                            </div>
                            <div class="unlock-post-card-content">
                                ${post.content.replace(/\n/g, '<br>')}
                            </div>
                            <div class="unlock-post-card-actions">
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z"></path></svg> <span>分享</span></div>
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M20,2H4C2.9,0,2,0.9,2,2v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z M18,14H6v-2h12V14z M18,11H6V9h12V11z M18,8H6V6h12V8z"></path></svg> <span>${randomComments}</span></div>
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36,2,12.27,2,8.5C2,5.42,4.42,3,7.5,3c1.74,0,3.41,0.81,4.5,2.09C13.09,3.81,14.76,3,16.5,3C19.58,3,22,5.42,22,8.5c0,3.78-3.4,6.86-8.55,11.54L12,21.35z"></path></svg> <span>${randomLikes}</span></div>
                            </div>
                        </div>
                    `;
                });
            }

            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-screen">‹</button>
                    <div class="title-container">
                        <h1 class="title">${nickname}</h1>
                    </div>
                    <button class="action-btn" id="refresh-unlock-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content">
                    <div class="unlock-profile-header">
                        <img src="${fixedAvatar}" alt="Profile Avatar" class="unlock-profile-avatar">
                        <div class="unlock-profile-info">
                            <h2 class="unlock-profile-username">${nickname}</h2>
                            <p class="unlock-profile-handle">${handle}</p>
                        </div>
                    </div>
                    <div class="unlock-profile-bio">
                        <p>${bio.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="unlock-profile-stats">
                        <div class="unlock-profile-stat">
                            <span class="count">${posts.length}</span>
                            <span class="label">帖子</span>
                        </div>
                        <div class="unlock-profile-stat">
                            <span class="count">${randomFollowers}</span>
                            <span class="label">粉丝</span>
                        </div>
                        <div class="unlock-profile-stat">
                            <span class="count">${randomFollowing}</span>
                            <span class="label">关注</span>
                        </div>
                    </div>
                    <div class="unlock-post-feed">
                        ${postsHtml}
                    </div>
                </main>
            `;

            // Add event listener for the new refresh button
            screen.querySelector('#refresh-unlock-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('unlock', { forceRefresh: true });
            });
        }
 
        function renderPeekConversation(history, partnerName) {
            const titleEl = document.getElementById('peek-conversation-title');
            const messageAreaEl = document.getElementById('peek-message-area');

            titleEl.textContent = partnerName;
            messageAreaEl.innerHTML = '';

            if (!history || history.length === 0) {
                messageAreaEl.innerHTML = '<p class="placeholder-text">正在生成对话...</p>';
                return;
            }

            history.forEach(msg => {
                const isSentByChar = msg.sender === 'char'; // 'char' is the character whose phone we are peeking
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isSentByChar ? 'sent' : 'received'}`;

                const bubbleRow = document.createElement('div');
                bubbleRow.className = 'message-bubble-row';

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSentByChar ? 'sent' : 'received'}`;
                bubble.textContent = msg.content;

                if (isSentByChar) {
                    bubbleRow.appendChild(bubble);
                } else {
                    const avatar = document.createElement('img');
                    avatar.className = 'message-avatar';
                    avatar.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                    bubbleRow.appendChild(avatar);
                    bubbleRow.appendChild(bubble);
                }
                
                wrapper.appendChild(bubbleRow);
                messageAreaEl.appendChild(wrapper);
            });
            messageAreaEl.scrollTop = messageAreaEl.scrollHeight;
        }

        function renderPeekScreen() {
            const peekScreen = document.getElementById('peek-screen');
            const contentArea = peekScreen.querySelector('main.content');

            // Set content
            contentArea.innerHTML = `
                <div class="time-widget">
                    <div class="time" id="peek-time-display"></div>
                    <div class="date" id="peek-date-display"></div>
                </div>
                <div class="app-grid"></div>
            `;

            const character = db.characters.find(c => c.id === currentChatId);
            const peekSettings = character?.peekScreenSettings || { wallpaper: '', customIcons: {} };

            // Apply wallpaper to the parent screen element
            const wallpaper = peekSettings.wallpaper;
            if (wallpaper) {
                peekScreen.style.backgroundImage = `url(${wallpaper})`;
            } else {
                peekScreen.style.backgroundImage = `url(${db.wallpaper})`; // Fallback to global wallpaper
            }
            peekScreen.style.backgroundSize = 'cover';
            peekScreen.style.backgroundPosition = 'center';

            // Render the 6 specific, non-functional icons
            const appGrid = contentArea.querySelector('.app-grid');
            Object.keys(peekScreenApps).forEach(id => {
                const iconData = peekScreenApps[id];
                const iconEl = document.createElement('a');
                iconEl.href = '#';
                iconEl.className = 'app-icon';
                iconEl.dataset.peekAppId = id;
                const customIconUrl = peekSettings.customIcons?.[id];
                const iconUrl = customIconUrl || iconData.url;
                iconEl.innerHTML = `
                    <img src="${iconUrl}" alt="${iconData.name}" class="icon-img">
                    <span class="app-name">${iconData.name}</span>
                `;
                iconEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    generateAndRenderPeekContent(id);
                });
                appGrid.appendChild(iconEl);
            });

            // Call updateClock to immediately populate the time
            updateClock();
        }

        function renderPeekChatList(conversations = []) {
            const container = document.getElementById('peek-chat-list-container');
            container.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                // This case is handled by the loading/error message in generateAndRenderPeekContent
                return;
            }

            // Use a pool of default avatars
            conversations.forEach((convo) => {
                const history = convo.history || [];
                const lastMessage = history.length > 0 ? history[history.length - 1] : null;
                const lastMessageText = lastMessage ? (lastMessage.content || '').replace(/\[.*?的消息：([\s\S]+)\]/, '$1') : '...';
                
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                // Use partnerName as the unique identifier for clicking
                li.dataset.name = convo.partnerName;

                const avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';

                li.innerHTML = `
                    <img src="${avatarUrl}" alt="${convo.partnerName}" class="chat-avatar">
                    <div class="item-details">
                        <div class="item-details-row"><div class="item-name">${convo.partnerName}</div></div>
                        <div class="item-preview-wrapper">
                            <div class="item-preview">${lastMessageText}</div>
                        </div>
                    </div>`;
                container.appendChild(li);
            });
        }

        function renderMemosList(memos) {
            const screen = document.getElementById('peek-memos-screen');
            let listHtml = '';
            if (!memos || memos.length === 0) {
                listHtml = '<p class="placeholder-text">正在生成备忘录...</p>';
            } else {
                memos.forEach(memo => {
                    const firstLine = memo.content.split('\n')[0];
                    listHtml += `
                        <li class="memo-item" data-id="${memo.id}">
                            <h3 class="memo-item-title">${memo.title}</h3>
                            <p class="memo-item-preview">${firstLine}</p>
                        </li>
                    `;
                });
            }

            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-screen">‹</button>
                    <div class="title-container"><h1 class="title">备忘录</h1></div>
                    <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content"><ul id="peek-memos-list">${listHtml}</ul></main>
            `;

            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('memos', { forceRefresh: true });
            });

            screen.querySelectorAll('.memo-item').forEach(item => {
                item.addEventListener('click', () => {
                    // FIX: Correctly access the 'memos' array within the cached object.
                    const memo = peekContentCache.memos?.memos?.find(m => m.id === item.dataset.id);
                    if (memo) {
                        renderMemoDetail(memo);
                        switchScreen('peek-memo-detail-screen');
                    }
                });
            });
        }

        function renderMemoDetail(memo) {
            const screen = document.getElementById('peek-memo-detail-screen');
            if (!memo) return;
            const contentHtml = memo.content.replace(/\n/g, '<br>');
            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-memos-screen">‹</button>
                    <div class="title-container"><h1 class="title">${memo.title}</h1></div>
                    <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content" style="padding: 20px; line-height: 1.6;">${contentHtml}</main>
            `;
        }

       function renderPeekCart(items) {
           const screen = document.getElementById('peek-cart-screen');
            let itemsHtml = '';
            let totalPrice = 0;

            if (!items || items.length === 0) {
                itemsHtml = '<p class="placeholder-text">正在生成购物车内容...</p>';
            } else {
                items.forEach(item => {
                    itemsHtml += `
                        <li class="cart-item" data-id="${item.id}">
                            <img src="https://i.postimg.cc/wMbSMvR9/export202509181930036600.png" class="cart-item-image" alt="${item.title}">
                            <div class="cart-item-details">
                                <h3 class="cart-item-title">${item.title}</h3>
                                <p class="cart-item-spec">规格：${item.spec}</p>
                                <p class="cart-item-price">¥${item.price}</p>
                            </div>
                        </li>
                    `;
                    totalPrice += parseFloat(item.price);
                });
            }

           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container"><h1 class="title">购物车</h1></div>
                   <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
               </header>
               <main class="content"><ul class="cart-item-list">${itemsHtml}</ul></main>
               <footer class="cart-footer">
                   <div class="cart-total-price">
                       <span class="label">合计：</span>¥${totalPrice.toFixed(2)}
                   </div>
                   <button class="checkout-btn">结算</button>
               </footer>
           `;
           
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('cart', { forceRefresh: true });
            });
           screen.querySelector('.checkout-btn').addEventListener('click', () => {
               showToast('功能开发中');
           });
       }

       function renderPeekTransferStation(entries) {
           const screen = document.getElementById('peek-transfer-station-screen');
            let messagesHtml = '';

            if (!entries || entries.length === 0) {
                messagesHtml = '<p class="placeholder-text">正在生成中转站内容...</p>';
            } else {
                entries.forEach(entry => {
                    // Each entry is a message from the character to themselves.
                    // We'll render it as a 'sent' message bubble.
                    messagesHtml += `
                        <div class="message-wrapper sent">
                            <div class="message-bubble-row">
                                <div class="message-bubble sent" style="background-color: #98E165; color: #000;">
                                    ${entry}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container">
                       <h1 class="title">文件传输助手</h1>
                   </div>
                   <button class="action-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                   </button>
               </header>
               <main class="content">
                   <div class="message-area" style="padding: 10px;">
                        ${messagesHtml}
                   </div>
                   <div class="transfer-station-input-area">
                       <div class="fake-input"></div>
                       <button class="plus-btn"></button>
                   </div>
               </main>
           `;
            
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('transfer', { forceRefresh: true });
            });

            const messageArea = screen.querySelector('.message-area');
            if (messageArea) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
       }

      function renderPeekBrowser(historyItems) {
          const screen = document.getElementById('peek-browser-screen');
          let itemsHtml = '';
            if (!historyItems || historyItems.length === 0) {
                itemsHtml = '<p class="placeholder-text">正在生成浏览记录...</p>';
            } else {
                historyItems.forEach(item => {
                    itemsHtml += `
                        <li class="browser-history-item">
                            <h3 class="history-item-title">${item.title}</h3>
                            <p class="history-item-url">${item.url}</p>
                            <div class="history-item-annotation">${item.annotation}</div>
                        </li>
                    `;
                });
            }

          screen.innerHTML = `
              <header class="app-header">
                  <button class="back-btn" data-target="peek-screen">‹</button>
                  <div class="title-container"><h1 class="title">浏览器</h1></div>
                  <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
              </header>
              <main class="content"><ul class="browser-history-list">${itemsHtml}</ul></main>
          `;
          screen.querySelector('.action-btn').addEventListener('click', () => {
              generateAndRenderPeekContent('browser', { forceRefresh: true });
          });
      }

       function renderPeekDrafts(draft) {
            const screen = document.getElementById('peek-drafts-screen');
            let draftTo = '...';
            let draftContent = '<p class="placeholder-text">正在生成草稿...</p>';

            if (draft) {
                draftTo = draft.to;
                draftContent = draft.content;
            }
            
           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container"><h1 class="title">草稿箱</h1></div>
                   <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
               </header>
               <main class="content">
                   <div class="draft-paper">
                       <div class="draft-to">To: ${draftTo}</div>
                       <div class="draft-content">${draftContent}</div>
                   </div>
               </main>
           `;
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('drafts', { forceRefresh: true });
            });
       }

      // ==================================================================================================================
      // ========================================== 1. API 预设管理 (API PRESET MANAGEMENT) ==========================================
      // ==================================================================================================================
       function _getApiPresets() {
           return db.apiPresets || [];
       }
       function _saveApiPresets(arr) {
           db.apiPresets = arr || [];
           saveData();
       }

       function populateApiSelect() {
           const sel = document.getElementById('api-preset-select');
           if (!sel) return;
           const presets = _getApiPresets();
           sel.innerHTML = '<option value="">— 选择 API 预设 —</option>';
           presets.forEach(p => {
           const opt = document.createElement('option');
           opt.value = p.name;
           opt.textContent = p.name;
           sel.appendChild(opt);
           });
       }

       function saveCurrentApiAsPreset() {
           const apiKeyEl = document.querySelector('#api-key');
           const apiUrlEl = document.querySelector('#api-url');
           const providerEl = document.querySelector('#api-provider');
           const modelEl = document.querySelector('#api-model');

           const data = {
               apiKey: apiKeyEl ? apiKeyEl.value : '',
               apiUrl: apiUrlEl ? apiUrlEl.value : '',
               provider: providerEl ? providerEl.value : '',
               model: modelEl ? modelEl.value : ''
           };
           
           let name = prompt('为该 API 预设填写名称（会覆盖同名预设）：');
           if (!name) return;
           const presets = _getApiPresets();
           const idx = presets.findIndex(p => p.name === name);
           const preset = {name: name, data: data};
           if (idx >= 0) presets[idx] = preset; else presets.push(preset);
           _saveApiPresets(presets);
           populateApiSelect();
           (window.showToast && showToast('API 预设已保存')) || console.log('API 预设已保存');
       }

       async function applyApiPreset(name) {
           const presets = _getApiPresets();
           const p = presets.find(x => x.name === name);
           if (!p) return (window.showToast && showToast('未找到该预设')) || alert('未找到该预设');
           try {
               const apiKeyEl = document.querySelector('#api-key');
               const apiUrlEl = document.querySelector('#api-url');
               const providerEl = document.querySelector('#api-provider');
               const modelEl = document.querySelector('#api-model');

               if (apiKeyEl && p.data && typeof p.data.apiKey !== 'undefined') apiKeyEl.value = p.data.apiKey;
               if (apiUrlEl && p.data && typeof p.data.apiUrl !== 'undefined') apiUrlEl.value = p.data.apiUrl;
               if (providerEl && p.data && typeof p.data.provider !== 'undefined') providerEl.value = p.data.provider;
               if (modelEl && p.data && typeof p.data.model !== 'undefined') {
                   modelEl.innerHTML = `<option value="${p.data.model}">${p.data.model}</option>`;
                   modelEl.value = p.data.model;
               }

               (window.showToast && showToast('已应用 API 预设')) || console.log('已应用 API 预设');
           } catch(e) {
               console.error('applyApiPreset error', e);
           }
       }

       function openApiManageModal() {
           const modal = document.getElementById('api-presets-modal');
           const list = document.getElementById('api-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getApiPresets();
           if (!presets.length) {
               list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           }
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 6px';
               row.style.borderBottom = '1px solid #f6f6f6';

               const left = document.createElement('div');
               left.style.flex = '1';
               left.style.minWidth = '0';
               left.innerHTML = '<div style="font-weight:600;">'+p.name+'</div><div style="font-size:12px;color:#666;margin-top:4px;">' + (p.data && p.data.provider ? ('提供者：'+p.data.provider) : '') + '</div>';

               const btns = document.createElement('div');
               btns.style.display = 'flex';
               btns.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyApiPreset(p.name); modal.style.display='none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const all = _getApiPresets();
                   all[idx].name = newName;
                   _saveApiPresets(all);
                   openApiManageModal();
                   populateApiSelect();
               };

               const delBtn = document.createElement('button');
               delBtn.className = 'btn';
               delBtn.textContent = '删除';
               delBtn.onclick = function(){ if(!confirm('确定删除 "'+p.name+'" ?')) return; const all=_getApiPresets(); all.splice(idx,1); _saveApiPresets(all); openApiManageModal(); populateApiSelect(); };

               btns.appendChild(applyBtn); btns.appendChild(renameBtn); btns.appendChild(delBtn);

               row.appendChild(left); row.appendChild(btns);
               list.appendChild(row);
           });
           modal.style.display = 'flex';
       }

       function exportApiPresets() {
           const presets = _getApiPresets();
           const blob = new Blob([JSON.stringify(presets, null, 2)], {type: 'application/json'});
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url; a.download = 'api_presets.json'; document.body.appendChild(a); a.click(); a.remove();
           URL.revokeObjectURL(url);
       }
       function importApiPresets() {
           const inp = document.createElement('input');
           inp.type = 'file';
           inp.accept = 'application/json';
           inp.onchange = function(e){
               const f = e.target.files[0];
               if (!f) return;
               const r = new FileReader();
               r.onload = function(){ try { const data = JSON.parse(r.result); if (Array.isArray(data)) { _saveApiPresets(data); populateApiSelect(); openApiManageModal(); } else alert('文件格式不正确'); } catch(e){ alert('导入失败：'+e.message); } };
               r.readAsText(f);
           };
           inp.click();
       }
       
       // ==================================================================================================================
       // =================================== 2. 气泡CSS自定义预设管理 (BUBBLE CSS PRESET MANAGEMENT) ===================================
       // ==================================================================================================================
       function _getBubblePresets() {
           return db.bubbleCssPresets || [];
       }
       function _saveBubblePresets(arr) {
           db.bubbleCssPresets = arr || [];
           saveData();
       }

       function populateBubblePresetSelect(selectId) { // 增加了参数
           const sel = document.getElementById(selectId); // 使用参数
           if (!sel) return;
           const presets = _getBubblePresets();
           sel.innerHTML = '<option value="">— 选择预设 —</option>';
           presets.forEach((p) => {
               const opt = document.createElement('option');
               opt.value = p.name;
               opt.textContent = p.name;
               sel.appendChild(opt);
           });
       }

       async function applyPresetToCurrentChat(presetName) {
           const presets = _getBubblePresets();
           const preset = presets.find(p => p.name === presetName);
           if (!preset) { (window.showToast && showToast('未找到该预设')) || alert('未找到该预设'); return; }
           
           const textarea = document.getElementById('setting-custom-bubble-css') || document.getElementById('setting-group-custom-bubble-css');
           if (textarea) textarea.value = preset.css;

           try {
               const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
               if (chat) {
                   chat.customBubbleCss = preset.css;
                   chat.useCustomBubbleCss = true;
                   if (currentChatType === 'private') {
                       document.getElementById('setting-use-custom-css').checked = true;
                       document.getElementById('setting-custom-bubble-css').disabled = false;
                   } else {
                       document.getElementById('setting-group-use-custom-css').checked = true;
                       document.getElementById('setting-group-custom-bubble-css').disabled = false;
                   }
               }
           } catch(e){
               console.warn('applyPresetToCurrentChat: cannot write to db object', e);
           }

           try {
               updateCustomBubbleStyle(window.currentChatId || null, preset.css, true);
               const previewBox = document.getElementById('private-bubble-css-preview') || document.getElementById('group-bubble-css-preview');
               if (previewBox) {
                   const themeKey = (currentChatType === 'private' ? db.characters.find(c => c.id === currentChatId).theme : db.groups.find(g => g.id === currentChatId).theme) || 'white_pink';
                   updateBubbleCssPreview(previewBox, preset.css, false, colorThemes[themeKey]);
               }
               (window.showToast && showToast('预设已应用到当前聊天并保存')) || alert('预设已应用（若页面支持）');
               await saveData();
           } catch(e){
               console.error('applyPresetToCurrentChat error', e);
           }
       }

       function saveCurrentTextareaAsPreset() {
           const textarea = document.getElementById('setting-custom-bubble-css') || document.getElementById('setting-group-custom-bubble-css');
           if (!textarea) return (window.showToast && showToast('找不到自定义 CSS 文本框')) || alert('找不到自定义 CSS 文本框');
           const css = textarea.value.trim();
           if (!css) return (window.showToast && showToast('当前 CSS 为空，无法保存')) || alert('当前 CSS 为空，无法保存');
           let name = prompt('请输入预设名称（将覆盖同名预设）:');
           if (!name) return;
           const presets = _getBubblePresets();
           const idx = presets.findIndex(p => p.name === name);
           if (idx >= 0) presets[idx].css = css;
           else presets.push({name, css});
           _saveBubblePresets(presets);
           populateBubblePresetSelect('bubble-preset-select'); populateBubblePresetSelect('group-bubble-preset-select');
           (window.showToast && showToast('预设已保存')) || alert('预设已保存');
       }

       function openManagePresetsModal() {
           const modal = document.getElementById('bubble-presets-modal');
           const list = document.getElementById('bubble-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getBubblePresets();
           if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 0';
               row.style.borderBottom = '1px solid #f0f0f0';
               const nameDiv = document.createElement('div');
               nameDiv.style.flex = '1';
               nameDiv.style.whiteSpace = 'nowrap';
               nameDiv.style.overflow = 'hidden';
               nameDiv.style.textOverflow = 'ellipsis';
               nameDiv.textContent = p.name;
               row.appendChild(nameDiv);

               const btnWrap = document.createElement('div');
               btnWrap.style.display = 'flex';
               btnWrap.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn btn-primary';
               applyBtn.style.padding = '6px 8px;border-radius:8px';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyPresetToCurrentChat(p.name); modal.style.display = 'none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.style.padding = '6px 8px;border-radius:8px';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const presetsAll = _getBubblePresets();
                   presetsAll[idx].name = newName;
                   _saveBubblePresets(presetsAll);
                   openManagePresetsModal(); // refresh
                   populateBubblePresetSelect('bubble-preset-select'); populateBubblePresetSelect('group-bubble-preset-select');
               };

               const delBtn = document.createElement('button');
               delBtn.className = 'btn btn-danger';
               delBtn.style.padding = '6px 8px;border-radius:8px';
               delBtn.textContent = '删除';
               delBtn.onclick = function(){
                   if (!confirm('确定删除预设 \"' + p.name + '\" ?')) return;
                   const presetsAll = _getBubblePresets();
                   presetsAll.splice(idx, 1);
                   _saveBubblePresets(presetsAll);
                   openManagePresetsModal();
                   populateBubblePresetSelect('bubble-preset-select'); populateBubblePresetSelect('group-bubble-preset-select');
               };

               btnWrap.appendChild(applyBtn);
               btnWrap.appendChild(renameBtn);
               btnWrap.appendChild(delBtn);
               row.appendChild(btnWrap);
               list.appendChild(row);
           });
           modal.style.display = 'flex';
       }

       // ==================================================================================================================
       // ======================================= 3. 人设预设管理 (USER PERSONA PRESET MANAGEMENT) =======================================
       // ==================================================================================================================
       function _getMyPersonaPresets() {
           return db.myPersonaPresets || [];
       }
       function _saveMyPersonaPresets(arr) {
           db.myPersonaPresets = arr || [];
           saveData();
       }

       function populateMyPersonaSelect() {
           const sel = document.getElementById('mypersona-preset-select');
           if (!sel) return;
           const presets = _getMyPersonaPresets();
           sel.innerHTML = '<option value="">— 选择预设 —</option>';
           presets.forEach(p => {
               const opt = document.createElement('option');
               opt.value = p.name;
               opt.textContent = p.name;
               sel.appendChild(opt);
           });
       }

       function saveCurrentMyPersonaAsPreset() {
           const personaEl = document.getElementById('setting-my-persona');
           const avatarEl = document.getElementById('setting-my-avatar-preview');
           if (!personaEl || !avatarEl) return (window.showToast && showToast('找不到我的人设或头像控件')) || alert('找不到我的人设或头像控件');
           const persona = personaEl.value.trim();
           const avatar = avatarEl.src || '';
           if (!persona && !avatar) return (window.showToast && showToast('人设和头像都为空，无法保存')) || alert('人设和头像都为空，无法保存');
           const name = prompt('请输入预设名称（将覆盖同名预设）：');
           if (!name) return;
           const presets = _getMyPersonaPresets();
           const idx = presets.findIndex(p => p.name === name);
           const preset = { name, persona, avatar };
           if (idx >= 0) presets[idx] = preset; else presets.push(preset);
           _saveMyPersonaPresets(presets);
           populateMyPersonaSelect();
           (window.showToast && showToast('我的人设预设已保存')) || console.log('我的人设预设已保存');
       }

       async function applyMyPersonaPresetToCurrentChat(presetName) {
           const presets = _getMyPersonaPresets();
           const p = presets.find(x => x.name === presetName);
           if (!p) { (window.showToast && showToast('未找到该预设')) || alert('未找到该预设'); return; }

           const personaEl = document.getElementById('setting-my-persona');
           const avatarEl = document.getElementById('setting-my-avatar-preview');
           if (personaEl) personaEl.value = p.persona || '';
           if (avatarEl) avatarEl.src = p.avatar || '';

           try {
               if (currentChatType === 'private') {
                   const e = db.characters.find(c => c.id === currentChatId);
                   if (e) {
                       e.myPersona = p.persona || '';
                       e.myAvatar = p.avatar || '';
                       await saveData();
                       (window.showToast && showToast('预设已应用并保存到当前聊天')) || console.log('预设已应用');
                       if (typeof loadSettingsToSidebar === 'function') try{ loadSettingsToSidebar(); }catch(e){}
                       if (typeof renderChatList === 'function') try{ renderChatList(); }catch(e){}
                   }
               } else {
                   (window.showToast && showToast('预设已应用到界面（未检测到当前聊天保存入口）')) || console.log('预设已应用到界面');
               }
           } catch(err) {
               console.error('applyMyPersonaPresetToCurrentChat error', err);
           }
       }

       function openManageMyPersonaModal() {
           const modal = document.getElementById('mypersona-presets-modal');
           const list = document.getElementById('mypersona-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getMyPersonaPresets();
           if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 0';
               row.style.borderBottom = '1px solid #f0f0f0';

               const nameDiv = document.createElement('div');
               nameDiv.style.flex = '1';
               nameDiv.style.whiteSpace = 'nowrap';
               nameDiv.style.overflow = 'hidden';
               nameDiv.style.textOverflow = 'ellipsis';
               nameDiv.textContent = p.name;
               row.appendChild(nameDiv);

               const btnWrap = document.createElement('div');
               btnWrap.style.display = 'flex';
               btnWrap.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn btn-primary';
               applyBtn.style.padding = '6px 8px;border-radius:8px';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyMyPersonaPresetToCurrentChat(p.name); modal.style.display = 'none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.style.padding = '6px 8px;border-radius:8px';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const all = _getMyPersonaPresets();
                   all[idx].name = newName;
                   _saveMyPersonaPresets(all);
                   openManageMyPersonaModal();
                   populateMyPersonaSelect();
               };

               const deleteBtn = document.createElement('button');
               deleteBtn.className = 'btn';
               deleteBtn.style.padding = '6px 8px;border-radius:8px;color:#e53935';
               deleteBtn.textContent = '删除';
               deleteBtn.onclick = function(){
                   if (!confirm('确认删除该预设？')) return;
                   const all = _getMyPersonaPresets();
                   all.splice(idx,1);
                   _saveMyPersonaPresets(all);
                   openManageMyPersonaModal();
                   populateMyPersonaSelect();
               };

               btnWrap.appendChild(applyBtn);
               btnWrap.appendChild(renameBtn);
               btnWrap.appendChild(deleteBtn);
               row.appendChild(btnWrap);

               list.appendChild(row);
           });

           modal.style.display = 'flex';
       }

        function updateClock() {
            const now = new Date();
            const timeString = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const dateString = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;

            const homeTimeDisplay = document.getElementById('time-display');
            const homeDateDisplay = document.getElementById('date-display');
            if (homeTimeDisplay) homeTimeDisplay.textContent = timeString;
            if (homeDateDisplay) homeDateDisplay.textContent = dateString;

            const peekTimeDisplay = document.getElementById('peek-time-display');
            const peekDateDisplay = document.getElementById('peek-date-display');
            if (peekTimeDisplay) peekTimeDisplay.textContent = timeString;
            if (peekDateDisplay) peekDateDisplay.textContent = dateString;
        }

        function updatePageIndicator(index) {
            const dots = document.querySelectorAll('.page-indicator .dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        // --- App Setup Functions ---
        
        // ==================================================================================================================
        // ========================================== 角色卡导入 (CHARACTER IMPORT) ==========================================
        // ==================================================================================================================
        
        /**
         * 处理角色卡文件导入
         * @param {File} file - 用户选择的文件
         */
        async function handleCharacterImport(file) {
            if (!file) return;

            showToast('正在导入角色卡...');

            try {
                if (file.name.endsWith('.png')) {
                    await parseCharPng(file);
                } else if (file.name.endsWith('.json')) {
                    await parseCharJson(file);
                } else {
                    throw new Error('不支持的文件格式。请选择 .png 或 .json 文件。');
                }
            } catch (error) {
                console.error('角色卡导入失败:', error);
                showToast(`导入失败: ${error.message}`);
            }
        }

        /**
         * 解析PNG角色卡
         * @param {File} file - PNG文件
         */
        function parseCharPng(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = (e) => {
                    try {
                        const buffer = e.target.result;
                        const view = new DataView(buffer);

                        // 1. 验证PNG文件签名 (PNG signature)
                        const signature = [137, 80, 78, 71, 13, 10, 26, 10];
                        for (let i = 0; i < signature.length; i++) {
                            if (view.getUint8(i) !== signature[i]) {
                                return reject(new Error('文件不是一个有效的PNG。'));
                            }
                        }

                        let offset = 8; // 跳过8字节的签名
                        let charaData = null;

                        // 2. 遍历PNG数据块 (chunks)
                        while (offset < view.byteLength) {
                            const length = view.getUint32(offset); // 数据块内容的长度
                            const type = String.fromCharCode(view.getUint8(offset + 4), view.getUint8(offset + 5), view.getUint8(offset + 6), view.getUint8(offset + 7));
                            
                            // 3. 寻找tEXt文本块
                            if (type === 'tEXt') {
                                const textChunk = new Uint8Array(buffer, offset + 8, length);
                                
                                // 寻找关键字和数据之间的空字符分隔符
                                let separatorIndex = -1;
                                for(let i = 0; i < textChunk.length; i++) {
                                    if (textChunk[i] === 0) {
                                        separatorIndex = i;
                                        break;
                                    }
                                }

                                if (separatorIndex !== -1) {
                                    const keyword = new TextDecoder('utf-8').decode(textChunk.slice(0, separatorIndex));
                                    
                                    // 4. 检查关键字是否为 'chara'
                                    if (keyword === 'chara') {
                                        const base64Data = new TextDecoder('utf-8').decode(textChunk.slice(separatorIndex + 1));
                                        
                                        // 5. 解码Base64数据
                                        try {
                                            const decodedString = atob(base64Data);
                                            const bytes = new Uint8Array(decodedString.length);
                                            for (let i = 0; i < decodedString.length; i++) {
                                                bytes[i] = decodedString.charCodeAt(i);
                                            }
                                            const utf8Decoder = new TextDecoder('utf-8');
                                            charaData = JSON.parse(utf8Decoder.decode(bytes));
                                            break; // 找到数据后就停止遍历
                                        } catch (decodeError) {
                                            return reject(new Error(`解析角色数据失败: ${decodeError.message}`));
                                        }
                                    }
                                }
                            }
                            
                            // 移动到下一个数据块 (长度 + 类型 + 内容 + CRC校验 = 4 + 4 + length + 4)
                            offset += 12 + length;
                        }

                        if (charaData) {
                            // 6. 将PNG文件本身转换为头像的Data URL
                            const imageReader = new FileReader();
                            imageReader.readAsDataURL(file);
                            imageReader.onload = (imgEvent) => {
                                createCharacterFromData(charaData, imgEvent.target.result);
                                resolve();
                            };
                            imageReader.onerror = () => {
                                // 即使头像转换失败，也用默认头像创建角色
                                createCharacterFromData(charaData, 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg');
                                resolve();
                            };
                        } else {
                            reject(new Error('在PNG中未找到有效的角色数据 (tEXt chunk not found or invalid)。'));
                        }
                    } catch (error) {
                        reject(new Error(`解析PNG失败: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('读取PNG文件失败。'));
            });
        }

        /**
         * 解析JSON角色卡
         * @param {File} file - JSON文件
         */
        function parseCharJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                // 强制使用UTF-8解码
                reader.readAsText(file, 'UTF-8');
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // JSON卡没有内置头像，使用默认头像
                        createCharacterFromData(data, 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg');
                        resolve();
                    } catch (error) {
                        reject(new Error(`解析JSON失败: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('读取JSON文件失败。'));
            });
        }

        /**
         * 根据导入的数据创建新角色
         * @param {object} data - 从卡片解析出的角色数据
         * @param {string} avatar - Base64格式的头像数据
         */
        async function createCharacterFromData(data, avatar) {
            // 优先使用 data.data 结构（针对哈基米.json格式），同时保留对根级别数据的兼容
            const charData = data.data || data;

            if (!charData || !charData.name) {
                throw new Error('角色卡数据无效，缺少角色名称。');
            }

            // 数据映射：将导入卡片的字段映射到本应用的字段
            const newChar = {
                id: `char_${Date.now()}`,
                realName: charData.name || '未命名',
                remarkName: charData.name || '未命名',
                persona: charData.description || charData.persona || '',
                avatar: avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                myName: '',
                myPersona: '',
                myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                theme: 'white_pink',
                maxMemory: 10,
                chatBg: '',
                history: [],
                isPinned: false,
                status: '在线',
                worldBookIds: [],
                useCustomBubbleCss: false,
                customBubbleCss: '',
                unreadCount: 0,
                memoryJournals: [],
                journalWorldBookIds: [],
                peekScreenSettings: { wallpaper: '', customIcons: {}, unlockAvatar: '' },
                lastUserMessageTimestamp: null,
            };

            // --- 新增：处理世界书 (兼容两种格式) ---
            const importedWorldBookIds = [];
            
            // 格式一：处理哈基米.json中的 character_book
            if (charData.character_book && Array.isArray(charData.character_book.entries)) {
                const categoryName = data.name || charData.name; // 优先使用根级的name作为分类名
                charData.character_book.entries.forEach(entry => {
                    const name = entry.comment;
                    const content = entry.content;
                    if (name && content) {
                        const existingBook = db.worldBooks.find(wb => wb.name.toLowerCase() === name.toLowerCase());
                        if (existingBook) {
                            if (!importedWorldBookIds.includes(existingBook.id)) {
                                importedWorldBookIds.push(existingBook.id);
                            }
                        } else {
                            const newBook = {
                                id: `wb_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                                name: name,
                                content: content,
                                position: 'after',
                                category: categoryName
                            };
                            db.worldBooks.push(newBook);
                            importedWorldBookIds.push(newBook.id);
                        }
                    }
                });
            }
            // 格式二：处理通用格式的 world_info / wi
            else {
                const worldInfo = charData.world_info || charData.wi || '';
                if (worldInfo && typeof worldInfo === 'string' && worldInfo.trim() !== '') {
                    const entries = worldInfo.split(/\n\s*\n/).filter(entry => entry.trim() !== '');
                    entries.forEach(entryText => {
                        const lines = entryText.trim().split('\n');
                        if (lines.length > 0) {
                            const name = lines[0].trim();
                            const content = lines.slice(1).join('\n').trim();
                            if (name && content) {
                                const existingBook = db.worldBooks.find(wb => wb.name.toLowerCase() === name.toLowerCase());
                                if (existingBook) {
                                    if (!importedWorldBookIds.includes(existingBook.id)) {
                                        importedWorldBookIds.push(existingBook.id);
                                    }
                                } else {
                                    const newBook = {
                                        id: `wb_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                                        name: name,
                                        content: content,
                                        position: 'after',
                                        category: '导入的角色设定'
                                    };
                                    db.worldBooks.push(newBook);
                                    importedWorldBookIds.push(newBook.id);
                                }
                            }
                        }
                    });
                }
            }
            
            if (importedWorldBookIds.length > 0) {
                newChar.worldBookIds = importedWorldBookIds;
                setTimeout(() => {
                    showToast(`同时导入了 ${importedWorldBookIds.length} 条世界书设定。`);
                }, 1600);
            }
            // --- 新增逻辑结束 ---

            db.characters.push(newChar);
            await saveData();
            renderChatList();
            showToast(`角色“${newChar.remarkName}”导入成功！`);
        }

        // ==================================================================================================================
        // ========================================== END CHARACTER IMPORT ==================================================
        // ==================================================================================================================

        let currentPageIndex = 0;
        function setupHomeScreen() {
            const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
            // Ensure insWidgetSettings exists with defaults
            if (!db.insWidgetSettings) {
                db.insWidgetSettings = {
                    avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                    bubble1: '„- ω -„',
                    avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                    bubble2: 'ｷ...✩'
                };
            }
            const insWidget = db.insWidgetSettings;

            const homeScreenHTML = `
            <div class="home-screen-swiper">
                <div class="home-screen-page">
                    <div class="home-widget-container">
                        <div class="central-circle" style="background-image: url('${db.homeWidgetSettings.centralCircleImage}');"></div>
                        <div class="satellite-oval oval-top-left" data-widget-part="topLeft">
                            <span class="satellite-emoji" contenteditable="true">${db.homeWidgetSettings.topLeft.emoji || '❤️'}</span>
                            <span class="satellite-text" contenteditable="true">${db.homeWidgetSettings.topLeft.text}</span>
                        </div>
                        <div class="satellite-oval oval-top-right" data-widget-part="topRight">
                            <span class="satellite-emoji" contenteditable="true">${db.homeWidgetSettings.topRight.emoji || '🧡'}</span>
                            <span class="satellite-text" contenteditable="true">${db.homeWidgetSettings.topRight.text}</span>
                        </div>
                        <div class="satellite-oval oval-bottom-left" data-widget-part="bottomLeft">
                            <span class="satellite-emoji" contenteditable="true">${db.homeWidgetSettings.bottomLeft.emoji || '💛'}</span>
                            <span class="satellite-text" contenteditable="true">${db.homeWidgetSettings.bottomLeft.text}</span>
                        </div>
                        <div class="satellite-oval oval-bottom-right" data-widget-part="bottomRight">
                            <span class="satellite-emoji" contenteditable="true">${db.homeWidgetSettings.bottomRight.emoji || '💙'}</span>
                            <span class="satellite-text" contenteditable="true">${db.homeWidgetSettings.bottomRight.text}</span>
                        </div>


                        <div class="widget-time" id="time-display"></div>
                        <div contenteditable="true" class="widget-signature" id="widget-signature" placeholder="编辑个性签名..."></div>
                        <div class="widget-date" id="date-display"></div>
                        <div class="widget-battery">
                            <svg width="32" height="23" viewBox="0 0 24 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1 2.5C1 1.94772 1.44772 1.5 2 1.5H20C20.5523 1.5 21 1.94772 21 2.5V9.5C21 10.0523 20.5523 10.5 20 10.5H2C1.44772 10.5 1 10.0523 1 9.5V2.5Z" stroke="#666" stroke-opacity="0.8" stroke-width="1"/>
                                <path d="M22.5 4V8" stroke="#666" stroke-opacity="0.8" stroke-width="1.5" stroke-linecap="round"/>
                                <rect id="battery-fill-rect" x="2" y="2.5" width="18" height="7" rx="0.5" fill="#666" fill-opacity="0.8"/>
                            </svg>
                            <span id="battery-level">--%</span>
                        </div>
                    </div>
                    <div class="app-grid">
                        <div class="app-grid-widget-container">
                           <div class="app-grid-widget">
                                <div class="ins-widget">
                                    <div class="ins-widget-row user">
                                        <img src="${insWidget.avatar1}" alt="Character Avatar" class="ins-widget-avatar" id="ins-widget-avatar-1">
                                        <div class="ins-widget-bubble" id="ins-widget-bubble-1" contenteditable="true">${insWidget.bubble1}</div>
                                    </div>
                                    <div class="ins-widget-divider"><span>୨୧</span></div>
                                    <div class="ins-widget-row character">
                                        <div class="ins-widget-bubble" id="ins-widget-bubble-2" contenteditable="true">${insWidget.bubble2}</div>
                                        <img src="${insWidget.avatar2}" alt="User Avatar" class="ins-widget-avatar" id="ins-widget-avatar-2">
                                    </div>
                                </div>
                           </div>
                        </div>
                        <a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="wallpaper-screen"><img src="${getIcon('wallpaper-screen')}" alt="Wallpaper" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="World Book" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="Customize" class="icon-img"><span class="app-name">${defaultIcons['customize-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="Tutorial" class="icon-img"><span class="app-name">${defaultIcons['tutorial-screen'].name}</span></a>
                        <div class="heart-photo-widget"></div>
                    </div>
                </div>

                <div class="home-screen-page">
                     <div class="app-grid">
                        <a href="#" class="app-icon" data-target="storage-analysis-screen"><img src="${getIcon('storage-analysis-screen')}" alt="存储分析" class="icon-img"><span class="app-name">${defaultIcons['storage-analysis-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="pomodoro-screen">
                            <img src="${getIcon('pomodoro-screen')}" alt="番茄钟" class="icon-img">
                            <span class="app-name">${defaultIcons['pomodoro-screen'].name}</span>
                        </a>
                        <a href="#" class="app-icon" data-target="forum-screen">
                            <img src="${getIcon('forum-screen')}" alt="论坛" class="icon-img">
                            <span class="app-name">${defaultIcons['forum-screen'].name}</span>
                        </a>
                        <a href="#" class="app-icon" data-target="music-screen">
    <img src="${getIcon('music-screen')}" alt="音乐" class="icon-img">
    <span class="app-name">${defaultIcons['music-screen'].name}</span>
</a>
                        <a href="#" class="app-icon" data-target="diary-screen">
                            <img src="${getIcon('diary-screen')}" alt="日记本" class="icon-img">
                            <span class="app-name">${defaultIcons['diary-screen'].name}</span>
                        </a>
                        <a href="#" class="app-icon" data-target="piggy-bank-screen">
                            <img src="${getIcon('piggy-bank-screen')}" alt="存钱罐" class="icon-img">
                            <span class="app-name">${defaultIcons['piggy-bank-screen'].name}</span>
                        </a>
                     </div>
                </div>

            </div>
            <div class="page-indicator">
                <span class="dot active" data-page="0"></span>
                <span class="dot" data-page="1"></span>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="日间" class="icon-img"></a>
                <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="夜间" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="font-settings-screen"><img src="${getIcon('font-settings-screen')}" alt="字体" class="icon-img"></a>
            </div>`;
            homeScreen.innerHTML = homeScreenHTML;

           const polaroidImage = db.homeWidgetSettings?.polaroidImage;
           if (polaroidImage) {
               updatePolaroidImage(polaroidImage);
           }

            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            document.getElementById('day-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('day');
            });
            document.getElementById('night-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('night');
            });
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
            updateBatteryStatus();

            const homeWidgetContainer = homeScreen.querySelector('.home-widget-container');

            // --- Central Circle Click ---
            const centralCircle = homeWidgetContainer.querySelector('.central-circle');
            if (centralCircle) {
                centralCircle.addEventListener('click', () => {
                    const modal = document.getElementById('ins-widget-avatar-modal');
                    const form = document.getElementById('ins-widget-avatar-form');
                    const preview = document.getElementById('ins-widget-avatar-preview');
                    const urlInput = document.getElementById('ins-widget-avatar-url-input');
                    const fileUpload = document.getElementById('ins-widget-avatar-file-upload');
                    const targetInput = document.getElementById('ins-widget-avatar-target');

                    targetInput.value = 'centralCircle'; // Special target
                    preview.style.backgroundImage = `url("${db.homeWidgetSettings.centralCircleImage}")`;
                    preview.innerHTML = '';
                    urlInput.value = '';
                    fileUpload.value = null;
                    modal.classList.add('visible');
                });
            }

            // --- Blur to Save Logic ---
            homeScreen.addEventListener('blur', async (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const oval = target.closest('.satellite-oval');
                    if (oval) { // It's one of the satellite ovals
                        const part = oval.dataset.widgetPart;
                        const prop = target.classList.contains('satellite-emoji') ? 'emoji' : 'text';
                        const newValue = target.textContent.trim();

                        if (db.homeWidgetSettings[part] && db.homeWidgetSettings[part][prop] !== newValue) {
                            db.homeWidgetSettings[part][prop] = newValue;
                            await saveData();
                            showToast('小组件已更新');
                        }
                    } else if (target.id === 'widget-signature') { // It's the signature
                        const newSignature = target.textContent.trim();
                        if (db.homeSignature !== newSignature) {
                            db.homeSignature = newSignature;
                            await saveData();
                            showToast('签名已保存');
                        }
                    } else if (target.id === 'ins-widget-bubble-1' || target.id === 'ins-widget-bubble-2') { // It's the INS widget
                         const bubbleId = target.id === 'ins-widget-bubble-1' ? 'bubble1' : 'bubble2';
                         const newText = target.textContent.trim();
                         if (db.insWidgetSettings[bubbleId] !== newText) {
                             db.insWidgetSettings[bubbleId] = newText;
                             await saveData();
                             showToast('小组件文字已保存');
                         }
                    }
                }
            }, true); // Use capture phase
            
            const signatureWidget = document.getElementById('widget-signature');
            if (signatureWidget) {
                signatureWidget.textContent = db.homeSignature || '';
            }


            // --- Home Screen Swipe Logic ---
            const swiper = homeScreen.querySelector('.home-screen-swiper');
            let touchStartX = 0;
            let touchEndX = 0;
            // currentPageIndex is now global
            const totalPages = 2;
            const swipeThreshold = 50; // Minimum distance for a swipe
            let isDragging = false;

            // Apply initial state based on global currentPageIndex
            swiper.style.transform = `translateX(-${currentPageIndex * 100 / totalPages}%)`;
            updatePageIndicator(currentPageIndex);

            // --- Touch Events ---
            swiper.addEventListener('touchstart', (e) => {
                if (e.target.closest('[contenteditable]')) return; // <-- 新增这行
                // No longer need to check for target, the whole area is swipeable
                isDragging = true;
                touchStartX = e.changedTouches[0].screenX;
                touchEndX = e.changedTouches[0].screenX; // Reset on start
            }, { passive: true });

            swiper.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                touchEndX = e.changedTouches[0].screenX;
            }, { passive: true });

            swiper.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                handleSwipe();
            });

            // --- Mouse Events ---
            swiper.addEventListener('mousedown', (e) => {
                if (e.target.closest('[contenteditable]')) return; // <-- 新增这行
                // Prevent default browser action (like dragging a link)
                e.preventDefault();
                isDragging = true;
                touchStartX = e.screenX;
                touchEndX = e.screenX; // Reset on start
                swiper.style.cursor = 'grabbing';
            });

            swiper.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    touchEndX = e.screenX;
                }
            });

            swiper.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    swiper.style.cursor = 'grab';
                    handleSwipe();
                }
            });

            swiper.addEventListener('mouseleave', (e) => {
                if (isDragging) {
                    isDragging = false;
                    swiper.style.cursor = 'grab';
                    // Reset positions to cancel swipe
                    touchStartX = 0;
                    touchEndX = 0;
                }
            });

            function handleSwipe() {
                if (touchEndX === 0 && touchStartX === 0) return; // Swipe was cancelled by mouseleave
                
                const deltaX = touchEndX - touchStartX;

                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX < 0 && currentPageIndex < totalPages - 1) {
                        currentPageIndex++;
                    } else if (deltaX > 0 && currentPageIndex > 0) {
                        currentPageIndex--;
                    }
                }
                
                swiper.style.transform = `translateX(-${currentPageIndex * 100 / totalPages}%)`;
                updatePageIndicator(currentPageIndex);

                // Reset positions
                touchStartX = 0;
                touchEndX = 0;
            }

            // 新增：处理失焦的逻辑
            homeScreen.addEventListener('click', (e) => {
                const activeEl = document.activeElement;
                if (activeEl && activeEl.hasAttribute('contenteditable') && e.target !== activeEl) {
                    activeEl.blur();
                }
            });

            // 新增：限制emoji小组件只能输入一个字符
            homeScreen.querySelectorAll('.satellite-emoji').forEach(span => {
                span.addEventListener('input', (e) => {
                    const chars = [...e.target.textContent];
                    if (chars.length > 1) {
                        e.target.textContent = chars[0];
                        // 重新聚焦并把光标移动到末尾
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(e.target);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                });
            });
        }

        function applyWallpaper(url) {
            homeScreen.style.backgroundImage = `url(${url})`;
        }

        async function applyHomeScreenMode(mode) {
            if (mode === 'day') {
                homeScreen.classList.add('day-mode');
            } else {
                homeScreen.classList.remove('day-mode');
            }
            db.homeScreenMode = mode;
            await saveData();
        }

                function setupCustomizeApp() {
            customizeForm.addEventListener('input', async (e) => {
                const target = e.target;

                // --- 处理应用图标的逻辑 ---
                if (target.dataset.iconId) { // 修改这里，统一使用一个标识
                    const iconId = target.dataset.iconId;
                    const newUrl = target.value.trim();
                    const previewImg = document.getElementById(`icon-preview-${iconId}`);
                    if (newUrl) {
                        if (!db.customIcons) db.customIcons = {}; // 确保 customIcons 已初始化
                        db.customIcons[iconId] = newUrl;
                        if(previewImg) previewImg.src = newUrl;
                    }
                // --- 新增：处理小部件的逻辑 ---
                } else if (target.dataset.widgetPart) {
                    const part = target.dataset.widgetPart;
                    const prop = target.dataset.widgetProp;
                    const newValue = target.value.trim();

                    if (prop) { // 这是小椭圆 (有prop属性)
                        db.homeWidgetSettings[part][prop] = newValue;
                    } else { // 这是中央大圆 (没有prop属性)
                        db.homeWidgetSettings[part] = newValue;
                    }
                }

                await saveData();
                setupHomeScreen(); // 实时刷新主页
            });
            customizeForm.addEventListener('click', async (e) => {
                // --- 处理重置应用图标的逻辑 ---
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.id;
                    if (db.customIcons) {
                        delete db.customIcons[iconId];
                    }
                    await saveData();
                    renderCustomizeForm(); // 重新渲染自定义页
                    setupHomeScreen(); // 刷新主页
                    showToast('图标已重置');
                }

                // --- 新增：处理重置小部件的逻辑 ---
                if (e.target.matches('#reset-widget-btn')) {
                    if (confirm('确定要将小部件恢复为默认设置吗？')) {
                        db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
                        await saveData();
                        renderCustomizeForm(); // 重新渲染自定义页
                        setupHomeScreen(); // 刷新主页
                        showToast('小部件已恢复默认');
                    }
                }

                // --- 新增：处理重置小部件的逻辑 ---
                if (e.target.matches('#reset-widget-btn')) {
                    if (confirm('确定要将小部件恢复为默认设置吗？')) {
                        db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
                        await saveData();
                        renderCustomizeForm(); // 重新渲染自定义页
                        setupHomeScreen(); // 刷新主页
                        showToast('小部件已恢复默认');
                    }
                }
            });

         customizeForm.addEventListener('change', async (e) => {
             if (e.target.matches('.widget-upload-input')) {
                 const file = e.target.files[0];
                 if (!file) return;
 
                 const widgetPart = e.target.dataset.widgetTarget;
                 const widgetProp = e.target.dataset.widgetProp;
 
                 try {
                     const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                     
                     let targetInput;
                     if (widgetProp) {
                         targetInput = document.getElementById(`widget-input-${widgetPart}-${widgetProp}`);
                     } else {
                         targetInput = document.getElementById(`widget-input-${widgetPart}`);
                     }
 
                     if (targetInput) {
                         targetInput.value = compressedUrl;
                         // Manually trigger an input event to save the data
                         targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                         showToast('图片已上传并压缩');
                     }
                 } catch (error) {
                     console.error('Widget image compression failed:', error);
                     showToast('图片压缩失败，请重试');
                 } finally {
                     e.target.value = null; // Reset file input
                 }
             }
         });
        }

                function renderCustomizeForm() {
            customizeForm.innerHTML = ''; // 清空旧内容

            // --- 1. 应用图标自定义部分 ---
            const iconOrder = [
                'chat-list-screen', 'api-settings-screen', 'wallpaper-screen',
                'world-book-screen', 'customize-screen', 'tutorial-screen',
                'font-settings-screen', 'day-mode-btn', 'night-mode-btn', 'forum-screen', 'music-screen', 'diary-screen', 'piggy-bank-screen', 'pomodoro-screen', 'storage-analysis-screen'
            ];

            let iconsContentHTML = '';
            iconOrder.forEach(id => {
                const { name, url } = defaultIcons[id];
                const currentIcon = (db.customIcons && db.customIcons[id]) || url;
                iconsContentHTML += `
                <div class="icon-custom-item">
                    <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                    <div class="icon-details">
                        <p>${name || '模式切换'}</p>
                        <input type="url" class="form-group" placeholder="粘贴新的图标URL" value="${(db.customIcons && db.customIcons[id]) || ''}" data-icon-id="${id}">
                    </div>
                    <button type="button" class="reset-icon-btn" data-id="${id}">重置</button>
                </div>`;
            });

            const iconsSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    ${iconsContentHTML}
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', iconsSectionHTML);

            // --- 2. 主页小部件自定义部分 ---
            const widgetSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>主页小部件</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <p style="font-size: 14px; color: #666; margin-bottom: 20px; text-align: center;">主屏幕上的小组件内容可以直接点击编辑，失焦后自动保存。<br>中央头像则是在主屏幕点击后弹窗更换。</p>
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                         <button type="button" id="reset-widget-btn" class="btn btn-neutral btn-small">恢复默认</button>
                    </div>
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', widgetSectionHTML);

            // --- 3. 全局CSS美化部分 ---
            const globalCssSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>全局CSS美化</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="global-beautification-css" style="font-weight: bold; font-size: 1.1em; color: var(--primary-color); margin-bottom: 0;">全局美化CSS代码</label>
                            <button type="button" id="apply-global-css-now-btn" class="btn btn-primary btn-small">立即应用</button>
                        </div>
                        <textarea id="global-beautification-css" class="form-group" rows="8" placeholder="在此输入CSS代码... 您的创造力没有边界！"></textarea>
                    </div>
                    <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <label for="global-css-preset-select" style="width:auto;color:var(--muted,#667);font-size:13px; font-weight: bold;">全局样式预设库</label>
                            <select id="global-css-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">-- 选择预设 --</option></select>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;justify-content: flex-end;">
                            <button type="button" id="global-css-apply-btn" class="btn btn-primary" style="padding:7px 10px;border-radius:8px;">应用预设</button>
                            <button type="button" id="global-css-save-btn" class="btn" style="padding:7px 10px;border-radius:8px;">存为预设</button>
                            <button type="button" id="global-css-manage-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', globalCssSectionHTML);

            // 填充预设下拉框
            populateGlobalCssPresetSelect();

            // --- 新增：为所有折叠标题添加一个点击事件监听器 ---
            customizeForm.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                   header.parentElement.classList.toggle('open');
                });
            });

            // 重新绑定之前已有的事件监听器
            const globalCssTextarea = document.getElementById('global-beautification-css');
            if (globalCssTextarea) {
                globalCssTextarea.value = db.globalCss || '';
            }
    
            // --- NEW: Update Log Functions ---
            function renderUpdateLog() {
                const tutorialContent = document.getElementById('tutorial-content-area');
                if (!tutorialContent) return;
    
                const updateSection = document.createElement('div');
                updateSection.className = 'tutorial-item'; // Use tutorial-item class, default open
    
                let notesHtml = '';
                updateLog.forEach((log, index) => {
                    notesHtml += `
                        <div style="margin-bottom: 15px; ${index < updateLog.length - 1 ? 'padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;' : ''}">
                            <h4 style="font-size: 15px; color: #333; margin: 0 0 5px 0;">版本 ${log.version} (${log.date})</h4>
                            <ul style="padding-left: 20px; margin: 0; list-style-type: '› ';">
                                ${log.notes.map(note => `<li style="margin-bottom: 5px; color: #666;">${note}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
    
                updateSection.innerHTML = `
                    <div class="tutorial-header">更新日志</div>
                    <div class="tutorial-content" style="padding-top: 15px;">
                        ${notesHtml}
                    </div>
                `;
                
                tutorialContent.appendChild(updateSection);
            }
    
            function showUpdateModal() {
                const modal = document.getElementById('update-log-modal');
                const contentEl = document.getElementById('update-log-modal-content');
                const closeBtn = document.getElementById('close-update-log-modal');
    
                const latestLog = updateLog[0];
                if (!latestLog) return;
    
                contentEl.innerHTML = `
                    <h4>版本 ${latestLog.version} (${latestLog.date})</h4>
                    <ul>
                        ${latestLog.notes.map(note => `<li>${note}</li>`).join('')}
                    </ul>
                    <p style="font-size: 12px; color: #888; text-align: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">过往更新说明可在“教程”应用内查看。</p>
                `;
    
                modal.classList.add('visible');
    
                closeBtn.onclick = () => {
                    modal.classList.remove('visible');
                    localStorage.setItem('lastSeenVersion', appVersion);
                };
            }
    
            function checkForUpdates() {
                const lastSeenVersion = localStorage.getItem('lastSeenVersion');
                if (lastSeenVersion !== appVersion) {
                    // Use a small delay to ensure the main UI has rendered
                    setTimeout(showUpdateModal, 500);
                }
            }
            const applyGlobalCssNowBtn = document.getElementById('apply-global-css-now-btn');
            if (applyGlobalCssNowBtn) {
                applyGlobalCssNowBtn.addEventListener('click', async () => {
                    const newCss = globalCssTextarea.value;
                    db.globalCss = newCss;
                    applyGlobalCss(newCss);
                    await saveData();
                    showToast('全局样式已应用');
                });
            }
            const globalCssApplyBtn = document.getElementById('global-css-apply-btn');
            if (globalCssApplyBtn) {
                globalCssApplyBtn.addEventListener('click', () => {
                    const select = document.getElementById('global-css-preset-select');
                    const presetName = select.value;
                    if (!presetName) return showToast('请选择一个预设');
                    const preset = db.globalCssPresets.find(p => p.name === presetName);
                    if (preset) {
                        globalCssTextarea.value = preset.css;
                        db.globalCss = preset.css;
                        applyGlobalCss(preset.css);
                        saveData();
                        showToast('全局CSS预设已应用');
                    }
                });
            }
            const globalCssSaveBtn = document.getElementById('global-css-save-btn');
            if (globalCssSaveBtn) {
                 globalCssSaveBtn.addEventListener('click', () => {
                    const css = globalCssTextarea.value.trim();
                    if (!css) return showToast('CSS内容为空，无法保存');
                    const name = prompt('请输入此预设的名称（同名将覆盖）:');
                    if (!name) return;
                    if (!db.globalCssPresets) db.globalCssPresets = [];
                    const existingIndex = db.globalCssPresets.findIndex(p => p.name === name);
                    if (existingIndex > -1) {
                        db.globalCssPresets[existingIndex].css = css;
                    } else {
                        db.globalCssPresets.push({ name, css });
                    }
                    saveData();
                    populateGlobalCssPresetSelect();
                    showToast('全局CSS预设已保存');
                });
            }
            const globalCssManageBtn = document.getElementById('global-css-manage-btn');
            if (globalCssManageBtn) {
                 globalCssManageBtn.addEventListener('click', openGlobalCssManageModal);
            }
        }


        function setupTutorialApp() {
            tutorialContentArea.addEventListener('click', (e) => {
                const header = e.target.closest('.tutorial-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });
        }

        // --- NEW: Update Log Functions ---
        function renderUpdateLog() {
            const tutorialContent = document.getElementById('tutorial-content-area');
            if (!tutorialContent) return;

            const updateSection = document.createElement('div');
            updateSection.className = 'tutorial-item'; // Use tutorial-item class, default open

            let notesHtml = '';
            updateLog.forEach((log, index) => {
                notesHtml += `
                    <div style="margin-bottom: 15px; ${index < updateLog.length - 1 ? 'padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;' : ''}">
                        <h4 style="font-size: 15px; color: #333; margin: 0 0 5px 0;">版本 ${log.version} (${log.date})</h4>
                        <ul style="padding-left: 20px; margin: 0; list-style-type: '› ';">
                            ${log.notes.map(note => `<li style="margin-bottom: 5px; color: #666;">${note}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            updateSection.innerHTML = `
                <div class="tutorial-header">更新日志</div>
                <div class="tutorial-content" style="padding-top: 15px;">
                    ${notesHtml}
                </div>
            `;
            
            tutorialContent.appendChild(updateSection);
        }

        function showUpdateModal() {
            const modal = document.getElementById('update-log-modal');
            const contentEl = document.getElementById('update-log-modal-content');
            const closeBtn = document.getElementById('close-update-log-modal');

            const latestLog = updateLog[0];
            if (!latestLog) return;

            contentEl.innerHTML = `
                <h4>版本 ${latestLog.version} (${latestLog.date})</h4>
                <ul>
                    ${latestLog.notes.map(note => `<li>${note}</li>`).join('')}
                </ul>
                <p style="font-size: 12px; color: #888; text-align: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">过往更新说明可在“教程”应用内查看。</p>
            `;

            modal.classList.add('visible');

            closeBtn.onclick = () => {
                modal.classList.remove('visible');
                localStorage.setItem('lastSeenVersion', appVersion);
            };
        }

        function checkForUpdates() {
            const lastSeenVersion = localStorage.getItem('lastSeenVersion');
            if (lastSeenVersion !== appVersion) {
                // Use a small delay to ensure the main UI has rendered
                setTimeout(showUpdateModal, 500);
            }
        }
        let loadingBtn = false

        function renderTutorialContent() {
            const tutorials = [
                {title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg']},
                {
                    title: '软件介绍',
                    imageUrls: ['https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg']
                },
                {
                    title: '404',
                    imageUrls: ['https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg']
                },
                {title: '404-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg']}
            ];
            tutorialContentArea.innerHTML = '';
            renderUpdateLog();
            tutorials.forEach(tutorial => {
                const item = document.createElement('div');
                item.className = 'tutorial-item';
                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title}教程图片">`).join('');
                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                tutorialContentArea.appendChild(item);
            });

            const backupDataBtn = document.createElement('button');
            backupDataBtn.className = 'btn btn-primary';
            backupDataBtn.textContent = '备份数据';
            backupDataBtn.disabled = loadingBtn

            backupDataBtn.addEventListener('click', async () => {
                if(loadingBtn){
                    return
                }
                loadingBtn = true
                try {
                    showToast('正在准备导出数据...');

                    // 创建完整的数据备份对象
                    const fullBackupData = await createFullBackupData();

                    const jsonString = JSON.stringify(fullBackupData);
                    const dataBlob = new Blob([jsonString]);

                    // Compress the data using Gzip
                    const compressionStream = new CompressionStream('gzip');
                    const compressedStream = dataBlob.stream().pipeThrough(compressionStream);
                    const compressedBlob = await new Response(compressedStream, { headers: { 'Content-Type': 'application/octet-stream' } }).blob();

                    const url = URL.createObjectURL(compressedBlob);
                    const a = document.createElement('a');
                    const now = new Date();
                    const date = now.toISOString().slice(0, 10);
                    const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    a.href = url;
                    a.download = `章鱼喷墨_备份数据_${date}_${time}.ee`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    loadingBtn = false
                    showToast('聊天记录导出成功');
                }catch (e){
                    loadingBtn = false
                    showToast(`导出失败, 发生错误: ${e.message}`);
                    console.error('导出错误详情:', e);
                }
            });
            const importDataBtn = document.createElement('label');
            importDataBtn.className = 'btn btn-neutral';
            importDataBtn.textContent = '导入数据';
            importDataBtn.style.marginTop = '15px'
            importDataBtn.style.display = 'block'
            importDataBtn.disabled = loadingBtn;
            importDataBtn.setAttribute('for', 'import-data-input')
            document.querySelector('#import-data-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if(confirm('此操作将覆盖当前所有聊天记录和设置。此操作不可撤销。确定要继续吗？')){
                    try {
                        showToast('正在导入数据，请稍候...');

                        // Decompress the file stream
                        const decompressionStream = new DecompressionStream('gzip');
                        const decompressedStream = file.stream().pipeThrough(decompressionStream);
                        const jsonString = await new Response(decompressedStream).text();

                        let data = JSON.parse(jsonString);

                        // 检测数据格式并进行兼容性处理
                        const importResult = await importBackupData(data);

                        if (importResult.success) {
                            showToast(`数据导入成功！${importResult.message} 应用即将刷新。`);
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showToast(`导入失败: ${importResult.error}`);
                        }
                    } catch (error) {
                        console.error("导入失败:", error);
                        showToast(`解压或解析文件时发生错误: ${error.message}`);
                    } finally {
                        event.target.value = null;
                    }
                }else {
                    event.target.value = null;
                }

            })

            tutorialContentArea.appendChild(backupDataBtn);
            tutorialContentArea.appendChild(importDataBtn);
        }

        // --- Chat List & Chat Room ---
        function setupChatListScreen() {
            renderChatList();
            addChatBtn.addEventListener('click', () => {
                addCharModal.classList.add('visible');
                addCharForm.reset();
            });

            // --- 新增：导入角色卡按钮事件 ---
            const importBtn = document.getElementById('import-character-card-btn');
            const cardInput = document.getElementById('character-card-input');
            importBtn.addEventListener('click', () => {
                cardInput.click();
            });
            cardInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleCharacterImport(file);
                }
                // 重置输入框，以便可以再次选择相同的文件
                e.target.value = null;
            });
            // --- 新增结束 ---
            chatListContainer.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    currentChatId = chatItem.dataset.id;
                    currentChatType = chatItem.dataset.type;
                    openChatRoom(currentChatId, currentChatType);
                }
            });
            chatListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
            });
            chatListContainer.addEventListener('touchstart', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);
                }, 400);
            });
            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleChatListLongPress(chatId, chatType, x, y) {
            clearTimeout(longPressTimer);
            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chatItem) return;
            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
            const menuItems = [{
                label: chatItem.isPinned ? '取消置顶' : '置顶聊天',
                action: async () => {
                    chatItem.isPinned = !chatItem.isPinned;
                    await saveData();
                    renderChatList();
                }
            }, {
                label: '删除聊天',
                danger: true,
                action: async () => {
                    if (confirm(`确定要删除与“${itemName}”的聊天记录吗？此操作不可恢复。`)) {
                        if (chatType === 'private') {
                            await dexieDB.characters.delete(chatId);
                            db.characters = db.characters.filter(c => c.id !== chatId);
                        } else {
                            await dexieDB.groups.delete(chatId);
                            db.groups = db.groups.filter(g => g.id !== chatId);
                        }
                        // No need to call saveData() as we've directly manipulated the DB and in-memory object.
                        renderChatList();
                        showToast('聊天已删除');
                    }
                }
            }];
            createContextMenu(menuItems, x, y);
        }

        function renderChatList() {
            chatListContainer.innerHTML = '';
            const allChats = [...db.characters.map(c => ({...c, type: 'private'})), ...db.groups.map(g => ({
                ...g,
                type: 'group'
            }))];
            noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
            const sortedChats = allChats.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                return lastMsgTimeB - lastMsgTimeA;
            });
            sortedChats.forEach(chat => {
                let lastMessageText = '开始聊天吧...';
                if (chat.history && chat.history.length > 0) {
                    const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/;
                    const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
                    if (visibleHistory.length > 0) {
                        const lastMsg = visibleHistory[visibleHistory.length - 1];
                        const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                        const imageRecogRegex = /\[.*?发来了一张图片：\]/
                        const voiceRegex = /\[.*?的语音：.*?\]/;
                        const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;
                        const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]|\[.*?向.*?转账：.*?元.*?\]/;
                        const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;
                        const giftRegex = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/;
                        // ▼▼▼ 新增 NAI 预览规则 ▼▼▼
                        const naiRegex = /\[.*?的消息：NAI 正在作画中... 🎨\]/;
                        // ▲▲▲ 新增结束 ▲▲▲

                        if (giftRegex.test(lastMsg.content)) {
                            lastMessageText = '[礼物]';
                        // ▼▼▼ 新增 NAI 渲染规则 ▼▼▼
                        } else if (lastMsg.type === 'naiimag') {
                            lastMessageText = '[NovelAI图片]';
                        } else if (naiRegex.test(lastMsg.content)) {
                            lastMessageText = 'NAI 正在作画中... 🎨';
                        // ▲▲▲ 新增结束 ▲▲▲
                        } else if (stickerRegex.test(lastMsg.content)) {
                            lastMessageText = '[表情包]';
                        } else if (voiceRegex.test(lastMsg.content)) {
                            lastMessageText = '[语音]';
                        } else if (photoVideoRegex.test(lastMsg.content)) {
                            lastMessageText = '[照片/视频]';
                        } else if (transferRegex.test(lastMsg.content)) {
                            lastMessageText = '[转账]';
                        } else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) {
                            lastMessageText = '[图片]';
                        }else if ((lastMsg.parts && lastMsg.parts.some(p => p.type === 'html'))) {
                            lastMessageText = '[互动]';
                        } else {
                            const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                            // ...
let text = lastMsg.content.trim();
const plainTextMatch = text.match(/^\[.*?：([\s\S]*)\]$/);
if (plainTextMatch && plainTextMatch[1]) {
    text = plainTextMatch[1].trim();
}
text = text.replace(/\[发送时间:.*?\]$/, '').trim(); // 擦掉时间戳
const htmlRegex = /<[a-z][\s\S]*>/i;
if (htmlRegex.test(text)) {
    lastMessageText = '[互动]';
} else {
    lastMessageText = urlRegex.test(text) ? '[图片]' : text;
}
                        }
                    } else {
                        const lastEverMsg = chat.history[chat.history.length - 1];
                        const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
                        const renameRegex = /\[.*?修改群名为：.*?\]/;
                        const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                        const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);

                        if (timeSkipMatch) {
                            lastMessageText = timeSkipMatch[1];
                        } else if (inviteRegex.test(lastEverMsg.content)) {
                            lastMessageText = '新成员加入了群聊';
                        } else if (renameRegex.test(lastEverMsg.content)) {
                            lastMessageText = '群聊名称已修改';
                            } else {
                            lastMessageText = 'ta正在等你';
                        }
                        
                    }
                }
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                if (chat.isPinned) li.classList.add('pinned');
                li.dataset.id = chat.id;
                li.dataset.type = chat.type;
                const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
                const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
                const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';
let timeString = '';
const lastMessage = chat.history && chat.history.length > 0 ? chat.history[chat.history.length - 1] : null;
if (lastMessage) {
    const date = new Date(lastMessage.timestamp);
    const now = new Date();
    if (date.toDateString() === now.toDateString()) {
        timeString = `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    } else {
        timeString = `${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
    }
}

const unreadCount = chat.unreadCount || 0;
const unreadBadgeHTML = unreadCount > 0 
    ? `<span class="unread-badge visible">${unreadCount > 99 ? '99+' : unreadCount}</span>`
    : `<span class="unread-badge"></span>`;

li.innerHTML = `
<img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
<div class="item-details">
    <div class="item-details-row">
        <div class="item-name">${itemName}</div>
        <div class="item-meta">
            <span class="item-time">${timeString}</span>
        </div>
    </div>
    <div class="item-preview-wrapper">
        <div class="item-preview">${lastMessageText}</div>
        ${pinBadgeHTML}
    </div>
</div>
${unreadBadgeHTML}`; /* <-- 将红点元素移动到这里 */


                chatListContainer.appendChild(li);
            });
        }

        function setupAddCharModal() {
            addCharForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newChar = {
                    id: `char_${Date.now()}`,
                    realName: document.getElementById('char-real-name').value,
                    remarkName: document.getElementById('char-remark-name').value,
                    persona: '',
                    avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                    myName: document.getElementById('my-name-for-char').value,
                    myPersona: '',
                    myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                    theme: 'white_pink',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    status: '在线',
                    worldBookIds: [],
                    useCustomBubbleCss: false,
                    customBubbleCss: '',
                    unreadCount: 0,
                    memoryJournals: [],
                    journalWorldBookIds: [], // 新增
                    peekScreenSettings: { wallpaper: '', customIcons: {}, unlockAvatar: '' }, // 新增
 lastUserMessageTimestamp: null, // 新增：用于记录最后消息时间
               };
                db.characters.push(newChar);
                await saveData();
                renderChatList();
                addCharModal.classList.remove('visible');
                showToast(`角色“${newChar.remarkName}”创建成功！`);
                promptForBackupIfNeeded('new_char');
            });
        }

        function setupChatRoom() {
            const placeholderPlusBtn = document.getElementById('placeholder-plus-btn');
            const chatExpansionPanel = document.getElementById('chat-expansion-panel');

            placeholderPlusBtn.addEventListener('click', () => {
                // Hide sticker modal if open
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                }
                chatExpansionPanel.classList.toggle('visible');
            });

            sendMessageBtn.addEventListener('click', sendMessage);
            sendMessageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                sendMessage();
                setTimeout(() => {
                    messageInput.focus();
                }, 50);
            });
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isGenerating) sendMessage();
            });
            getReplyBtn.addEventListener('click', () => getAiReply(currentChatId, currentChatType));
            regenerateBtn.addEventListener('click', handleRegenerate);
            messageArea.addEventListener('click', (e) => {
                // --- Close any open panels when clicking message area ---
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                    return;
                }
                if (chatExpansionPanel.classList.contains('visible')) {
                    chatExpansionPanel.classList.remove('visible');
                    return;
                }
                // --- End close panels ---

                if (e.target && e.target.id === 'load-more-btn') {
                    loadMoreMessages();
                } else if (isInMultiSelectMode) {
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (messageWrapper) {
                        toggleMessageSelection(messageWrapper.dataset.id);
                    }
                } else {
                    const voiceBubble = e.target.closest('.voice-bubble');
                    if (voiceBubble) {
                        const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                        if (transcript) {
                            transcript.classList.toggle('active');
                        }
                    }
                    const pvCard = e.target.closest('.pv-card');
                    if (pvCard) {
                        const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                        const footer = pvCard.querySelector('.pv-card-footer');
                        imageOverlay.classList.toggle('hidden');
                        footer.classList.toggle('hidden');
                    }
                    const giftCard = e.target.closest('.gift-card');
                    if (giftCard) {
                        const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                        if (description) {
                            description.classList.toggle('active');
                        }
                    }
                    const transferCard = e.target.closest('.transfer-card.received-transfer');
                    if (transferCard && currentChatType === 'private') {
                        const messageWrapper = transferCard.closest('.message-wrapper');
                        const messageId = messageWrapper.dataset.id;
                        const character = db.characters.find(c => c.id === currentChatId);
                        const message = character.history.find(m => m.id === messageId);
                        if (message && message.transferStatus === 'pending') {
                            handleReceivedTransferClick(messageId);
                        }
                    }
                }
            });
            messageArea.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
            });
            messageArea.addEventListener('touchstart', (e) => {
                if (e.target.id === 'load-more-btn') return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
                }, 400);
            });
            messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
            messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            
            const messageEditForm = document.getElementById('message-edit-form');
            if(messageEditForm) {
                messageEditForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveMessageEdit();
                });
            }

            const cancelEditModalBtn = document.getElementById('cancel-edit-modal-btn');
            if(cancelEditModalBtn) {
                cancelEditModalBtn.addEventListener('click', cancelMessageEdit);
            }

            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);
            
            // 新增：绑定取消引用按钮事件
            document.getElementById('cancel-reply-btn').addEventListener('click', cancelQuoteReply);
        }

        function handleMessageLongPress(messageWrapper, x, y) {
            if (isInMultiSelectMode) return;
            clearTimeout(longPressTimer);
            const messageId = messageWrapper.dataset.id;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');
            const isVoiceMessage = /\[.*?的语音：.*?\]/.test(message.content);
            const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);
            const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);
            const isTransferMessage = /\[.*?给你转账：.*?\]|\[.*?的转账：.*?\]|\[.*?向.*?转账：.*?\]/.test(message.content);
            const isGiftMessage = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/.test(message.content);
            const isInvisibleMessage = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/.test(message.content);
            const isWithdrawn = message.isWithdrawn; // 新增：检查消息是否已撤回

            let menuItems = [];

            // 如果消息未被撤回，则显示正常菜单
            if (!isWithdrawn) {
                if (!isImageRecognitionMsg && !isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {
                    menuItems.push({label: '编辑', action: () => startMessageEdit(messageId)});
                }
                
                if (!isInvisibleMessage) {
                    menuItems.push({label: '引用', action: () => startQuoteReply(messageId)});
                }

                // 新增：只有自己发送的消息才能撤回
                if (message.role === 'user') {
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    
</script>
<div id="novelai-settings-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 600px; width: 90%;">
        <h3 style="text-align: center; color: var(--primary-color);">NovelAI 生成设置</h3>
        <span class="nai-modal-close-btn" id="close-novelai-settings">&times;</span>

        <div class="nai-modal-scrollable-content">
            <div class="form-group">
                <label>图像尺寸（oplus可无限出小图）</label>
                <select id="nai-resolution" class="form-group">
                    <optgroup label="小">
                        <option value="512x768">纵向 (512x768)</option>
                        <option value="768x512">横向 (768x512)</option>
                        <option value="640x640">正方形 (640x640)</option>
                    </optgroup>
                    <optgroup label="正常">
                        <option value="832x1216">竖图 (832x1216)</option>
                        <option value="1216x832">横图 (1216x832)</option>
                        <option value="1024x1024" selected>方图 (1024x1024)</option>
                    </optgroup>
                    <optgroup label="壁纸">
                        <option value="1088x1920">纵向 (1088x1920)</option>
                        <option value="1920x1088">风景 (1920x1088)</option>
                    </optgroup>
                </select>
                <small>建议使用官方支持的标准尺寸以获得最佳效果</small>
            </div>
            <div class="form-group">
                <label>采样步数 (Steps)</label>
                <input type="number" id="nai-steps" value="28" min="1" max="50" class="form-group">
                <small>推荐值: 28 (值越高质量越好但耗时越长)</small>
            </div>
            <div class="form-group">
                <label>提示词相关性 (CFG Scale)</label>
                <input type="number" id="nai-cfg-scale" value="5" min="1" max="20" step="0.5" class="form-group">
                <small>推荐值: 5 (控制图像与提示词的相关程度)</small>
            </div>
            <div class="form-group">
                <label>采样器 (Sampler)</label>
                <select id="nai-sampler" class="form-group">
                    <option value="k_euler">Euler</option>
                    <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                    <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                    <option value="k_dpmpp_2m">DPM++ 2M</option>
                    <option value="k_dpmpp_sde">DPM++ SDE</option>
                    <option value="ddim">DDIM</option>
                </select>
            </div>
            <div class="form-group">
                <label>随机种子 (Seed)</label>
                <input type="number" id="nai-seed" value="-1" min="-1" max="9999999999" class="form-group">
                <small>-1 表示随机，固定种子可复现相同图像</small>
            </div>
            <div class="form-group">
                <label>负面提示词预设 (UC Preset)</label>
                <select id="nai-uc-preset" class="form-group">
                    <option value="0">Preset 0 - Heavy</option>
                    <option value="1" selected>Preset 1 - Light</option>
                    <option value="2">Preset 2 - Human Focus</option>
                    <option value="3">Preset 3 - None</option>
                </select>
            </div>

            <div class="form-group nai-settings-checkbox-group">
                <label for="nai-quality-toggle">质量标签</label>
                <label class="checkbox-container">
                    <input type="checkbox" id="nai-quality-toggle" checked>
                    <span>自动添加质量提升标签</span>
                </label>
            </div>
            <div class="form-group nai-settings-checkbox-group">
                <label for="nai-smea">SMEA (提升细节)</label>
                <label class="checkbox-container">
                    <input type="checkbox" id="nai-smea" checked>
                    <span>启用SMEA增强</span>
                </label>
            </div>
            <div class="form-group nai-settings-checkbox-group">
                <label for="nai-smea-dyn">SMEA DYN (动态优化)</label>
                <label class="checkbox-container">
                    <input type="checkbox" id="nai-smea-dyn">
                    <span>启用动态SMEA</span>
                </label>
            </div>
            <div class="form-group">
                <label>默认正面提示词</label>
                <textarea id="nai-default-positive" rows="3" class="form-group" placeholder="masterpiece, best quality, 1girl, beautiful...">masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea>
                <small>此提示词将在生成时自动使用（如果测试弹窗中未填写）</small>
            </div>
            <div class="form-group">
                <label>默认负面提示词</label>
                <textarea id="nai-default-negative" rows="3" class="form-group" placeholder="lowres, bad anatomy, bad hands, text, error...">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
            </div>
            <div class="form-group" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                <label>🌐 CORS 代理设置</label>
                <select id="nai-cors-proxy" class="form-group">
                    <option value="">❌ 直连（无代理）</option>
                    <option value="https://corsproxy.io/?" selected>✅ corsproxy.io（推荐）</option>
                    <option value="https://api.allorigins.win/raw?url=">allorigins.win</option>
                    <option value="https://cors-anywhere.herokuapp.com/">cors-anywhere（需激活）</option>
                    <option value="custom">🔧 自定义代理</option>
                </select>
                <small style="color: #e74c3c;">⚠️ 本地运行会遇到CORS跨域问题，需使用代理。</small>
            </div>
            <div id="nai-custom-proxy-group" class="form-group" style="display: none;">
                <label>自定义代理地址</label>
                <input type="text" id="nai-custom-proxy-url" placeholder="https://your-proxy.com/?" class="form-group">
                <small>代理URL应以 / 或 ? 结尾，例如：https://proxy.com/?</small>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="reset-nai-settings-btn" class="btn btn-neutral" style="flex: 1;">恢复默认</button>
            <button id="save-nai-settings-btn" class="btn btn-primary" style="flex: 1;">保存设置</button>
        </div>
    </div>
</div>
<div id="novelai-test-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 700px; width: 90%;">
        <h3 style="text-align: center; color: var(--primary-color);">🖼️ NovelAI 测试生成</h3>
        <span class="nai-modal-close-btn" id="close-novelai-test">&times;</span>

        <div class="nai-modal-scrollable-content">
            <div class="form-group">
                <label>正面提示词（此处提示词仅用于该弹窗测试）</label>
                <textarea id="nai-test-prompt" rows="4" class="form-group" placeholder="1girl, solo, long hair, blue eyes, smile...">1girl, solo, long hair, blue eyes, smile, outdoors, cherry blossoms, spring</textarea>
            </div>
            <div class="form-group">
                <label>负面提示词（可选，留空使用默认）</label>
                <textarea id="nai-test-negative" rows="3" class="form-group" placeholder="留空将使用设置中的默认负面提示词"></textarea>
            </div>
            <div style="display: flex; justify-content: center; margin: 10px 0; align-items: center;">
                <button id="nai-generate-btn" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px; width: auto; margin: 0;">
                    生成图像
                </button>
            </div>
            <div id="nai-test-status" style="text-align: center; color: #666; margin: 15px 0; display: none;">
                正在生成中，请稍候...
            </div>
            <div id="nai-test-result" style="display: none; margin-top: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333;">生成结果：</div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <img id="nai-result-image">
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button id="nai-download-btn" class="btn btn-secondary" style="width: auto;">下载图像</button>
                </div>
            </div>
            <div id="nai-test-error" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; color: #721c24; border-radius: 6px; border: 1px solid #f5c6cb;"></div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="close-nai-test-btn" class="btn btn-neutral" style="flex: 1;">关闭</button>
        </div>
    </div>
</div>
<div id="character-nai-prompts-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 style="text-align: center; color: var(--primary-color);">角色专属NAI提示词配置</h3>
        <span class="nai-modal-close-btn" id="close-character-nai-prompts">&times;</span>

        <div class="nai-modal-content">
            <p style="font-size: 13px; color: #666; margin-bottom: 20px; background-color: #f0f8ff; padding: 12px; border-radius: 6px; border-left: 3px solid var(--accent-color);">
                💡 这里配置的提示词仅用于当前角色的NAI出图。
            </p>
            <div class="form-group">
                <label for="character-nai-positive" style="font-weight: 600;">
                    正面提示词 (Positive Prompt)
                </label>
                <textarea id="character-nai-positive" rows="4" class="form-group" placeholder="例如: masterpiece, best quality, 1girl, beautiful..."></textarea>
                <small>描述你希望生成的图像风格，可填入画师串</small>
            </div>
            <div class="form-group">
                <label for="character-nai-negative" style="font-weight: 600;">
                    负面提示词 (Negative Prompt)
                </label>
                <textarea id="character-nai-negative" rows="4" class="form-group" placeholder="例如: lowres, bad anatomy, bad hands..."></textarea>
                <small>描述你希望避免的元素</small>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="reset-character-nai-prompts-btn" class="btn btn-neutral" style="flex: 1;">清空配置</button>
            <button id="save-character-nai-prompts-btn" class="btn btn-primary" style="flex: 1;">保存</button>
        </div>
    </div>
</div>

<!-- 分类管理弹窗 -->
<div id="sticker-category-manager-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 360px;">
        <h3 style="text-align: center; color: var(--text-color); margin-bottom: 25px;">管理表情分类</h3>
        <form id="add-category-form" class="form-group">
            <label for="new-category-name-input" style="color: var(--secondary-color); font-weight: 600;">新建分类</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="new-category-name-input" class="form-group" placeholder="输入分类名..." style="flex-grow: 1; margin-bottom: 0;">
                <button type="submit" id="add-new-category-btn" class="btn btn-primary" style="width: auto; padding: 10px 18px; margin-bottom: 0; flex-shrink: 0;">添加</button>
            </div>
        </form>
        <div id="existing-categories-list">
            </div>
        <button id="close-category-manager-btn" class="btn btn-primary" style="margin-top: 25px;">完成</button>
    </div>
</div>
    <script src="script.js" defer></script>
</body>

</html>
